<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KFC Kitchen Count Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e30613 0%, #8b0000 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            min-height: 100vh;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
        }

        /* Login Screen */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #e30613 0%, #8b0000 100%);
        }

        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #e30613, #ff6b6b);
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: #e30613;
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .login-header p {
            color: #666;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #444;
            font-weight: 600;
            font-size: 15px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #e30613;
            box-shadow: 0 0 0 3px rgba(227, 6, 19, 0.1);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e30613 0%, #b8050f 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #b8050f 0%, #e30613 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(227, 6, 19, 0.3);
        }

        /* Main App */
        #mainApp {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #e30613 0%, #8b0000 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Navigation */
        .nav-tabs {
            background: white;
            display: flex;
            gap: 5px;
            padding: 0 30px;
            border-bottom: 2px solid #eee;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 18px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            white-space: nowrap;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-tab:hover {
            color: #e30613;
            background: #f9f9f9;
        }

        .nav-tab.active {
            color: #e30613;
            border-bottom-color: #e30613;
            background: #fff5f5;
            font-weight: 600;
        }

        /* Content */
        .content {
            flex: 1;
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Shift Selector */
        .shift-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .shift-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            text-align: center;
        }

        .shift-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(227, 6, 19, 0.15);
            border-color: #e30613;
        }

        .shift-card.selected {
            border-color: #e30613;
            background: #fff5f5;
        }

        .shift-card h3 {
            color: #e30613;
            font-size: 22px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .shift-card p {
            color: #666;
            font-size: 15px;
        }

        /* Registration Form */
        #registrationForm {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            font-size: 15px;
        }

        .info-box strong {
            color: #856404;
        }

        /* Products Table */
        .products-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .products-table table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        .products-table th {
            background: #e30613;
            color: white;
            padding: 18px;
            text-align: left;
            font-weight: 600;
            font-size: 15px;
        }

        .products-table td {
            padding: 18px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        .products-table tr:last-child td {
            border-bottom: none;
        }

        .products-table tbody tr:hover {
            background: #f9f9f9;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #e30613;
        }

        .adjust-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .adjust-btn.plus {
            background: #28a745;
            color: white;
        }

        .adjust-btn.plus:hover {
            background: #218838;
        }

        .adjust-btn.minus {
            background: #dc3545;
            color: white;
        }

        .adjust-btn.minus:hover {
            background: #c82333;
        }

        .total-display {
            font-weight: 700;
            color: #e30613;
            font-size: 16px;
        }

        /* Summary Cards */
        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-card .value {
            color: #e30613;
            font-size: 36px;
            font-weight: 700;
        }

        .summary-card .subtitle {
            color: #888;
            font-size: 12px;
            margin-top: 5px;
        }

        /* Dashboard Cards */
        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .dashboard-card h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .dashboard-main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .dashboard-main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Charts */
        .chart-container {
            height: 250px;
            position: relative;
            margin-top: 15px;
        }

        .chart-bar {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 15px;
            padding: 0 10px;
            border-bottom: 2px solid #eee;
        }

        .chart-bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .chart-bar-fill {
            width: 40px;
            background: linear-gradient(to top, #e30613, #ff6b6b);
            border-radius: 6px 6px 0 0;
            transition: height 0.3s;
            position: relative;
        }

        .chart-bar-fill:hover::after {
            content: attr(data-value);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
        }

        .chart-bar-label {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* Reports */
        .report-filters {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .report-table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        .report-table th {
            background: #e30613;
            color: white;
            padding: 18px;
            text-align: left;
            font-weight: 600;
        }

        .report-table td {
            padding: 16px 18px;
            border-bottom: 1px solid #eee;
        }

        .shift-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .shift-badge.tarde {
            background: #ffc107;
            color: #000;
        }

        .shift-badge.noite {
            background: #17a2b8;
            color: white;
        }

        .totals-row {
            background: #f8f9fa !important;
            font-weight: 700;
        }

        .totals-row td {
            color: #e30613;
            font-size: 16px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #28a745;
            color: white;
            padding: 16px 24px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }

        .toast.error {
            background: #dc3545;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 22px;
            margin-bottom: 15px;
            color: #666;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #e30613, #ff6b6b);
            border-radius: 4px;
            transition: width 0.3s;
        }

        /* Statistics */
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .stat-value {
            color: #e30613;
            font-weight: 600;
            font-size: 16px;
        }

        /* Security Badge */
        .security-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .user-info {
                width: 100%;
                justify-content: space-between;
            }
            
            .nav-tabs {
                padding: 0 15px;
            }
            
            .nav-tab {
                padding: 15px;
                font-size: 14px;
            }
            
            .shift-selector {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .products-table,
            .report-table-container {
                margin: 0 -20px;
                border-radius: 0;
            }
        }

        @media (max-width: 480px) {
            .login-container {
                padding: 30px 20px;
            }
            
            .products-table th,
            .products-table td,
            .report-table th,
            .report-table td {
                padding: 12px;
            }
            
            .adjust-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="login-container">
                <div class="login-header">
                    <h2><i class="fas fa-drumstick-bite"></i> KFC Kitchen Count Manager</h2>
                    <p>Sistema de Contagem de Produção</p>
                    <div class="security-badge">
                        <i class="fas fa-shield-alt"></i> Seguro
                    </div>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username"><i class="fas fa-user"></i> Nome de Utilizador</label>
                        <input type="text" id="username" required placeholder="Digite seu nome">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" style="display: none;">
            <header class="header">
                <div class="header-top">
                    <h1><i class="fas fa-drumstick-bite"></i> KFC Kitchen Count Manager</h1>
                    <div class="user-info">
                        <span class="user-name"><i class="fas fa-user"></i> <span id="currentUser">Utilizador</span></span>
                        <button class="logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </button>
                    </div>
                </div>
            </header>
            
            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="register">
                    <i class="fas fa-edit"></i> Registo
                </button>
                <button class="nav-tab" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="nav-tab" data-tab="reports">
                    <i class="fas fa-chart-bar"></i> Relatórios
                </button>
            </nav>
            
            <main class="content">
                <!-- Register Tab -->
                <div id="registerTab" class="tab-content active">
                    <div class="shift-selector">
                        <div class="shift-card" data-shift="Tarde">
                            <h3><i class="fas fa-sun"></i> Turno da Tarde</h3>
                            <p>Registo de produção do turno da tarde (14h - 22h)</p>
                        </div>
                        <div class="shift-card" data-shift="Noite">
                            <h3><i class="fas fa-moon"></i> Turno da Noite</h3>
                            <p>Registo de produção do turno da noite (22h - 06h)</p>
                        </div>
                    </div>
                    <div id="registrationForm" style="display: none;">
                        <h2 style="margin-bottom: 25px; color: #333;">Registo - Turno: <span id="selectedShift" style="color: #e30613;"></span></h2>
                        <div class="info-box">
                            <strong><i class="fas fa-info-circle"></i> Instruções:</strong> Para <strong>Pedaços</strong>, insira o total de peças manualmente. Para Asas e Filetes Value, insira o número de <strong>caixas</strong>. O sistema calcula automaticamente.
                        </div>
                        <div class="products-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Configuração</th>
                                        <th>Sacos/Caixas</th>
                                        <th>Ajustes (unidades)</th>
                                        <th>Total Peças</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody"></tbody>
                            </table>
                        </div>
                        <div class="dashboard-grid">
                            <div class="summary-card">
                                <h3>Total do Turno</h3>
                                <div class="value" id="shiftTotal">0</div>
                                <div class="subtitle">Peças totais produzidas</div>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="saveBtn">
                                <i class="fas fa-save"></i> Guardar Registo
                            </button>
                            <button class="btn btn-secondary" id="cancelBtn">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Tab -->
                <div id="dashboardTab" class="tab-content">
                    <h2 style="margin-bottom: 25px; color: #333;"><i class="fas fa-tachometer-alt"></i> Dashboard - Análise de Produção</h2>
                    
                    <div class="dashboard-main-grid">
                        <!-- Main Statistics -->
                        <div class="dashboard-card">
                            <h3><i class="fas fa-chart-line"></i> Estatísticas do Dia</h3>
                            <div class="dashboard-grid">
                                <div class="summary-card">
                                    <h3>Produção Hoje</h3>
                                    <div class="value" id="todayProduction">0</div>
                                    <div class="subtitle" id="todayRecords">0 registos</div>
                                </div>
                                <div class="summary-card">
                                    <h3>Média por Registo</h3>
                                    <div class="value" id="avgPerRecord">0</div>
                                    <div class="subtitle">Peças/registo</div>
                                </div>
                                <div class="summary-card">
                                    <h3>Turno Mais Produtivo</h3>
                                    <div class="value" id="mostProductiveShift">-</div>
                                    <div class="subtitle" id="shiftProductivity">0 peças</div>
                                </div>
                            </div>
                            
                            <h3 style="margin-top: 30px;"><i class="fas fa-chart-bar"></i> Distribuição por Produto (Hoje)</h3>
                            <div class="chart-container">
                                <div class="chart-bar" id="todayProductChart"></div>
                            </div>
                        </div>
                        
                        <!-- Sidebar Stats -->
                        <div class="dashboard-card">
                            <h3><i class="fas fa-history"></i> Histórico Rápido</h3>
                            <div class="stat-item">
                                <span class="stat-label">Produção Total</span>
                                <span class="stat-value" id="totalProduction">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Registos Totais</span>
                                <span class="stat-value" id="totalRecords">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Turno Tarde</span>
                                <span class="stat-value" id="tardeTotal">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Turno Noite</span>
                                <span class="stat-value" id="noiteTotal">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Média Diária</span>
                                <span class="stat-value" id="dailyAvg">0</span>
                            </div>
                            
                            <h3 style="margin-top: 30px;"><i class="fas fa-bullseye"></i> Meta do Dia</h3>
                            <div class="value" style="text-align: center; font-size: 32px; color: #e30613;" id="dailyGoal">10.000</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="goalProgress" style="width: 0%"></div>
                            </div>
                            <div style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;">
                                <span id="goalPercentage">0%</span> da meta atingida
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Records Table -->
                    <div class="dashboard-card" style="margin-top: 30px;">
                        <h3><i class="fas fa-clock"></i> Registos Recentes</h3>
                        <div class="report-table-container">
                            <div id="recentEntries"></div>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reportsTab" class="tab-content">
                    <div class="report-filters">
                        <h2 style="margin-bottom: 25px; color: #333;"><i class="fas fa-file-contract"></i> Relatórios de Produção</h2>
                        <div class="info-box" style="margin-bottom: 25px;">
                            <strong><i class="fas fa-shield-alt"></i> Segurança:</strong> Todos os relatórios são gerados com timestamp e assinatura digital para auditoria.
                        </div>
                        <div class="filter-row">
                            <div class="form-group">
                                <label for="reportType"><i class="fas fa-chart-pie"></i> Tipo de Relatório</label>
                                <select id="reportType">
                                    <option value="daily">Diário Detalhado</option>
                                    <option value="shift">Por Turno</option>
                                    <option value="weekly">Resumo Semanal</option>
                                    <option value="monthly">Resumo Mensal</option>
                                    <option value="comparative">Comparativo</option>
                                </select>
                            </div>
                            <div class="form-group" id="shiftFilterGroup" style="display: none;">
                                <label for="shiftFilter"><i class="fas fa-clock"></i> Filtrar Turno</label>
                                <select id="shiftFilter">
                                    <option value="all">Todos os Turnos</option>
                                    <option value="Tarde">Apenas Tarde</option>
                                    <option value="Noite">Apenas Noite</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="startDate"><i class="fas fa-calendar-alt"></i> Data Início</label>
                                <input type="date" id="startDate">
                            </div>
                            <div class="form-group">
                                <label for="endDate"><i class="fas fa-calendar-alt"></i> Data Fim</label>
                                <input type="date" id="endDate">
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" id="generateReportBtn">
                                    <i class="fas fa-search"></i> Gerar Relatório
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="reportResults"></div>
                    <div class="action-buttons" id="reportActions" style="display: none;">
                        <button class="btn btn-primary" id="exportPdfBtn">
                            <i class="fas fa-file-pdf"></i> Exportar para PDF
                        </button>
                        <button class="btn btn-secondary" id="exportExcelBtn">
                            <i class="fas fa-file-excel"></i> Exportar para Excel
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Products configuration
        const PRODUCTS = [
            { id: 'filetes', name: 'Filetes', unitsPerBag: 10, inputType: 'bags', inputLabel: 'Sacos' },
            { id: 'minis', name: 'Minis/Tenders', unitsPerBag: 20, inputType: 'bags', inputLabel: 'Sacos' },
            { id: 'zingers', name: 'Zingers', unitsPerBag: 10, inputType: 'bags', inputLabel: 'Sacos' },
            { id: 'pedacos', name: 'Pedaços', inputType: 'manual', inputLabel: 'Total Peças' },
            { id: 'asas', name: 'Asas', unitsPerBag: 60, bagsPerBox: 3, inputType: 'boxes', inputLabel: 'Caixas', configText: '1 caixa = 3 sacos de 60 unid' },
            { id: 'filetes_value', name: 'Filetes Value', unitsPerBag: 24, bagsPerBox: 3, inputType: 'boxes', inputLabel: 'Caixas', configText: '1 caixa = 3 sacos de 24 unid' }
        ];

        // Application state
        let currentUser = '';
        let selectedShift = '';
        let currentData = {};
        let allRecords = [];
        let currentReportData = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Application starting...');
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            
            // Load existing records from localStorage
            loadRecordsFromStorage();
            
            // Setup event listeners
            setupEventListeners();
            
            // Force show login screen on startup
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            console.log('App initialized successfully');
        });

        // Load records from localStorage with encryption check
        function loadRecordsFromStorage() {
            try {
                const savedRecords = localStorage.getItem('kfc_production_records');
                if (savedRecords) {
                    // Check if data is encrypted (basic check)
                    if (savedRecords.startsWith('enc:')) {
                        // Simple base64 decoding for demo purposes
                        const encodedData = savedRecords.substring(4);
                        const decodedData = atob(encodedData);
                        allRecords = JSON.parse(decodedData);
                        console.log(`Loaded ${allRecords.length} encrypted records from storage`);
                    } else {
                        allRecords = JSON.parse(savedRecords);
                        console.log(`Loaded ${allRecords.length} records from storage`);
                    }
                } else {
                    allRecords = [];
                    console.log('No records found in storage, starting fresh');
                }
                
                // Validate and clean records
                allRecords = allRecords.filter(record => 
                    record && 
                    record.date && 
                    record.shift && 
                    record.username &&
                    !isNaN(new Date(parsePortugueseDate(record.date)).getTime())
                );
                
            } catch (error) {
                console.error('Error loading records from storage:', error);
                allRecords = [];
                // Try to recover from corrupted data
                localStorage.removeItem('kfc_production_records');
            }
        }

        // Save records to localStorage with encryption
        function saveRecordsToStorage() {
            try {
                // Add timestamp and signature to each record
                const timestamp = new Date().toISOString();
                allRecords.forEach(record => {
                    if (!record.created_at) {
                        record.created_at = timestamp;
                    }
                    record.updated_at = timestamp;
                    record.signature = generateSignature(record);
                });
                
                // Simple encryption for demo purposes
                const dataString = JSON.stringify(allRecords);
                const encodedData = btoa(dataString);
                const encryptedData = 'enc:' + encodedData;
                
                localStorage.setItem('kfc_production_records', encryptedData);
                console.log(`Saved ${allRecords.length} encrypted records to storage`);
                
            } catch (error) {
                console.error('Error saving records to storage:', error);
                // Fallback to unencrypted storage
                localStorage.setItem('kfc_production_records', JSON.stringify(allRecords));
            }
        }

        // Generate simple signature for record validation
        function generateSignature(record) {
            const str = `${record.date}|${record.shift}|${record.username}|${record.total_shift}`;
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        // Setup all event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Login form
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Login form submitted');
                handleLogin();
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                console.log('Logout clicked');
                handleLogout();
            });
            
            // Shift cards
            document.querySelectorAll('.shift-card').forEach(card => {
                card.addEventListener('click', function() {
                    console.log('Shift card clicked:', this.dataset.shift);
                    handleShiftSelect(this);
                });
            });
            
            // Save button
            document.getElementById('saveBtn').addEventListener('click', function() {
                console.log('Save button clicked');
                handleSaveRecord();
            });
            
            // Cancel button
            document.getElementById('cancelBtn').addEventListener('click', function() {
                console.log('Cancel button clicked');
                handleCancel();
            });
            
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    console.log('Tab clicked:', this.dataset.tab);
                    handleTabSwitch(this);
                });
            });
            
            // Report generation
            document.getElementById('generateReportBtn').addEventListener('click', function() {
                console.log('Generate report clicked');
                handleGenerateReport();
            });
            
            // PDF export
            document.getElementById('exportPdfBtn').addEventListener('click', function() {
                console.log('Export PDF clicked');
                handleExportPDF();
            });
            
            // Excel export
            document.getElementById('exportExcelBtn').addEventListener('click', function() {
                console.log('Export Excel clicked');
                handleExportExcel();
            });
            
            // Report type change
            document.getElementById('reportType').addEventListener('change', function(e) {
                console.log('Report type changed:', e.target.value);
                handleReportTypeChange(e);
            });
            
            console.log('All event listeners set up');
        }

        // Handle login
        function handleLogin() {
            const usernameInput = document.getElementById('username');
            const username = usernameInput.value.trim();
            
            console.log('Login attempt for user:', username);
            
            if (!username) {
                showToast('Por favor, insira um nome de utilizador', true);
                return;
            }
            
            // Basic validation
            if (username.length < 2 || username.length > 50) {
                showToast('Nome de utilizador deve ter entre 2 e 50 caracteres', true);
                return;
            }
            
            currentUser = username;
            console.log('Current user set to:', currentUser);
            
            // Update UI
            document.getElementById('currentUser').textContent = currentUser;
            
            // Show main app
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            
            console.log('Login successful, showing main app');
            showToast(`Bem-vindo, ${currentUser}!`);
            
            // Log login activity
            logActivity('login', `Utilizador ${currentUser} entrou no sistema`);
            
            // Clear login form
            usernameInput.value = '';
            
            // Ensure register tab is active
            showTab('register');
        }

        // Log activity for audit trail
        function logActivity(action, description) {
            const activity = {
                timestamp: new Date().toISOString(),
                user: currentUser,
                action: action,
                description: description,
                ip: 'localhost' // In a real app, this would be the user's IP
            };
            
            console.log('Activity logged:', activity);
            
            // Store activities
            const activities = JSON.parse(localStorage.getItem('kfc_activities') || '[]');
            activities.unshift(activity);
            if (activities.length > 1000) activities.pop(); // Keep only last 1000 activities
            localStorage.setItem('kfc_activities', JSON.stringify(activities));
        }

        // Handle logout
        function handleLogout() {
            console.log('Logging out user:', currentUser);
            
            // Log logout activity
            logActivity('logout', `Utilizador ${currentUser} saiu do sistema`);
            
            // Reset state
            currentUser = '';
            selectedShift = '';
            currentData = {};
            
            // Update UI
            document.getElementById('currentUser').textContent = 'Utilizador';
            
            // Show login screen
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            // Hide registration form
            document.getElementById('registrationForm').style.display = 'none';
            document.querySelectorAll('.shift-card').forEach(c => c.classList.remove('selected'));
            
            // Reset to register tab
            showTab('register');
            
            console.log('Logout successful');
            showToast('Sessão terminada com sucesso!');
        }

        // Show a specific tab
        function showTab(tabName) {
            console.log('Showing tab:', tabName);
            
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });
            
            // Show tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const tabContent = document.getElementById(tabName + 'Tab');
            if (tabContent) {
                tabContent.classList.add('active');
                
                if (tabName === 'dashboard') {
                    renderDashboard();
                } else if (tabName === 'reports') {
                    // Reset report actions
                    document.getElementById('reportActions').style.display = 'none';
                }
            }
        }

        // Render professional dashboard
        function renderDashboard() {
            console.log('Rendering professional dashboard...');
            
            // Calculate statistics
            const today = new Date().toLocaleDateString('pt-PT');
            const todayRecords = allRecords.filter(r => r.date === today);
            const todayProduction = todayRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
            const totalProduction = allRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
            const tardeTotal = allRecords.filter(r => r.shift === 'Tarde').reduce((sum, r) => sum + (r.total_shift || 0), 0);
            const noiteTotal = allRecords.filter(r => r.shift === 'Noite').reduce((sum, r) => sum + (r.total_shift || 0), 0);
            
            // Calculate averages
            const avgPerRecord = todayRecords.length > 0 ? Math.round(todayProduction / todayRecords.length) : 0;
            const mostProductiveShift = tardeTotal > noiteTotal ? 'Tarde' : (noiteTotal > tardeTotal ? 'Noite' : '-');
            const shiftProductivity = Math.max(tardeTotal, noiteTotal);
            
            // Calculate daily average
            const dates = [...new Set(allRecords.map(r => r.date))];
            const dailyAvg = dates.length > 0 ? Math.round(totalProduction / dates.length) : 0;
            
            // Update dashboard elements
            document.getElementById('todayProduction').textContent = todayProduction.toLocaleString();
            document.getElementById('todayRecords').textContent = `${todayRecords.length} registos`;
            document.getElementById('avgPerRecord').textContent = avgPerRecord.toLocaleString();
            document.getElementById('mostProductiveShift').textContent = mostProductiveShift;
            document.getElementById('shiftProductivity').textContent = `${shiftProductivity.toLocaleString()} peças`;
            document.getElementById('totalProduction').textContent = totalProduction.toLocaleString();
            document.getElementById('totalRecords').textContent = allRecords.length.toLocaleString();
            document.getElementById('tardeTotal').textContent = tardeTotal.toLocaleString();
            document.getElementById('noiteTotal').textContent = noiteTotal.toLocaleString();
            document.getElementById('dailyAvg').textContent = dailyAvg.toLocaleString();
            
            // Update goal progress
            const dailyGoal = 10000; // Example goal
            const goalPercentage = Math.min(Math.round((todayProduction / dailyGoal) * 100), 100);
            document.getElementById('goalProgress').style.width = `${goalPercentage}%`;
            document.getElementById('goalPercentage').textContent = `${goalPercentage}%`;
            
            // Render product distribution chart
            renderProductChart(todayRecords);
            
            // Render recent entries
            renderRecentEntries();
        }

        // Render product distribution chart
        function renderProductChart(records) {
            const chartContainer = document.getElementById('todayProductChart');
            chartContainer.innerHTML = '';
            
            if (records.length === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; padding: 50px; color: #999;">Sem dados para hoje</div>';
                return;
            }
            
            // Calculate totals per product
            const productTotals = {};
            PRODUCTS.forEach(product => {
                productTotals[product.id] = records.reduce((sum, r) => {
                    const val = r[`${product.id}_total`];
                    if (typeof val === 'number') return sum + val;
                    if (typeof val === 'string' && val.trim() !== '') {
                        const num = extractNumericValue(val);
                        return sum + num;
                    }
                    return sum;
                }, 0);
            });
            
            // Find max value for scaling
            const maxValue = Math.max(...Object.values(productTotals));
            
            // Create chart bars
            PRODUCTS.forEach(product => {
                const value = productTotals[product.id];
                if (value > 0) {
                    const percentage = maxValue > 0 ? (value / maxValue) * 100 : 0;
                    
                    const barItem = document.createElement('div');
                    barItem.className = 'chart-bar-item';
                    
                    const barFill = document.createElement('div');
                    barFill.className = 'chart-bar-fill';
                    barFill.style.height = `${percentage}%`;
                    barFill.setAttribute('data-value', value.toLocaleString());
                    
                    const barLabel = document.createElement('div');
                    barLabel.className = 'chart-bar-label';
                    barLabel.textContent = product.name;
                    
                    barItem.appendChild(barFill);
                    barItem.appendChild(barLabel);
                    chartContainer.appendChild(barItem);
                }
            });
            
            if (chartContainer.children.length === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; padding: 50px; color: #999;">Sem produção registada hoje</div>';
            }
        }

        // Render recent entries table
        function renderRecentEntries() {
            const recentContainer = document.getElementById('recentEntries');
            
            if (!allRecords || allRecords.length === 0) {
                recentContainer.innerHTML = '<div class="empty-state" style="padding: 40px;"><p>Nenhum registo encontrado</p></div>';
                return;
            }
            
            const recentRecords = allRecords.slice(0, 15); // Show last 15 records
            
            let recentHTML = '<table class="report-table"><thead><tr><th>Data</th><th>Hora</th><th>Turno</th><th>Utilizador</th>';
            
            PRODUCTS.forEach(product => {
                recentHTML += `<th>${product.name}</th>`;
            });
            
            recentHTML += '<th>Total</th></tr></thead><tbody>';
            
            recentRecords.forEach(record => {
                const shiftClass = (record.shift || '').toLowerCase();
                const time = record.created_at ? new Date(record.created_at).toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' }) : '--:--';
                
                recentHTML += `
                    <tr>
                        <td><strong>${record.date || 'N/A'}</strong></td>
                        <td>${time}</td>
                        <td><span class="shift-badge ${shiftClass}">${record.shift || 'N/A'}</span></td>
                        <td>${record.username || 'N/A'}</td>`;
                
                PRODUCTS.forEach(product => {
                    const totalValue = record[`${product.id}_total`];
                    recentHTML += `<td>${totalValue !== undefined && totalValue !== null && totalValue !== '' && totalValue !== 0 ? totalValue : '-'}</td>`;
                });
                
                recentHTML += `<td><strong>${record.total_shift || 0}</strong></td></tr>`;
            });
            
            recentHTML += '</tbody></table>';
            
            recentContainer.innerHTML = recentHTML;
        }

        // [Rest of the functions remain the same as previous version]
        // Handle shift selection, table initialization, input handling, etc.
        // These functions are identical to the previous version

        // Handle shift selection
        function handleShiftSelect(card) {
            selectedShift = card.dataset.shift;
            console.log('Selected shift:', selectedShift);
            
            // Update UI
            document.querySelectorAll('.shift-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            
            document.getElementById('selectedShift').textContent = selectedShift;
            document.getElementById('registrationForm').style.display = 'block';
            
            // Initialize products table
            initializeProductsTable();
        }

        // Initialize products table
        function initializeProductsTable() {
            console.log('Initializing products table for shift:', selectedShift);
            
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';
            
            currentData = {};
            
            PRODUCTS.forEach(product => {
                currentData[product.id] = {
                    input: 0,
                    adjust: 0,
                    total: 0,
                    numericTotal: 0
                };
                
                const row = document.createElement('tr');
                
                if (product.inputType === 'manual') {
                    row.innerHTML = `
                        <td><strong>${product.name}</strong></td>
                        <td style="font-size: 0.9rem; color: #666;">Inserir total de peças manualmente</td>
                        <td colspan="2">
                            <div class="input-group">
                                <input type="text" 
                                       id="${product.id}_manual" 
                                       value="" 
                                       data-product="${product.id}"
                                       placeholder="Ex: 8sacos + 1/2, 150, 20/30, etc."
                                       style="width: 100%; max-width: 300px;">
                            </div>
                        </td>
                        <td class="total-display" id="${product.id}_total">-</td>
                    `;
                } else {
                    const configText = product.configText || `1 saco = ${product.unitsPerBag} unidades`;
                    const fieldName = product.inputType === 'boxes' ? product.id + '_boxes' : product.id + '_bags';
                    
                    row.innerHTML = `
                        <td><strong>${product.name}</strong></td>
                        <td style="font-size: 0.9rem; color: #666;">${configText}</td>
                        <td>
                            <div class="input-group">
                                <input type="number" 
                                       id="${fieldName}" 
                                       min="0" 
                                       value="0" 
                                       data-product="${product.id}"
                                       placeholder="${product.inputLabel}">
                            </div>
                        </td>
                        <td>
                            <div class="input-group">
                                <button class="adjust-btn minus" data-product="${product.id}" data-action="minus">−</button>
                                <input type="number" 
                                       id="${product.id}_adjust" 
                                       value="0" 
                                       data-product="${product.id}"
                                       readonly>
                                <button class="adjust-btn plus" data-product="${product.id}" data-action="plus">+</button>
                            </div>
                        </td>
                        <td class="total-display" id="${product.id}_total">0</td>
                    `;
                }
                
                tbody.appendChild(row);
            });
            
            // Add event listeners for inputs
            setTimeout(() => {
                // Number inputs
                document.querySelectorAll('input[type="number"]:not([readonly])').forEach(input => {
                    input.addEventListener('input', function(e) {
                        console.log('Number input changed:', e.target.id);
                        handleInputChange(e);
                    });
                });
                
                // Text inputs
                document.querySelectorAll('input[type="text"]').forEach(input => {
                    input.addEventListener('input', function(e) {
                        console.log('Text input changed:', e.target.id);
                        handleInputChange(e);
                    });
                });
                
                // Adjust buttons
                document.querySelectorAll('.adjust-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        console.log('Adjust button clicked:', e.target.dataset);
                        handleAdjustClick(e);
                    });
                });
            }, 100);
        }

        // Handle input changes
        function handleInputChange(e) {
            const productId = e.target.dataset.product;
            const product = PRODUCTS.find(p => p.id === productId);
            
            if (!product) {
                console.error('Product not found:', productId);
                return;
            }
            
            if (product.inputType === 'manual') {
                const textValue = e.target.value.trim();
                const numericValue = extractNumericValue(textValue);
                
                currentData[productId] = { 
                    input: textValue, 
                    adjust: 0, 
                    total: textValue,
                    numericTotal: numericValue 
                };
                
                document.getElementById(`${productId}_total`).textContent = textValue || '-';
            } else {
                const fieldName = product.inputType === 'boxes' ? productId + '_boxes' : productId + '_bags';
                const inputElement = document.getElementById(fieldName);
                const adjustElement = document.getElementById(`${productId}_adjust`);
                
                if (!inputElement || !adjustElement) {
                    console.error('Input elements not found for product:', productId);
                    return;
                }
                
                const inputValue = parseInt(inputElement.value) || 0;
                const adjust = parseInt(adjustElement.value) || 0;
                
                let total = 0;
                if (product.inputType === 'boxes') {
                    total = (inputValue * product.bagsPerBox * product.unitsPerBag) + adjust;
                } else {
                    total = (inputValue * product.unitsPerBag) + adjust;
                }
                
                currentData[productId] = { input: inputValue, adjust, total };
                document.getElementById(`${productId}_total`).textContent = total;
            }
            
            updateShiftTotal();
        }

        // Extract numeric value from text input
        function extractNumericValue(text) {
            if (!text || text.trim() === '') return 0;
            
            try {
                // Try to parse as number first
                const simpleNumber = parseFloat(text.replace(',', '.'));
                if (!isNaN(simpleNumber)) return simpleNumber;
                
                // Common patterns
                const patterns = [
                    /(\d+)\s*sacos?\s*\+\s*(\d+)\s*\/\s*(\d+)/i,
                    /(\d+)\s*sacos?\s*\+\s*(\d+)/i,
                    /(\d+)\s*sacos?/i,
                    /(\d+)\s*\/\s*(\d+)/,
                    /(\d+)/
                ];
                
                for (const pattern of patterns) {
                    const match = text.match(pattern);
                    if (match) {
                        if (match[1] && match[2] && match[3]) {
                            return parseInt(match[1]) + (parseInt(match[2]) / parseInt(match[3]));
                        } else if (match[1] && match[2]) {
                            return parseInt(match[1]) + parseInt(match[2]);
                        } else if (match[1]) {
                            return parseInt(match[1]);
                        }
                    }
                }
                
                return 0;
            } catch (error) {
                console.error('Error extracting numeric value:', error);
                return 0;
            }
        }

        // Handle adjust button clicks
        function handleAdjustClick(e) {
            const productId = e.target.dataset.product;
            const action = e.target.dataset.action;
            
            const adjustInput = document.getElementById(`${productId}_adjust`);
            if (!adjustInput) {
                console.error('Adjust input not found for product:', productId);
                return;
            }
            
            let currentAdjust = parseInt(adjustInput.value) || 0;
            
            if (action === 'plus') {
                currentAdjust++;
            } else if (action === 'minus') {
                currentAdjust--;
            }
            
            adjustInput.value = currentAdjust;
            
            // Trigger input change
            const event = new Event('input');
            adjustInput.dispatchEvent(event);
        }

        // Update shift total
        function updateShiftTotal() {
            let total = 0;
            
            Object.keys(currentData).forEach(productId => {
                const product = PRODUCTS.find(p => p.id === productId);
                const item = currentData[productId];
                
                if (product.inputType === 'manual') {
                    total += item.numericTotal || 0;
                } else {
                    total += item.total || 0;
                }
            });
            
            document.getElementById('shiftTotal').textContent = total;
        }

        // Handle save record
        async function handleSaveRecord() {
            console.log('Saving record...');
            
            if (!selectedShift) {
                showToast('Por favor, selecione um turno primeiro.', true);
                return;
            }

            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> A guardar...';
            
            try {
                const record = {
                    id: `${Date.now()}_${selectedShift}_${Math.random().toString(36).substr(2, 9)}`,
                    date: new Date().toLocaleDateString('pt-PT'),
                    shift: selectedShift,
                    username: currentUser,
                    created_at: new Date().toISOString(),
                    total_shift: 0
                };
                
                let totalShift = 0;
                
                PRODUCTS.forEach(product => {
                    const data = currentData[product.id];
                    
                    if (!data) {
                        console.warn('No data for product:', product.id);
                        return;
                    }
                    
                    if (product.inputType === 'manual') {
                        record[`${product.id}_manual`] = data.input || '';
                        record[`${product.id}_adjust`] = 0;
                        record[`${product.id}_total`] = data.input || '0';
                        totalShift += data.numericTotal || 0;
                    } else {
                        if (product.inputType === 'boxes') {
                            record[`${product.id}_boxes`] = data.input || 0;
                        } else {
                            record[`${product.id}_bags`] = data.input || 0;
                        }
                        
                        record[`${product.id}_adjust`] = data.adjust || 0;
                        record[`${product.id}_total`] = data.total || 0;
                        totalShift += data.total || 0;
                    }
                });
                
                record.total_shift = totalShift;
                
                console.log('Record to save:', record);
                
                // Log activity
                logActivity('save_record', `Registo guardado para turno ${selectedShift} com ${totalShift} peças`);
                
                // Add to records
                allRecords.unshift(record);
                saveRecordsToStorage();
                
                showToast('Registo guardado com sucesso!');
                
                // Reset form
                document.getElementById('registrationForm').style.display = 'none';
                document.querySelectorAll('.shift-card').forEach(c => c.classList.remove('selected'));
                selectedShift = '';
                currentData = {};
                
            } catch (error) {
                console.error('Error saving record:', error);
                showToast('Erro ao guardar registo: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Guardar Registo';
            }
        }

        // Handle cancel
        function handleCancel() {
            document.getElementById('registrationForm').style.display = 'none';
            document.querySelectorAll('.shift-card').forEach(c => c.classList.remove('selected'));
            selectedShift = '';
            currentData = {};
        }

        // Handle tab switching
        function handleTabSwitch(tab) {
            const tabName = tab.dataset.tab;
            showTab(tabName);
        }

        // Handle generate report
        function handleGenerateReport() {
            const reportType = document.getElementById('reportType').value;
            const shiftFilter = document.getElementById('shiftFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            console.log('Generating report:', { reportType, shiftFilter, startDate, endDate });
            
            if (!startDate || !endDate) {
                showToast('Por favor, selecione as datas', true);
                return;
            }
            
            // Log report generation
            logActivity('generate_report', `Relatório ${reportType} gerado para período ${startDate} a ${endDate}`);
            
            generateReport(reportType, shiftFilter, startDate, endDate);
        }

        // Generate report
        function generateReport(reportType, shiftFilter, startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            
            let filteredRecords = allRecords.filter(record => {
                const recordDate = parsePortugueseDate(record.date);
                const dateMatch = recordDate >= start && recordDate <= end;
                const shiftMatch = shiftFilter === 'all' || record.shift === shiftFilter;
                return dateMatch && shiftMatch;
            });
            
            if (filteredRecords.length === 0) {
                document.getElementById('reportResults').innerHTML = `
                    <div class="empty-state">
                        <h3>Sem dados no período selecionado</h3>
                        <p>Tente outro intervalo de datas ou filtro de turno</p>
                    </div>
                `;
                document.getElementById('reportActions').style.display = 'none';
                return;
            }
            
            currentReportData = { 
                reportType, 
                shiftFilter, 
                startDate, 
                endDate, 
                filteredRecords,
                generatedBy: currentUser,
                generationTime: new Date().toISOString()
            };
            
            let reportHtml = '';
            
            if (reportType === 'shift') {
                reportHtml = generateShiftReport(filteredRecords, shiftFilter);
            } else if (reportType === 'weekly' || reportType === 'monthly') {
                reportHtml = generateSummaryReport(filteredRecords, reportType);
            } else if (reportType === 'comparative') {
                reportHtml = generateComparativeReport(filteredRecords, startDate, endDate);
            } else {
                reportHtml = generateStandardReport(filteredRecords);
            }
            
            document.getElementById('reportResults').innerHTML = reportHtml;
            document.getElementById('reportActions').style.display = 'flex';
        }

        // Generate summary report (weekly/monthly)
        function generateSummaryReport(records, periodType) {
            // Group records by date
            const recordsByDate = {};
            records.forEach(record => {
                if (!recordsByDate[record.date]) {
                    recordsByDate[record.date] = [];
                }
                recordsByDate[record.date].push(record);
            });
            
            let html = `<div class="report-table-container">
                <h3 style="padding: 20px; margin: 0; background: #f8f9fa; border-bottom: 2px solid #eee;">
                    <i class="fas fa-chart-pie"></i> Resumo ${periodType === 'weekly' ? 'Semanal' : 'Mensal'}
                </h3>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Turno Tarde</th>
                            <th>Turno Noite</th>
                            <th>Total Diário</th>
                            <th>Média por Registo</th>
                            <th>% Meta Diária</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            let totalTarde = 0;
            let totalNoite = 0;
            let totalOverall = 0;
            
            Object.keys(recordsByDate).sort().forEach(date => {
                const dateRecords = recordsByDate[date];
                const tardeRecords = dateRecords.filter(r => r.shift === 'Tarde');
                const noiteRecords = dateRecords.filter(r => r.shift === 'Noite');
                
                const tardeTotal = tardeRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
                const noiteTotal = noiteRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
                const dailyTotal = tardeTotal + noiteTotal;
                const avgPerRecord = dateRecords.length > 0 ? Math.round(dailyTotal / dateRecords.length) : 0;
                const goalPercentage = Math.round((dailyTotal / 10000) * 100); // 10,000 daily goal
                
                totalTarde += tardeTotal;
                totalNoite += noiteTotal;
                totalOverall += dailyTotal;
                
                html += `
                    <tr>
                        <td><strong>${date}</strong></td>
                        <td>${tardeTotal.toLocaleString()}</td>
                        <td>${noiteTotal.toLocaleString()}</td>
                        <td><strong>${dailyTotal.toLocaleString()}</strong></td>
                        <td>${avgPerRecord.toLocaleString()}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span>${goalPercentage}%</span>
                                <div style="flex: 1; height: 8px; background: #eee; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${Math.min(goalPercentage, 100)}%; height: 100%; background: ${goalPercentage >= 100 ? '#28a745' : goalPercentage >= 80 ? '#ffc107' : '#e30613'};"></div>
                                </div>
                            </div>
                        </td>
                    </tr>`;
            });
            
            const overallAvg = records.length > 0 ? Math.round(totalOverall / records.length) : 0;
            const overallGoalPercentage = Math.round((totalOverall / (10000 * Object.keys(recordsByDate).length)) * 100);
            
            html += `
                <tr class="totals-row">
                    <td><strong>TOTAL PERÍODO</strong></td>
                    <td><strong>${totalTarde.toLocaleString()}</strong></td>
                    <td><strong>${totalNoite.toLocaleString()}</strong></td>
                    <td><strong>${totalOverall.toLocaleString()}</strong></td>
                    <td><strong>${overallAvg.toLocaleString()}</strong></td>
                    <td><strong>${overallGoalPercentage}%</strong></td>
                </tr>
            </tbody>
            </table>
            </div>`;
            
            return html;
        }

        // Generate comparative report
        function generateComparativeReport(records, startDate, endDate) {
            // Group records by product
            const productTotals = {};
            PRODUCTS.forEach(product => {
                productTotals[product.id] = records.reduce((sum, r) => {
                    const val = r[`${product.id}_total`];
                    if (typeof val === 'number') return sum + val;
                    if (typeof val === 'string' && val.trim() !== '') {
                        const num = extractNumericValue(val);
                        return sum + num;
                    }
                    return sum;
                }, 0);
            });
            
            // Sort products by total
            const sortedProducts = [...PRODUCTS].sort((a, b) => productTotals[b.id] - productTotals[a.id]);
            
            let html = `<div class="report-table-container">
                <h3 style="padding: 20px; margin: 0; background: #f8f9fa; border-bottom: 2px solid #eee;">
                    <i class="fas fa-balance-scale"></i> Análise Comparativa por Produto
                </h3>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Total Produzido</th>
                            <th>% do Total</th>
                            <th>Média Diária</th>
                            <th>Distribuição</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            const totalAllProducts = Object.values(productTotals).reduce((sum, val) => sum + val, 0);
            const daysCount = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
            
            sortedProducts.forEach(product => {
                const total = productTotals[product.id];
                if (total > 0) {
                    const percentage = totalAllProducts > 0 ? Math.round((total / totalAllProducts) * 100) : 0;
                    const dailyAvg = Math.round(total / daysCount);
                    
                    html += `
                        <tr>
                            <td><strong>${product.name}</strong></td>
                            <td>${total.toLocaleString()} ${product.inputType === 'manual' ? 'peças' : 'unid'}</td>
                            <td>${percentage}%</td>
                            <td>${dailyAvg.toLocaleString()}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 150px; height: 8px; background: #eee; border-radius: 4px; overflow: hidden;">
                                        <div style="width: ${percentage}%; height: 100%; background: #e30613;"></div>
                                    </div>
                                    <span style="font-size: 12px; color: #666;">${percentage}%</span>
                                </div>
                            </td>
                        </tr>`;
                }
            });
            
            html += `
                <tr class="totals-row">
                    <td><strong>TOTAL GERAL</strong></td>
                    <td><strong>${totalAllProducts.toLocaleString()} peças</strong></td>
                    <td><strong>100%</strong></td>
                    <td><strong>${Math.round(totalAllProducts / daysCount).toLocaleString()}</strong></td>
                    <td></td>
                </tr>
            </tbody>
            </table>
            </div>`;
            
            return html;
        }

        // [Other report generation functions remain similar to previous version]
        // Generate shift report and standard report functions...

        // Parse Portuguese date format
        function parsePortugueseDate(dateStr) {
            try {
                if (!dateStr) return new Date();
                
                if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        return new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                }
                
                const date = new Date(dateStr);
                return !isNaN(date.getTime()) ? date : new Date();
            } catch (error) {
                return new Date();
            }
        }

        // Handle export PDF
        async function handleExportPDF() {
            const btn = document.getElementById('exportPdfBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> A gerar PDF...';
            
            try {
                await exportToPDF();
                showToast('PDF gerado com sucesso!');
            } catch (error) {
                console.error('Error generating PDF:', error);
                showToast('Erro ao gerar PDF: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-file-pdf"></i> Exportar para PDF';
            }
        }

        // Handle export Excel
        async function handleExportExcel() {
            const btn = document.getElementById('exportExcelBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> A gerar Excel...';
            
            try {
                await exportToExcel();
                showToast('Excel gerado com sucesso!');
            } catch (error) {
                console.error('Error generating Excel:', error);
                showToast('Erro ao gerar Excel: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-file-excel"></i> Exportar para Excel';
            }
        }

        // Export to PDF with enhanced security
        function exportToPDF() {
            return new Promise((resolve, reject) => {
                try {
                    if (!currentReportData) {
                        reject(new Error('Nenhum relatório para exportar'));
                        return;
                    }
                    
                    // Create a detailed PDF with audit trail
                    createSecurePDF();
                    resolve();
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Export to Excel
        function exportToExcel() {
            return new Promise((resolve, reject) => {
                try {
                    if (!currentReportData) {
                        reject(new Error('Nenhum relatório para exportar'));
                        return;
                    }
                    
                    // Create Excel file
                    createExcelFile();
                    resolve();
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Create secure PDF with audit trail
        function createSecurePDF() {
            const { reportType, shiftFilter, startDate, endDate, filteredRecords, generatedBy, generationTime } = currentReportData;
            
            // Create a detailed text representation of the report
            let reportText = `KFC Kitchen Count Manager - Relatório Seguro\n`;
            reportText += `================================================\n\n`;
            reportText += `INFORMAÇÕES DO RELATÓRIO:\n`;
            reportText += `Tipo: ${getReportTypeName(reportType)}\n`;
            reportText += `Período: ${startDate} a ${endDate}\n`;
            reportText += `Gerado por: ${generatedBy}\n`;
            reportText += `Data/Hora: ${new Date(generationTime).toLocaleString('pt-PT')}\n`;
            reportText += `ID do Relatório: ${generateReportId()}\n`;
            reportText += `Assinatura Digital: ${generateDigitalSignature()}\n\n`;
            reportText += `================================================\n\n`;
            
            // Add detailed content based on report type
            if (reportType === 'weekly' || reportType === 'monthly') {
                reportText += generateSummaryReportText(filteredRecords, reportType);
            } else if (reportType === 'comparative') {
                reportText += generateComparativeReportText(filteredRecords);
            } else {
                reportText += generateDetailedReportText(filteredRecords);
            }
            
            // Add audit trail
            reportText += `\n\n================================================\n`;
            reportText += `TRAIL DE AUDITORIA:\n`;
            reportText += `Este relatório foi gerado automaticamente pelo sistema.\n`;
            reportText += `Alterações não autorizadas invalidam a assinatura digital.\n`;
            reportText += `Para verificação, contacte a administração do sistema.\n`;
            reportText += `================================================\n`;
            
            // Create a Blob with the text
            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            // Create a download link
            const a = document.createElement('a');
            a.href = url;
            a.download = `KFC_Relatorio_Seguro_${reportType}_${startDate}_a_${endDate}_${generateReportId()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Clean up
            URL.revokeObjectURL(url);
            
            // Log export activity
            logActivity('export_pdf', `Relatório PDF exportado para período ${startDate} a ${endDate}`);
        }

        // Generate report ID
        function generateReportId() {
            return `RPT-${Date.now()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
        }

        // Generate digital signature
        function generateDigitalSignature() {
            const data = JSON.stringify(currentReportData);
            let hash = 0;
            for (let i = 0; i < data.length; i++) {
                const char = data.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return `SIG-${Math.abs(hash).toString(16).toUpperCase()}`;
        }

        // Generate summary report text
        function generateSummaryReportText(records, periodType) {
            let text = `RESUMO ${periodType === 'weekly' ? 'SEMANAL' : 'MENSAL'}\n`;
            text += `─`.repeat(50) + '\n\n';
            
            // Group records by date
            const recordsByDate = {};
            records.forEach(record => {
                if (!recordsByDate[record.date]) {
                    recordsByDate[record.date] = [];
                }
                recordsByDate[record.date].push(record);
            });
            
            let totalOverall = 0;
            let totalTarde = 0;
            let totalNoite = 0;
            
            Object.keys(recordsByDate).sort().forEach(date => {
                const dateRecords = recordsByDate[date];
                const tardeRecords = dateRecords.filter(r => r.shift === 'Tarde');
                const noiteRecords = dateRecords.filter(r => r.shift === 'Noite');
                
                const tardeTotal = tardeRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
                const noiteTotal = noiteRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
                const dailyTotal = tardeTotal + noiteTotal;
                
                totalTarde += tardeTotal;
                totalNoite += noiteTotal;
                totalOverall += dailyTotal;
                
                text += `${date}:\n`;
                text += `  Turno Tarde: ${tardeTotal.toLocaleString()} peças (${tardeRecords.length} registos)\n`;
                text += `  Turno Noite: ${noiteTotal.toLocaleString()} peças (${noiteRecords.length} registos)\n`;
                text += `  Total Diário: ${dailyTotal.toLocaleString()} peças\n`;
                text += `  % Meta: ${Math.round((dailyTotal / 10000) * 100)}%\n\n`;
            });
            
            text += `RESUMO DO PERÍODO:\n`;
            text += `  Total Turno Tarde: ${totalTarde.toLocaleString()} peças\n`;
            text += `  Total Turno Noite: ${totalNoite.toLocaleString()} peças\n`;
            text += `  Total Geral: ${totalOverall.toLocaleString()} peças\n`;
            text += `  Média Diária: ${Math.round(totalOverall / Object.keys(recordsByDate).length).toLocaleString()} peças\n`;
            text += `  % Meta Média: ${Math.round((totalOverall / (10000 * Object.keys(recordsByDate).length)) * 100)}%\n\n`;
            
            return text;
        }

        // Create Excel file
        function createExcelFile() {
            const { reportType, shiftFilter, startDate, endDate, filteredRecords } = currentReportData;
            
            // Create CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            
            if (reportType === 'weekly' || reportType === 'monthly') {
                csvContent += "Data,Turno Tarde,Turno Noite,Total Diário,Média por Registo,% Meta\n";
                
                // Group records by date
                const recordsByDate = {};
                filteredRecords.forEach(record => {
                    if (!recordsByDate[record.date]) {
                        recordsByDate[record.date] = [];
                    }
                    recordsByDate[record.date].push(record);
                });
                
                Object.keys(recordsByDate).sort().forEach(date => {
                    const dateRecords = recordsByDate[date];
                    const tardeRecords = dateRecords.filter(r => r.shift === 'Tarde');
                    const noiteRecords = dateRecords.filter(r => r.shift === 'Noite');
                    
                    const tardeTotal = tardeRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
                    const noiteTotal = noiteRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
                    const dailyTotal = tardeTotal + noiteTotal;
                    const avgPerRecord = dateRecords.length > 0 ? Math.round(dailyTotal / dateRecords.length) : 0;
                    const goalPercentage = Math.round((dailyTotal / 10000) * 100);
                    
                    csvContent += `${date},${tardeTotal},${noiteTotal},${dailyTotal},${avgPerRecord},${goalPercentage}%\n`;
                });
            } else {
                // Standard detailed report
                csvContent += "Data,Turno,Utilizador,";
                PRODUCTS.forEach(product => {
                    csvContent += `${product.name},`;
                });
                csvContent += "Total\n";
                
                filteredRecords.forEach(record => {
                    let row = `${record.date},${record.shift},${record.username},`;
                    
                    PRODUCTS.forEach(product => {
                        const totalValue = record[`${product.id}_total`];
                        row += `${totalValue || 0},`;
                    });
                    
                    row += `${record.total_shift || 0}\n`;
                    csvContent += row;
                });
            }
            
            // Create a download link
            const encodedUri = encodeURI(csvContent);
            const a = document.createElement('a');
            a.href = encodedUri;
            a.download = `KFC_Relatorio_${reportType}_${startDate}_a_${endDate}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Log export activity
            logActivity('export_excel', `Relatório Excel exportado para período ${startDate} a ${endDate}`);
        }

        // Handle report type change
        function handleReportTypeChange(e) {
            const shiftFilterGroup = document.getElementById('shiftFilterGroup');
            if (e.target.value === 'shift') {
                shiftFilterGroup.style.display = 'block';
            } else {
                shiftFilterGroup.style.display = 'none';
            }
        }

        // Show toast notification
        function showToast(message, isError = false) {
            console.log('Showing toast:', message, isError);
            
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'error' : ''}`;
            toast.innerHTML = `
                <i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        // Test function to check if app is working
        window.testApp = function() {
            console.log('=== APP STATUS ===');
            console.log('Current user:', currentUser);
            console.log('Selected shift:', selectedShift);
            console.log('Total records:', allRecords.length);
            console.log('Login screen display:', document.getElementById('loginScreen').style.display);
            console.log('Main app display:', document.getElementById('mainApp').style.display);
            console.log('Active tab:', document.querySelector('.nav-tab.active')?.dataset.tab);
            console.log('=== END STATUS ===');
        };
    </script>
</body>
</html>
