<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KFC Kitchen Count Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e30613 0%, #8b0000 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            min-height: 100vh;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
        }

        /* Login Screen */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #e30613 0%, #8b0000 100%);
        }

        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #e30613, #ff6b6b);
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: #e30613;
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .login-header p {
            color: #666;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #444;
            font-weight: 600;
            font-size: 15px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #e30613;
            box-shadow: 0 0 0 3px rgba(227, 6, 19, 0.1);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e30613 0%, #b8050f 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #b8050f 0%, #e30613 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(227, 6, 19, 0.3);
        }

        /* Main App */
        #mainApp {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #e30613 0%, #8b0000 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Navigation */
        .nav-tabs {
            background: white;
            display: flex;
            gap: 5px;
            padding: 0 30px;
            border-bottom: 2px solid #eee;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 18px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            white-space: nowrap;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-tab:hover {
            color: #e30613;
            background: #f9f9f9;
        }

        .nav-tab.active {
            color: #e30613;
            border-bottom-color: #e30613;
            background: #fff5f5;
            font-weight: 600;
        }

        /* Content */
        .content {
            flex: 1;
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Shift Selector */
        .shift-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .shift-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            text-align: center;
        }

        .shift-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(227, 6, 19, 0.15);
            border-color: #e30613;
        }

        .shift-card.selected {
            border-color: #e30613;
            background: #fff5f5;
        }

        .shift-card h3 {
            color: #e30613;
            font-size: 22px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .shift-card p {
            color: #666;
            font-size: 15px;
        }

        /* Registration Form */
        #registrationForm {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            font-size: 15px;
        }

        .info-box strong {
            color: #856404;
        }

        /* Products Table */
        .products-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .products-table table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        .products-table th {
            background: #e30613;
            color: white;
            padding: 18px;
            text-align: left;
            font-weight: 600;
            font-size: 15px;
        }

        .products-table td {
            padding: 18px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        .products-table tr:last-child td {
            border-bottom: none;
        }

        .products-table tbody tr:hover {
            background: #f9f9f9;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #e30613;
        }

        .adjust-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .adjust-btn.plus {
            background: #28a745;
            color: white;
        }

        .adjust-btn.plus:hover {
            background: #218838;
        }

        .adjust-btn.minus {
            background: #dc3545;
            color: white;
        }

        .adjust-btn.minus:hover {
            background: #c82333;
        }

        .total-display {
            font-weight: 700;
            color: #e30613;
            font-size: 16px;
        }

        /* Summary Cards */
        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-card .value {
            color: #e30613;
            font-size: 36px;
            font-weight: 700;
        }

        .summary-card .subtitle {
            color: #888;
            font-size: 12px;
            margin-top: 5px;
        }

        /* Dashboard Cards */
        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .dashboard-card h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .dashboard-main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .dashboard-main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Charts */
        .chart-container {
            height: 250px;
            position: relative;
            margin-top: 15px;
        }

        .chart-bar {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 15px;
            padding: 0 10px;
            border-bottom: 2px solid #eee;
        }

        .chart-bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .chart-bar-fill {
            width: 40px;
            background: linear-gradient(to top, #e30613, #ff6b6b);
            border-radius: 6px 6px 0 0;
            transition: height 0.3s;
            position: relative;
        }

        .chart-bar-fill:hover::after {
            content: attr(data-value);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
        }

        .chart-bar-label {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        /* Reports */
        .report-filters {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .report-table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        .report-table th {
            background: #e30613;
            color: white;
            padding: 18px;
            text-align: left;
            font-weight: 600;
        }

        .report-table td {
            padding: 16px 18px;
            border-bottom: 1px solid #eee;
        }

        .shift-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .shift-badge.tarde {
            background: #ffc107;
            color: #000;
        }

        .shift-badge.noite {
            background: #17a2b8;
            color: white;
        }

        .totals-row {
            background: #f8f9fa !important;
            font-weight: 700;
        }

        .totals-row td {
            color: #e30613;
            font-size: 16px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #28a745;
            color: white;
            padding: 16px 24px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }

        .toast.error {
            background: #dc3545;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 22px;
            margin-bottom: 15px;
            color: #666;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #e30613, #ff6b6b);
            border-radius: 4px;
            transition: width 0.3s;
        }

        /* Statistics */
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .stat-value {
            color: #e30613;
            font-weight: 600;
            font-size: 16px;
        }

        /* Security Badge */
        .security-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h3 {
            color: #333;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .close-modal:hover {
            color: #e30613;
            background: #f5f5f5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .user-info {
                width: 100%;
                justify-content: space-between;
            }
            
            .nav-tabs {
                padding: 0 15px;
            }
            
            .nav-tab {
                padding: 15px;
                font-size: 14px;
            }
            
            .shift-selector {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .products-table,
            .report-table-container {
                margin: 0 -20px;
                border-radius: 0;
            }
        }

        @media (max-width: 480px) {
            .login-container {
                padding: 30px 20px;
            }
            
            .products-table th,
            .products-table td,
            .report-table th,
            .report-table td {
                padding: 12px;
            }
            
            .adjust-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="login-container">
                <div class="login-header">
                    <h2><i class="fas fa-drumstick-bite"></i> KFC Kitchen Count Manager</h2>
                    <p>Sistema de Contagem de Produção</p>
                    <div class="security-badge">
                        <i class="fas fa-shield-alt"></i> Seguro
                    </div>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username"><i class="fas fa-user"></i> Nome de Utilizador</label>
                        <input type="text" id="username" required placeholder="Digite seu nome">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" style="display: none;">
            <header class="header">
                <div class="header-top">
                    <h1><i class="fas fa-drumstick-bite"></i> KFC Kitchen Count Manager</h1>
                    <div class="user-info">
                        <span class="user-name"><i class="fas fa-user"></i> <span id="currentUser">Utilizador</span></span>
                        <button class="logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </button>
                    </div>
                </div>
            </header>
            
            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="register">
                    <i class="fas fa-edit"></i> Registo
                </button>
                <button class="nav-tab" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="nav-tab" data-tab="reports">
                    <i class="fas fa-chart-bar"></i> Relatórios
                </button>
                <button class="nav-tab" data-tab="manage">
                    <i class="fas fa-database"></i> Gerir Registos
                </button>
            </nav>
            
            <main class="content">
                <!-- Register Tab -->
                <div id="registerTab" class="tab-content active">
                    <div class="shift-selector">
                        <div class="shift-card" data-shift="Tarde">
                            <h3><i class="fas fa-sun"></i> Turno da Tarde</h3>
                            <p>Registo de produção do turno da tarde (14h - 22h)</p>
                        </div>
                        <div class="shift-card" data-shift="Noite">
                            <h3><i class="fas fa-moon"></i> Turno da Noite</h3>
                            <p>Registo de produção do turno da noite (22h - 06h)</p>
                        </div>
                    </div>
                    <div id="registrationForm" style="display: none;">
                        <h2 style="margin-bottom: 25px; color: #333;">Registo - Turno: <span id="selectedShift" style="color: #e30613;"></span></h2>
                        <div class="info-box">
                            <strong><i class="fas fa-info-circle"></i> Instruções:</strong> Para <strong>Pedaços</strong>, insira o total de peças manualmente. Para Asas e Filetes Value, insira o número de <strong>caixas</strong>. O sistema calcula automaticamente.
                        </div>
                        <div class="products-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Configuração</th>
                                        <th>Sacos/Caixas</th>
                                        <th>Ajustes (unidades)</th>
                                        <th>Total Peças</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody"></tbody>
                            </table>
                        </div>
                        <div class="dashboard-grid">
                            <div class="summary-card">
                                <h3>Total do Turno</h3>
                                <div class="value" id="shiftTotal">0</div>
                                <div class="subtitle">Peças totais produzidas</div>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="saveBtn">
                                <i class="fas fa-save"></i> Guardar Registo
                            </button>
                            <button class="btn btn-secondary" id="cancelBtn">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Tab -->
                <div id="dashboardTab" class="tab-content">
                    <h2 style="margin-bottom: 25px; color: #333;"><i class="fas fa-tachometer-alt"></i> Dashboard - Análise de Produção</h2>
                    
                    <div class="dashboard-main-grid">
                        <!-- Main Statistics -->
                        <div class="dashboard-card">
                            <h3><i class="fas fa-chart-line"></i> Estatísticas do Dia</h3>
                            <div class="dashboard-grid">
                                <div class="summary-card">
                                    <h3>Produção Hoje</h3>
                                    <div class="value" id="todayProduction">0</div>
                                    <div class="subtitle" id="todayRecords">0 registos</div>
                                </div>
                                <div class="summary-card">
                                    <h3>Média por Registo</h3>
                                    <div class="value" id="avgPerRecord">0</div>
                                    <div class="subtitle">Peças/registo</div>
                                </div>
                                <div class="summary-card">
                                    <h3>Turno Mais Produtivo</h3>
                                    <div class="value" id="mostProductiveShift">-</div>
                                    <div class="subtitle" id="shiftProductivity">0 peças</div>
                                </div>
                            </div>
                            
                            <h3 style="margin-top: 30px;"><i class="fas fa-chart-bar"></i> Distribuição por Produto (Hoje)</h3>
                            <div class="chart-container">
                                <div class="chart-bar" id="todayProductChart"></div>
                            </div>
                        </div>
                        
                        <!-- Sidebar Stats -->
                        <div class="dashboard-card">
                            <h3><i class="fas fa-history"></i> Histórico Rápido</h3>
                            <div class="stat-item">
                                <span class="stat-label">Produção Total</span>
                                <span class="stat-value" id="totalProduction">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Registos Totais</span>
                                <span class="stat-value" id="totalRecords">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Turno Tarde</span>
                                <span class="stat-value" id="tardeTotal">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Turno Noite</span>
                                <span class="stat-value" id="noiteTotal">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Média Diária</span>
                                <span class="stat-value" id="dailyAvg">0</span>
                            </div>
                            
                            <h3 style="margin-top: 30px;"><i class="fas fa-bullseye"></i> Meta do Dia</h3>
                            <div class="value" style="text-align: center; font-size: 32px; color: #e30613;" id="dailyGoal">10.000</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="goalProgress" style="width: 0%"></div>
                            </div>
                            <div style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;">
                                <span id="goalPercentage">0%</span> da meta atingida
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Records Table -->
                    <div class="dashboard-card" style="margin-top: 30px;">
                        <h3><i class="fas fa-clock"></i> Registos Recentes</h3>
                        <div class="report-table-container">
                            <div id="recentEntries"></div>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reportsTab" class="tab-content">
                    <div class="report-filters">
                        <h2 style="margin-bottom: 25px; color: #333;"><i class="fas fa-file-contract"></i> Relatórios de Produção</h2>
                        <div class="info-box" style="margin-bottom: 25px;">
                            <strong><i class="fas fa-shield-alt"></i> Segurança:</strong> Todos os relatórios são gerados com timestamp e assinatura digital para auditoria.
                        </div>
                        <div class="filter-row">
                            <div class="form-group">
                                <label for="reportType"><i class="fas fa-chart-pie"></i> Tipo de Relatório</label>
                                <select id="reportType">
                                    <option value="daily">Diário Detalhado</option>
                                    <option value="shift">Por Turno</option>
                                    <option value="comparative">Comparativo</option>
                                </select>
                            </div>
                            <div class="form-group" id="shiftFilterGroup" style="display: none;">
                                <label for="shiftFilter"><i class="fas fa-clock"></i> Filtrar Turno</label>
                                <select id="shiftFilter">
                                    <option value="all">Todos os Turnos</option>
                                    <option value="Tarde">Apenas Tarde</option>
                                    <option value="Noite">Apenas Noite</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="startDate"><i class="fas fa-calendar-alt"></i> Data Início</label>
                                <input type="date" id="startDate">
                            </div>
                            <div class="form-group">
                                <label for="endDate"><i class="fas fa-calendar-alt"></i> Data Fim</label>
                                <input type="date" id="endDate">
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" id="generateReportBtn">
                                    <i class="fas fa-search"></i> Gerar Relatório
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="reportResults"></div>
                    <div class="action-buttons" id="reportActions" style="display: none;">
                        <button class="btn btn-primary" id="printShiftReportBtn">
                            <i class="fas fa-print"></i> Imprimir Relatório do Turno
                        </button>
                        <button class="btn btn-secondary" id="exportExcelBtn">
                            <i class="fas fa-file-excel"></i> Exportar para Excel
                        </button>
                    </div>
                </div>

                <!-- Manage Records Tab -->
                <div id="manageTab" class="tab-content">
                    <h2 style="margin-bottom: 25px; color: #333;"><i class="fas fa-database"></i> Gerir Registos de Produção</h2>
                    
                    <div class="dashboard-card">
                        <h3><i class="fas fa-filter"></i> Filtros de Pesquisa</h3>
                        <div class="filter-row">
                            <div class="form-group">
                                <label for="searchDate"><i class="fas fa-calendar"></i> Data</label>
                                <input type="date" id="searchDate">
                            </div>
                            <div class="form-group">
                                <label for="searchShift"><i class="fas fa-clock"></i> Turno</label>
                                <select id="searchShift">
                                    <option value="">Todos</option>
                                    <option value="Tarde">Tarde</option>
                                    <option value="Noite">Noite</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="searchUser"><i class="fas fa-user"></i> Utilizador</label>
                                <input type="text" id="searchUser" placeholder="Nome do utilizador">
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" id="searchBtn">
                                    <i class="fas fa-search"></i> Pesquisar
                                </button>
                                <button class="btn btn-secondary" id="resetSearchBtn">
                                    <i class="fas fa-redo"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card" style="margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3><i class="fas fa-list"></i> Todos os Registos</h3>
                            <div style="color: #666; font-size: 14px;">
                                Total: <span id="totalRecordsCount">0</span> registos
                            </div>
                        </div>
                        <div class="report-table-container">
                            <div id="allRecordsList"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Edit Record Modal -->
        <div id="editRecordModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-edit"></i> Editar Registo</h3>
                    <button class="close-modal" id="closeEditModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="editRecordForm"></div>
            </div>
        </div>

        <!-- View Record Modal -->
        <div id="viewRecordModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-eye"></i> Detalhes do Registo</h3>
                    <button class="close-modal" id="closeViewModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="viewRecordDetails"></div>
            </div>
        </div>
    </div>

    <script>
        // Products configuration - AJUSTADO PARA O FORMATO DO RELATÓRIO
        const PRODUCTS = [
            { 
                id: 'minis', 
                name: 'Minis/Tenders', 
                unitsPerBag: 20, 
                inputType: 'bags', 
                inputLabel: 'Sacos',
                reportLabel: 'Minis/Tenders'
            },
            { 
                id: 'filetes', 
                name: 'Filetes', 
                unitsPerBag: 10, 
                inputType: 'bags', 
                inputLabel: 'Sacos',
                reportLabel: 'Filets Ro'
            },
            { 
                id: 'filetes_value', 
                name: 'Filetes Value', 
                unitsPerBag: 24, 
                bagsPerBox: 3, 
                inputType: 'boxes', 
                inputLabel: 'Caixas', 
                reportLabel: 'Filetes Valeu'
            },
            { 
                id: 'zingers', 
                name: 'Zingers', 
                unitsPerBag: 10, 
                inputType: 'bags', 
                inputLabel: 'Sacos',
                reportLabel: 'Rangers'
            },
            { 
                id: 'pedacos', 
                name: 'Pedaços', 
                inputType: 'manual', 
                inputLabel: 'Total Peças',
                reportLabel: 'Pedacos'
            },
            { 
                id: 'asas', 
                name: 'Asas', 
                unitsPerBag: 60, 
                bagsPerBox: 3, 
                inputType: 'boxes', 
                inputLabel: 'Caixas', 
                reportLabel: 'Asas'
            }
        ];

        // Application state
        let currentUser = '';
        let selectedShift = '';
        let currentData = {};
        let allRecords = [];
        let currentReportData = null;
        let editingRecordId = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Application starting...');
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            document.getElementById('searchDate').value = today;
            
            // Load existing records from localStorage
            loadRecordsFromStorage();
            
            // Setup event listeners
            setupEventListeners();
            
            // Force show login screen on startup
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            console.log('App initialized successfully');
        });

        // Load records from localStorage
        function loadRecordsFromStorage() {
            try {
                const savedRecords = localStorage.getItem('kfc_production_records');
                if (savedRecords) {
                    if (savedRecords.startsWith('enc:')) {
                        const encodedData = savedRecords.substring(4);
                        const decodedData = atob(encodedData);
                        allRecords = JSON.parse(decodedData);
                    } else {
                        allRecords = JSON.parse(savedRecords);
                    }
                } else {
                    allRecords = [];
                }
                
                // Validate records
                allRecords = allRecords.filter(record => 
                    record && record.id && record.date && record.shift && record.username
                );
                
            } catch (error) {
                console.error('Error loading records:', error);
                allRecords = [];
                localStorage.removeItem('kfc_production_records');
            }
        }

        // Save records to localStorage
        function saveRecordsToStorage() {
            try {
                const timestamp = new Date().toISOString();
                allRecords.forEach(record => {
                    if (!record.created_at) record.created_at = timestamp;
                    record.updated_at = timestamp;
                });
                
                const dataString = JSON.stringify(allRecords);
                const encodedData = btoa(dataString);
                localStorage.setItem('kfc_production_records', 'enc:' + encodedData);
                
            } catch (error) {
                localStorage.setItem('kfc_production_records', JSON.stringify(allRecords));
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Shift selection
            document.querySelectorAll('.shift-card').forEach(card => {
                card.addEventListener('click', () => handleShiftSelect(card));
            });
            
            // Save record
            document.getElementById('saveBtn').addEventListener('click', handleSaveRecord);
            
            // Cancel
            document.getElementById('cancelBtn').addEventListener('click', handleCancel);
            
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => handleTabSwitch(tab));
            });
            
            // Reports
            document.getElementById('generateReportBtn').addEventListener('click', handleGenerateReport);
            document.getElementById('printShiftReportBtn').addEventListener('click', handlePrintShiftReport);
            document.getElementById('exportExcelBtn').addEventListener('click', handleExportExcel);
            
            // Report type change
            document.getElementById('reportType').addEventListener('change', handleReportTypeChange);
            
            // Manage records
            document.getElementById('searchBtn').addEventListener('click', handleSearchRecords);
            document.getElementById('resetSearchBtn').addEventListener('click', handleResetSearch);
            
            // Modal close buttons
            document.getElementById('closeEditModal').addEventListener('click', closeEditModal);
            document.getElementById('closeViewModal').addEventListener('click', closeViewModal);
            
            // Close modal on overlay click
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        if (modal.id === 'editRecordModal') closeEditModal();
                        else if (modal.id === 'viewRecordModal') closeViewModal();
                    }
                });
            });
            
            console.log('All event listeners set up');
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                showToast('Por favor, insira um nome de utilizador', true);
                return;
            }
            
            currentUser = username;
            document.getElementById('currentUser').textContent = currentUser;
            
            // Show main app
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            
            showToast(`Bem-vindo, ${currentUser}!`);
            
            // Clear login form
            document.getElementById('username').value = '';
            
            // Show register tab
            showTab('register');
        }

        // Handle logout
        function handleLogout() {
            // Reset state
            currentUser = '';
            selectedShift = '';
            currentData = {};
            editingRecordId = null;
            
            // Update UI
            document.getElementById('currentUser').textContent = 'Utilizador';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('registrationForm').style.display = 'none';
            document.querySelectorAll('.shift-card').forEach(c => c.classList.remove('selected'));
            
            // Close modals
            closeEditModal();
            closeViewModal();
            
            showToast('Sessão terminada com sucesso!');
        }

        // Show tab
        function showTab(tabName) {
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            
            // Show tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === tabName + 'Tab');
            });
            
            // Refresh content if needed
            if (tabName === 'dashboard') {
                renderDashboard();
            } else if (tabName === 'reports') {
                document.getElementById('reportActions').style.display = 'none';
            } else if (tabName === 'manage') {
                renderAllRecords();
            }
        }

        // Handle shift selection
        function handleShiftSelect(card) {
            selectedShift = card.dataset.shift;
            console.log('Selected shift:', selectedShift);
            
            // Update UI
            document.querySelectorAll('.shift-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            
            document.getElementById('selectedShift').textContent = selectedShift;
            document.getElementById('registrationForm').style.display = 'block';
            
            // Initialize products table
            initializeProductsTable();
        }

        // Initialize products table
        function initializeProductsTable() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';
            
            currentData = {};
            
            PRODUCTS.forEach(product => {
                currentData[product.id] = {
                    input: 0,
                    adjust: 0,
                    total: 0,
                    numericTotal: 0
                };
                
                const row = document.createElement('tr');
                
                if (product.inputType === 'manual') {
                    row.innerHTML = `
                        <td><strong>${product.name}</strong></td>
                        <td style="font-size: 0.9rem; color: #666;">
                            Inserir total de peças manualmente
                        </td>
                        <td colspan="2">
                            <div class="input-group">
                                <input type="text" 
                                       id="${product.id}_manual" 
                                       value="" 
                                       data-product="${product.id}"
                                       placeholder="Ex: 150, 20/30, 8+1/2">
                            </div>
                        </td>
                        <td class="total-display" id="${product.id}_total">-</td>
                    `;
                } else {
                    const configText = product.configText || `1 saco = ${product.unitsPerBag} unidades`;
                    const fieldName = product.inputType === 'boxes' ? product.id + '_boxes' : product.id + '_bags';
                    
                    row.innerHTML = `
                        <td><strong>${product.name}</strong></td>
                        <td style="font-size: 0.9rem; color: #666;">${configText}</td>
                        <td>
                            <div class="input-group">
                                <input type="number" 
                                       id="${fieldName}" 
                                       min="0" 
                                       step="1" 
                                       value="0" 
                                       data-product="${product.id}"
                                       placeholder="${product.inputLabel}">
                            </div>
                        </td>
                        <td>
                            <div class="input-group">
                                <button class="adjust-btn minus" data-product="${product.id}" data-action="minus">−</button>
                                <input type="number" 
                                       id="${product.id}_adjust" 
                                       value="0" 
                                       data-product="${product.id}"
                                       readonly>
                                <button class="adjust-btn plus" data-product="${product.id}" data-action="plus">+</button>
                            </div>
                        </td>
                        <td class="total-display" id="${product.id}_total">0</td>
                    `;
                }
                
                tbody.appendChild(row);
            });
            
            // Add event listeners
            setTimeout(() => {
                // Input changes
                document.querySelectorAll('#productsTableBody input').forEach(input => {
                    input.addEventListener('input', handleInputChange);
                });
                
                // Adjust buttons
                document.querySelectorAll('.adjust-btn').forEach(btn => {
                    btn.addEventListener('click', handleAdjustClick);
                });
            }, 100);
        }

        // Handle input changes
        function handleInputChange(e) {
            const productId = e.target.dataset.product;
            const product = PRODUCTS.find(p => p.id === productId);
            
            if (!product) return;
            
            if (product.inputType === 'manual') {
                const textValue = e.target.value.trim();
                const numericValue = extractNumericValue(textValue);
                
                currentData[productId] = { 
                    input: textValue, 
                    adjust: 0, 
                    total: textValue,
                    numericTotal: numericValue 
                };
                
                document.getElementById(`${productId}_total`).textContent = textValue || '-';
            } else {
                const fieldName = product.inputType === 'boxes' ? productId + '_boxes' : productId + '_bags';
                const inputElement = document.getElementById(fieldName);
                const adjustElement = document.getElementById(`${productId}_adjust`);
                
                if (!inputElement || !adjustElement) return;
                
                const inputValue = parseInt(inputElement.value) || 0;
                const adjust = parseInt(adjustElement.value) || 0;
                
                let total = 0;
                if (product.inputType === 'boxes') {
                    total = (inputValue * product.bagsPerBox * product.unitsPerBag) + adjust;
                } else {
                    total = (inputValue * product.unitsPerBag) + adjust;
                }
                
                currentData[productId] = { input: inputValue, adjust, total };
                document.getElementById(`${productId}_total`).textContent = total;
            }
            
            updateShiftTotal();
        }

        // Extract numeric value from text
        function extractNumericValue(text) {
            if (!text || text.trim() === '') return 0;
            
            try {
                const simpleNumber = parseFloat(text.replace(',', '.'));
                if (!isNaN(simpleNumber)) return simpleNumber;
                
                const patterns = [
                    /(\d+)\s*sacos?\s*\+\s*(\d+)\s*\/\s*(\d+)/i,
                    /(\d+)\s*sacos?\s*\+\s*(\d+)/i,
                    /(\d+)\s*sacos?/i,
                    /(\d+)\s*\/\s*(\d+)/,
                    /(\d+)/
                ];
                
                for (const pattern of patterns) {
                    const match = text.match(pattern);
                    if (match) {
                        if (match[1] && match[2] && match[3]) {
                            return parseInt(match[1]) + (parseInt(match[2]) / parseInt(match[3]));
                        } else if (match[1] && match[2]) {
                            return parseInt(match[1]) + parseInt(match[2]);
                        } else if (match[1]) {
                            return parseInt(match[1]);
                        }
                    }
                }
                
                return 0;
            } catch (error) {
                return 0;
            }
        }

        // Handle adjust button clicks
        function handleAdjustClick(e) {
            const productId = e.target.dataset.product;
            const action = e.target.dataset.action;
            
            const adjustInput = document.getElementById(`${productId}_adjust`);
            if (!adjustInput) return;
            
            let currentAdjust = parseInt(adjustInput.value) || 0;
            
            if (action === 'plus') {
                currentAdjust++;
            } else if (action === 'minus') {
                currentAdjust--;
            }
            
            adjustInput.value = currentAdjust;
            
            const event = new Event('input');
            adjustInput.dispatchEvent(event);
        }

        // Update shift total
        function updateShiftTotal() {
            let total = 0;
            
            Object.keys(currentData).forEach(productId => {
                const product = PRODUCTS.find(p => p.id === productId);
                const item = currentData[productId];
                
                if (product.inputType === 'manual') {
                    total += item.numericTotal || 0;
                } else {
                    total += item.total || 0;
                }
            });
            
            document.getElementById('shiftTotal').textContent = total;
        }

        // Handle save record
        async function handleSaveRecord() {
            if (!selectedShift) {
                showToast('Por favor, selecione um turno primeiro.', true);
                return;
            }

            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> A guardar...';
            
            try {
                const record = {
                    id: `${Date.now()}_${selectedShift}_${Math.random().toString(36).substr(2, 9)}`,
                    date: new Date().toLocaleDateString('pt-PT'),
                    shift: selectedShift,
                    username: currentUser,
                    created_at: new Date().toISOString(),
                    total_shift: 0
                };
                
                let totalShift = 0;
                
                PRODUCTS.forEach(product => {
                    const data = currentData[product.id];
                    
                    if (!data) return;
                    
                    if (product.inputType === 'manual') {
                        record[`${product.id}_manual`] = data.input || '';
                        record[`${product.id}_adjust`] = 0;
                        record[`${product.id}_total`] = data.input || '0';
                        totalShift += data.numericTotal || 0;
                    } else {
                        if (product.inputType === 'boxes') {
                            record[`${product.id}_boxes`] = data.input || 0;
                        } else {
                            record[`${product.id}_bags`] = data.input || 0;
                        }
                        
                        record[`${product.id}_adjust`] = data.adjust || 0;
                        record[`${product.id}_total`] = data.total || 0;
                        totalShift += data.total || 0;
                    }
                });
                
                record.total_shift = totalShift;
                
                // Add to records
                allRecords.unshift(record);
                saveRecordsToStorage();
                
                showToast('✅ Registo guardado com sucesso!');
                
                // Reset form
                resetRegistrationForm();
                
                // Refresh views
                refreshViews();
                
            } catch (error) {
                console.error('❌ Error saving record:', error);
                showToast('❌ Erro ao guardar registo: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Guardar Registo';
            }
        }

        // Reset registration form
        function resetRegistrationForm() {
            document.getElementById('registrationForm').style.display = 'none';
            document.querySelectorAll('.shift-card').forEach(c => c.classList.remove('selected'));
            selectedShift = '';
            currentData = {};
        }

        // Handle cancel
        function handleCancel() {
            resetRegistrationForm();
        }

        // Handle tab switch
        function handleTabSwitch(tab) {
            showTab(tab.dataset.tab);
        }

        // Handle generate report
        function handleGenerateReport() {
            const reportType = document.getElementById('reportType').value;
            const shiftFilter = document.getElementById('shiftFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            console.log('Generating report:', { reportType, shiftFilter, startDate, endDate });
            
            if (!startDate || !endDate) {
                showToast('Por favor, selecione as datas', true);
                return;
            }
            
            // Generate report
            currentReportData = generateReportData(reportType, shiftFilter, startDate, endDate);
            
            if (currentReportData.filteredRecords.length === 0) {
                document.getElementById('reportResults').innerHTML = `
                    <div class="empty-state">
                        <h3>Sem dados no período</h3>
                        <p>Tente outro intervalo de datas ou filtro de turno</p>
                    </div>
                `;
                document.getElementById('reportActions').style.display = 'none';
                return;
            }
            
            // Display report
            displayReport(currentReportData);
            
            // Show export buttons
            document.getElementById('reportActions').style.display = 'flex';
        }

        // Generate report data
        function generateReportData(reportType, shiftFilter, startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            
            const filteredRecords = allRecords.filter(record => {
                const recordDate = parsePortugueseDate(record.date);
                const dateMatch = recordDate >= start && recordDate <= end;
                const shiftMatch = shiftFilter === 'all' || record.shift === shiftFilter;
                return dateMatch && shiftMatch;
            });
            
            return {
                reportType,
                shiftFilter,
                startDate,
                endDate,
                filteredRecords,
                generatedBy: currentUser,
                generationTime: new Date().toISOString()
            };
        }

        // Parse Portuguese date
        function parsePortugueseDate(dateStr) {
            try {
                if (!dateStr) return new Date();
                
                if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        return new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                }
                
                return new Date(dateStr);
            } catch (error) {
                return new Date();
            }
        }

        // Display report
        function displayReport(reportData) {
            let html = '';
            
            if (reportData.reportType === 'shift') {
                html = generateShiftReportHTML(reportData);
            } else if (reportData.reportType === 'comparative') {
                html = generateComparativeReportHTML(reportData);
            } else {
                html = generateDailyReportHTML(reportData);
            }
            
            document.getElementById('reportResults').innerHTML = html;
        }

        // Generate daily report HTML
        function generateDailyReportHTML(reportData) {
            const { filteredRecords, startDate, endDate, shiftFilter } = reportData;
            
            // Group by date
            const recordsByDate = {};
            filteredRecords.forEach(record => {
                if (!recordsByDate[record.date]) {
                    recordsByDate[record.date] = [];
                }
                recordsByDate[record.date].push(record);
            });
            
            // Sort dates
            const sortedDates = Object.keys(recordsByDate).sort((a, b) => {
                return parsePortugueseDate(b) - parsePortugueseDate(a);
            });
            
            let html = `
                <div class="dashboard-card">
                    <h3><i class="fas fa-file-alt"></i> Relatório Diário</h3>
                    <div style="color: #666; margin-bottom: 20px;">
                        Período: ${startDate} a ${endDate}<br>
                        Filtro: ${shiftFilter === 'all' ? 'Todos os turnos' : 'Turno ' + shiftFilter}
                    </div>
                    
                    <div class="report-table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Turno</th>
                                    <th>Utilizador</th>
                                    <th>Minis/Tenders</th>
                                    <th>Filets Ro</th>
                                    <th>Filetes Valeu</th>
                                    <th>Rangers</th>
                                    <th>Pedacos</th>
                                    <th>Asas</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            let grandTotal = 0;
            let productTotals = {
                minis: 0, filetes: 0, filetes_value: 0, 
                zingers: 0, pedacos: 0, asas: 0
            };
            
            sortedDates.forEach(date => {
                const dateRecords = recordsByDate[date];
                const dateTotal = dateRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
                grandTotal += dateTotal;
                
                // Add date header
                html += `
                    <tr style="background: #f8f9fa;">
                        <td colspan="10" style="font-weight: bold; color: #e30613;">
                            <i class="fas fa-calendar"></i> ${date} - Total: ${dateTotal.toLocaleString()} peças
                        </td>
                    </tr>`;
                
                // Add records for this date
                dateRecords.forEach(record => {
                    // Update product totals
                    PRODUCTS.forEach(product => {
                        const total = record[`${product.id}_total`];
                        if (typeof total === 'number') {
                            productTotals[product.id] += total;
                        } else if (typeof total === 'string' && total.trim() !== '') {
                            const num = extractNumericValue(total);
                            productTotals[product.id] += num;
                        }
                    });
                    
                    html += `
                        <tr>
                            <td></td>
                            <td>
                                <span class="shift-badge ${record.shift.toLowerCase() === 'tarde' ? 'tarde' : 'noite'}">
                                    ${record.shift}
                                </span>
                            </td>
                            <td>${record.username}</td>`;
                    
                    // Product columns in the EXACT order of the report format
                    const productsInOrder = ['minis', 'filetes', 'filetes_value', 'zingers', 'pedacos', 'asas'];
                    productsInOrder.forEach(productId => {
                        const totalValue = record[`${productId}_total`];
                        html += `<td>${totalValue !== undefined && totalValue !== null && totalValue !== '' && totalValue !== 0 ? totalValue : '-'}</td>`;
                    });
                    
                    html += `<td><strong>${record.total_shift || 0}</strong></td></tr>`;
                });
            });
            
            // Add totals row
            html += `
                <tr class="totals-row">
                    <td colspan="3"><strong>TOTAIS:</strong></td>
                    <td><strong>${productTotals.minis.toLocaleString()}</strong></td>
                    <td><strong>${productTotals.filetes.toLocaleString()}</strong></td>
                    <td><strong>${productTotals.filetes_value.toLocaleString()}</strong></td>
                    <td><strong>${productTotals.zingers.toLocaleString()}</strong></td>
                    <td><strong>${productTotals.pedacos.toLocaleString()}</strong></td>
                    <td><strong>${productTotals.asas.toLocaleString()}</strong></td>
                    <td><strong>${grandTotal.toLocaleString()}</strong></td>
                </tr>`;
            
            html += `</tbody></table></div>`;
            
            // Add summary
            html += `
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
                    <div class="dashboard-grid">
                        <div class="summary-card">
                            <h3>Período</h3>
                            <div class="value">${sortedDates.length}</div>
                            <div class="subtitle">dias</div>
                        </div>
                        <div class="summary-card">
                            <h3>Registos</h3>
                            <div class="value">${filteredRecords.length}</div>
                            <div class="subtitle">total</div>
                        </div>
                        <div class="summary-card">
                            <h3>Produção</h3>
                            <div class="value">${grandTotal.toLocaleString()}</div>
                            <div class="subtitle">peças</div>
                        </div>
                        <div class="summary-card">
                            <h3>Média Diária</h3>
                            <div class="value">${sortedDates.length > 0 ? Math.round(grandTotal / sortedDates.length).toLocaleString() : '0'}</div>
                            <div class="subtitle">peças/dia</div>
                        </div>
                    </div>
                </div>
            </div>`;
            
            return html;
        }

        // Generate shift report HTML
        function generateShiftReportHTML(reportData) {
            const { filteredRecords, startDate, endDate, shiftFilter } = reportData;
            
            // Group by shift
            const tardeRecords = filteredRecords.filter(r => r.shift === 'Tarde');
            const noiteRecords = filteredRecords.filter(r => r.shift === 'Noite');
            
            let html = `
                <div class="dashboard-card">
                    <h3><i class="fas fa-clock"></i> Relatório por Turno</h3>
                    <div style="color: #666; margin-bottom: 20px;">
                        Período: ${startDate} a ${endDate}<br>
                        Filtro: ${shiftFilter === 'all' ? 'Todos os turnos' : 'Turno ' + shiftFilter}
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="summary-card">
                            <h3>Turno Tarde</h3>
                            <div class="value">${tardeRecords.length}</div>
                            <div class="subtitle">registos</div>
                        </div>
                        <div class="summary-card">
                            <h3>Turno Noite</h3>
                            <div class="value">${noiteRecords.length}</div>
                            <div class="subtitle">registos</div>
                        </div>
                        <div class="summary-card">
                            <h3>Total Tarde</h3>
                            <div class="value">${tardeRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0).toLocaleString()}</div>
                            <div class="subtitle">peças</div>
                        </div>
                        <div class="summary-card">
                            <h3>Total Noite</h3>
                            <div class="value">${noiteRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0).toLocaleString()}</div>
                            <div class="subtitle">peças</div>
                        </div>
                    </div>`;
            
            // Show each shift table if requested
            if (shiftFilter === 'all' || shiftFilter === 'Tarde') {
                html += generateShiftTableHTML('Tarde', tardeRecords);
            }
            
            if (shiftFilter === 'all' || shiftFilter === 'Noite') {
                html += generateShiftTableHTML('Noite', noiteRecords);
            }
            
            html += `</div>`;
            
            return html;
        }

        // Generate shift table HTML
        function generateShiftTableHTML(shiftName, records) {
            if (records.length === 0) return '';
            
            let html = `
                <div style="margin-top: 30px;">
                    <h4 style="color: #333; margin-bottom: 15px;">
                        <i class="fas ${shiftName === 'Tarde' ? 'fa-sun' : 'fa-moon'}"></i> 
                        Turno ${shiftName}
                    </h4>
                    <div class="report-table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Utilizador</th>
                                    <th>Minis/Tenders</th>
                                    <th>Filets Ro</th>
                                    <th>Filetes Valeu</th>
                                    <th>Rangers</th>
                                    <th>Pedacos</th>
                                    <th>Asas</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            records.forEach(record => {
                html += `
                    <tr>
                        <td>${record.date}</td>
                        <td>${record.username}</td>`;
                
                // Product columns in the EXACT order of the report format
                const productsInOrder = ['minis', 'filetes', 'filetes_value', 'zingers', 'pedacos', 'asas'];
                productsInOrder.forEach(productId => {
                    const totalValue = record[`${productId}_total`];
                    html += `<td>${totalValue !== undefined && totalValue !== null && totalValue !== '' && totalValue !== 0 ? totalValue : '-'}</td>`;
                });
                
                html += `<td><strong>${record.total_shift || 0}</strong></td></tr>`;
            });
            
            // Add totals
            const shiftTotal = records.reduce((sum, r) => sum + (r.total_shift || 0), 0);
            html += `
                <tr class="totals-row">
                    <td colspan="8"><strong>TOTAL ${shiftName}:</strong></td>
                    <td><strong>${shiftTotal.toLocaleString()}</strong></td>
                </tr>`;
            
            html += `</tbody></table></div></div>`;
            
            return html;
        }

        // Generate comparative report HTML
        function generateComparativeReportHTML(reportData) {
            const { filteredRecords, startDate, endDate } = reportData;
            
            // Group by date and shift
            const dailyData = {};
            filteredRecords.forEach(record => {
                if (!dailyData[record.date]) {
                    dailyData[record.date] = { tarde: 0, noite: 0, total: 0 };
                }
                dailyData[record.date][record.shift.toLowerCase()] += record.total_shift || 0;
                dailyData[record.date].total += record.total_shift || 0;
            });
            
            // Sort dates
            const sortedDates = Object.keys(dailyData).sort((a, b) => {
                return parsePortugueseDate(b) - parsePortugueseDate(a);
            });
            
            let html = `
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-line"></i> Relatório Comparativo</h3>
                    <div style="color: #666; margin-bottom: 20px;">
                        Período: ${startDate} a ${endDate}
                    </div>
                    
                    <div class="report-table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Turno Tarde</th>
                                    <th>Turno Noite</th>
                                    <th>Total Dia</th>
                                    <th>Diferença</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            let tardeTotal = 0;
            let noiteTotal = 0;
            
            sortedDates.forEach(date => {
                const data = dailyData[date];
                tardeTotal += data.tarde;
                noiteTotal += data.noite;
                
                const difference = data.tarde - data.noite;
                const diffClass = difference > 0 ? 'badge-success' : (difference < 0 ? 'badge-danger' : '');
                const diffText = difference > 0 ? `+${difference}` : difference;
                
                html += `
                    <tr>
                        <td><strong>${date}</strong></td>
                        <td>${data.tarde.toLocaleString()}</td>
                        <td>${data.noite.toLocaleString()}</td>
                        <td><strong>${data.total.toLocaleString()}</strong></td>
                        <td><span class="badge ${diffClass}">${diffText}</span></td>
                    </tr>`;
            });
            
            // Add totals
            const grandTotal = tardeTotal + noiteTotal;
            const totalDifference = tardeTotal - noiteTotal;
            const totalDiffClass = totalDifference > 0 ? 'badge-success' : (totalDifference < 0 ? 'badge-danger' : '');
            const totalDiffText = totalDifference > 0 ? `+${totalDifference}` : totalDifference;
            
            html += `
                <tr class="totals-row">
                    <td><strong>TOTAIS</strong></td>
                    <td><strong>${tardeTotal.toLocaleString()}</strong></td>
                    <td><strong>${noiteTotal.toLocaleString()}</strong></td>
                    <td><strong>${grandTotal.toLocaleString()}</strong></td>
                    <td><span class="badge ${totalDiffClass}">${totalDiffText}</span></td>
                </tr>`;
            
            html += `</tbody></table></div>`;
            
            return html;
        }

        // Handle print shift report - NOVO FUNCIONALIDADE
        function handlePrintShiftReport() {
            if (!currentReportData) {
                showToast('Gere um relatório primeiro', true);
                return;
            }

            // Verificar se temos registos
            if (currentReportData.filteredRecords.length === 0) {
                showToast('Não há registos para imprimir neste período', true);
                return;
            }

            // Criar relatório no formato específico
            const printContent = generatePrintFormat(currentReportData);
            
            // Abrir janela de impressão
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            
            // Aguardar carregamento e imprimir
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // Generate print format - FORMATO EXATO DA IMAGEM
        function generatePrintFormat(reportData) {
            const { filteredRecords, shiftFilter, startDate, endDate } = reportData;
            
            // Determinar qual turno mostrar
            let shiftToPrint = shiftFilter;
            if (shiftFilter === 'all') {
                // Se for "todos", usar o primeiro turno disponível
                if (filteredRecords.length > 0) {
                    shiftToPrint = filteredRecords[0].shift;
                }
            }
            
            // Filtrar registos apenas para o turno selecionado
            const shiftRecords = filteredRecords.filter(r => r.shift === shiftToPrint);
            
            if (shiftRecords.length === 0) {
                return `
                    <html>
                    <head>
                        <title>Relatório KFC - Sem dados</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            h1 { color: #e30613; }
                        </style>
                    </head>
                    <body>
                        <h1>Sem dados para o turno ${shiftToPrint}</h1>
                    </body>
                    </html>`;
            }
            
            // Agrupar por data
            const recordsByDate = {};
            shiftRecords.forEach(record => {
                if (!recordsByDate[record.date]) {
                    recordsByDate[record.date] = [];
                }
                recordsByDate[record.date].push(record);
            });
            
            // Criar conteúdo do relatório
            let printHtml = '';
            
            // Para cada data, criar uma página separada
            const dates = Object.keys(recordsByDate).sort((a, b) => {
                return parsePortugueseDate(b) - parsePortugueseDate(a);
            });
            
            dates.forEach((date, dateIndex) => {
                const dateRecords = recordsByDate[date];
                
                // Calcular totais para esta data
                let dateTotal = 0;
                const dateProductTotals = {
                    minis: 0, filetes: 0, filetes_value: 0,
                    zingers: 0, pedacos: 0, asas: 0
                };
                
                dateRecords.forEach(record => {
                    dateTotal += record.total_shift || 0;
                    
                    // Só considerar o primeiro registro por data para o formato simples
                    if (dateRecords.indexOf(record) === 0) {
                        PRODUCTS.forEach(product => {
                            const total = record[`${product.id}_total`];
                            if (typeof total === 'number') {
                                dateProductTotals[product.id] += total;
                            } else if (typeof total === 'string' && total.trim() !== '') {
                                const num = extractNumericValue(total);
                                dateProductTotals[product.id] += num;
                            }
                        });
                    }
                });
                
                // Formato EXATO da imagem
                printHtml += `
                    <div style="page-break-after: ${dateIndex < dates.length - 1 ? 'always' : 'avoid'};">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h1 style="color: #e30613; font-size: 24px; margin-bottom: 10px;">
                                Contagem ${shiftToPrint === 'Tarde' ? 'Tarde' : 'Noite'}
                            </h1>
                            <h2 style="font-size: 20px; margin-bottom: 20px;">
                                Date: ${date}
                            </h2>
                        </div>
                        
                        <div style="font-size: 18px; line-height: 2.5; margin-left: 50px;">
                            <div>Minis/Tenders – ${dateProductTotals.minis || 0}</div>
                            <div>Filets Ro – ${dateProductTotals.filetes || 0}</div>
                            <div>Filetes Valeu – ${dateProductTotals.filetes_value || 0}</div>
                            <div>Rangers – ${dateProductTotals.zingers || 0}</div>
                            <div>Pedacos – ${dateProductTotals.pedacos || 0}</div>
                            <div>Asas – ${dateProductTotals.asas || 0}</div>
                        </div>
                        
                        <div style="margin-top: 40px; font-size: 16px; text-align: center;">
                            <div>Total do ${shiftToPrint}: <strong>${dateTotal.toLocaleString()}</strong> peças</div>
                            <div style="margin-top: 10px; font-size: 14px; color: #666;">
                                Registado por: ${dateRecords[0].username} | 
                                Período: ${startDate} a ${endDate}
                            </div>
                        </div>
                    </div>`;
            });
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Relatório KFC - ${shiftToPrint}</title>
                    <style>
                        body { 
                            font-family: 'Arial', sans-serif; 
                            margin: 0;
                            padding: 20px;
                            background: white;
                        }
                        @media print {
                            body { margin: 0; padding: 20px; }
                            h1, h2 { color: black !important; }
                            div { page-break-inside: avoid; }
                        }
                        @page {
                            size: A4;
                            margin: 20mm;
                        }
                    </style>
                </head>
                <body>
                    ${printHtml}
                </body>
                </html>`;
        }

        // Handle export to Excel
        async function handleExportExcel() {
            if (!currentReportData) {
                showToast('Gere um relatório primeiro', true);
                return;
            }

            const btn = document.getElementById('exportExcelBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> A gerar...';
            
            try {
                await exportToExcel(currentReportData);
                showToast('✅ Excel gerado com sucesso!');
            } catch (error) {
                console.error('❌ Error generating Excel:', error);
                showToast('❌ Erro ao gerar Excel: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-file-excel"></i> Exportar Excel';
            }
        }

        // Export to Excel
        function exportToExcel(reportData) {
            return new Promise((resolve, reject) => {
                try {
                    const { filteredRecords } = reportData;
                    
                    // Create CSV content
                    let csv = 'Data,Turno,Utilizador,Minis/Tenders,Filets Ro,Filetes Valeu,Rangers,Pedacos,Asas,Total\n';
                    
                    filteredRecords.forEach(record => {
                        const row = [
                            `"${record.date}"`,
                            `"${record.shift}"`,
                            `"${record.username}"`,
                            record.minis_total || '0',
                            record.filetes_total || '0',
                            record.filetes_value_total || '0',
                            record.zingers_total || '0',
                            record.pedacos_total || '0',
                            record.asas_total || '0',
                            record.total_shift || '0'
                        ];
                        csv += row.join(',') + '\n';
                    });
                    
                    // Create download link
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', `relatorio_kfc_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    resolve();
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Handle report type change
        function handleReportTypeChange(e) {
            const shiftFilterGroup = document.getElementById('shiftFilterGroup');
            if (e.target.value === 'shift') {
                shiftFilterGroup.style.display = 'block';
            } else {
                shiftFilterGroup.style.display = 'none';
            }
        }

        // ============================
        // MANAGE RECORDS
        // ============================

        // Handle search records
        function handleSearchRecords() {
            const searchDate = document.getElementById('searchDate').value;
            const searchShift = document.getElementById('searchShift').value;
            const searchUser = document.getElementById('searchUser').value.trim();
            
            const filters = {};
            
            if (searchDate) {
                const dateParts = searchDate.split('-');
                filters.date = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
            }
            
            if (searchShift) {
                filters.shift = searchShift;
            }
            
            if (searchUser) {
                filters.username = searchUser;
            }
            
            renderAllRecords(filters);
        }

        // Render all records
        function renderAllRecords(filters = {}) {
            const filteredRecords = getRecords(filters);
            const container = document.getElementById('allRecordsList');
            const countElement = document.getElementById('totalRecordsCount');
            
            countElement.textContent = filteredRecords.length;
            
            if (filteredRecords.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Nenhum registo encontrado</h3>
                        <p>Tente alterar os filtros de pesquisa</p>
                    </div>
                `;
                return;
            }
            
            let html = '<table class="report-table"><thead><tr>';
            html += '<th>Data</th><th>Turno</th><th>Utilizador</th>';
            html += '<th>Minis/Tenders</th><th>Filets Ro</th><th>Filetes Valeu</th><th>Rangers</th><th>Pedacos</th><th>Asas</th>';
            html += '<th>Total</th><th class="no-print">Ações</th></tr></thead><tbody>';
            
            filteredRecords.forEach(record => {
                const shiftClass = record.shift.toLowerCase();
                
                html += `<tr>
                    <td><strong>${record.date || 'N/A'}</strong></td>
                    <td>
                        <span class="shift-badge ${shiftClass === 'tarde' ? 'tarde' : 'noite'}">
                            ${record.shift || 'N/A'}
                        </span>
                    </td>
                    <td>${record.username || 'N/A'}</td>`;
                
                // Product columns in the EXACT order
                const productsInOrder = ['minis', 'filetes', 'filetes_value', 'zingers', 'pedacos', 'asas'];
                productsInOrder.forEach(productId => {
                    const totalValue = record[`${productId}_total`];
                    html += `<td>${totalValue !== undefined && totalValue !== null && totalValue !== '' && totalValue !== 0 ? totalValue : '-'}</td>`;
                });
                
                html += `<td><strong>${record.total_shift || 0}</strong></td>`;
                
                // Action buttons
                html += `<td>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-small" onclick="viewRecord('${record.id}')" title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-small btn-warning" onclick="editRecord('${record.id}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteRecord('${record.id}')" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Get filtered records
        function getRecords(filters = {}) {
            let filtered = [...allRecords];
            
            if (filters.date) {
                filtered = filtered.filter(r => r.date === filters.date);
            }
            
            if (filters.shift) {
                filtered = filtered.filter(r => r.shift === filters.shift);
            }
            
            if (filters.username) {
                const searchTerm = filters.username.toLowerCase();
                filtered = filtered.filter(r => r.username.toLowerCase().includes(searchTerm));
            }
            
            return filtered;
        }

        // View record details
        window.viewRecord = function(recordId) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) {
                showToast('Registo não encontrado!', true);
                return;
            }
            
            let html = `
                <div class="dashboard-card" style="background: none; box-shadow: none; padding: 0;">
                    <div class="dashboard-grid">
                        <div class="summary-card">
                            <h3>Data</h3>
                            <div class="value">${record.date}</div>
                        </div>
                        <div class="summary-card">
                            <h3>Turno</h3>
                            <div class="value">
                                <span class="shift-badge ${record.shift.toLowerCase() === 'tarde' ? 'tarde' : 'noite'}">
                                    ${record.shift}
                                </span>
                            </div>
                        </div>
                        <div class="summary-card">
                            <h3>Utilizador</h3>
                            <div class="value">${record.username}</div>
                        </div>
                        <div class="summary-card">
                            <h3>Total</h3>
                            <div class="value">${record.total_shift || 0}</div>
                            <div class="subtitle">peças</div>
                        </div>
                    </div>
                    
                    <div class="products-table" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Quantidade</th>
                                    <th>Total Peças</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            PRODUCTS.forEach(product => {
                let value = '';
                if (product.inputType === 'manual') {
                    value = record[`${product.id}_manual`] || '';
                } else if (product.inputType === 'boxes') {
                    const boxes = record[`${product.id}_boxes`] || 0;
                    value = `${boxes} caixa(s)`;
                } else {
                    const bags = record[`${product.id}_bags`] || 0;
                    value = `${bags} saco(s)`;
                }
                
                const total = record[`${product.id}_total`] || '-';
                
                html += `
                    <tr>
                        <td><strong>${product.name}</strong></td>
                        <td>${value}</td>
                        <td class="total-display">${total}</td>
                    </tr>`;
            });
            
            html += `</tbody></table></div>
                </div>`;
            
            document.getElementById('viewRecordDetails').innerHTML = html;
            document.getElementById('viewRecordModal').style.display = 'flex';
        }

        // Edit record
        window.editRecord = function(recordId) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) {
                showToast('Registo não encontrado!', true);
                return;
            }
            
            editingRecordId = recordId;
            
            let html = `
                <form id="editForm">
                    <div class="dashboard-grid" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="editDate">Data</label>
                            <input type="date" id="editDate" 
                                   value="${record.date.split('/').reverse().join('-')}" required>
                        </div>
                        <div class="form-group">
                            <label for="editShift">Turno</label>
                            <select id="editShift" required>
                                <option value="Tarde" ${record.shift === 'Tarde' ? 'selected' : ''}>Tarde</option>
                                <option value="Noite" ${record.shift === 'Noite' ? 'selected' : ''}>Noite</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editUsername">Utilizador</label>
                            <input type="text" id="editUsername" value="${record.username}" required>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <strong><i class="fas fa-info-circle"></i> Atenção:</strong> 
                        Apenas administradores podem editar registos existentes.
                    </div>
                    
                    <div class="products-table" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Configuração</th>
                                    <th>Sacos/Caixas</th>
                                    <th>Total Peças</th>
                                </tr>
                            </thead>
                            <tbody id="editProductsTableBody"></tbody>
                        </table>
                    </div>
                    
                    <div class="action-buttons" style="margin-top: 30px;">
                        <button type="button" class="btn btn-primary" id="updateRecordBtn">
                            <i class="fas fa-save"></i> Atualizar Registo
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelEditBtn">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>`;
            
            document.getElementById('editRecordForm').innerHTML = html;
            document.getElementById('editRecordModal').style.display = 'flex';
            
            // Populate products table
            populateEditProductsTable(record);
            
            // Add event listeners
            document.getElementById('updateRecordBtn').addEventListener('click', handleUpdateRecord);
            document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);
        }

        // Populate edit products table
        function populateEditProductsTable(record) {
            const tbody = document.getElementById('editProductsTableBody');
            tbody.innerHTML = '';
            
            PRODUCTS.forEach(product => {
                const row = document.createElement('tr');
                
                if (product.inputType === 'manual') {
                    const manualValue = record[`${product.id}_manual`] || '';
                    row.innerHTML = `
                        <td><strong>${product.name}</strong></td>
                        <td style="font-size: 0.9rem; color: #666;">
                            Inserir total de peças manualmente
                        </td>
                        <td>
                            <div class="input-group">
                                <input type="text" 
                                       id="edit_${product.id}_manual" 
                                       value="${manualValue}">
                            </div>
                        </td>
                        <td class="total-display">${manualValue || '-'}</td>
                    `;
                } else if (product.inputType === 'boxes') {
                    const boxesValue = record[`${product.id}_boxes`] || 0;
                    const totalValue = record[`${product.id}_total`] || 0;
                    row.innerHTML = `
                        <td><strong>${product.name}</strong></td>
                        <td style="font-size: 0.9rem; color: #666;">${product.configText}</td>
                        <td>
                            <div class="input-group">
                                <input type="number" 
                                       id="edit_${product.id}_boxes" 
                                       value="${boxesValue}" min="0">
                            </div>
                        </td>
                        <td class="total-display">${totalValue}</td>
                    `;
                } else {
                    const bagsValue = record[`${product.id}_bags`] || 0;
                    const totalValue = record[`${product.id}_total`] || 0;
                    row.innerHTML = `
                        <td><strong>${product.name}</strong></td>
                        <td style="font-size: 0.9rem; color: #666;">
                            1 saco = ${product.unitsPerBag} unidades
                        </td>
                        <td>
                            <div class="input-group">
                                <input type="number" 
                                       id="edit_${product.id}_bags" 
                                       value="${bagsValue}" min="0">
                            </div>
                        </td>
                        <td class="total-display">${totalValue}</td>
                    `;
                }
                
                tbody.appendChild(row);
            });
        }

        // Handle update record
        async function handleUpdateRecord() {
            if (!editingRecordId) {
                showToast('Nenhum registo selecionado para editar!', true);
                return;
            }

            const btn = document.getElementById('updateRecordBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> A atualizar...';
            
            try {
                const recordIndex = allRecords.findIndex(r => r.id === editingRecordId);
                if (recordIndex === -1) {
                    throw new Error('Registo não encontrado');
                }
                
                const record = allRecords[recordIndex];
                
                // Get form values
                const editDate = document.getElementById('editDate').value;
                const editShift = document.getElementById('editShift').value;
                const editUsername = document.getElementById('editUsername').value.trim();
                
                if (!editDate || !editShift || !editUsername) {
                    throw new Error('Preencha todos os campos obrigatórios');
                }
                
                // Convert date to Portuguese format
                const dateParts = editDate.split('-');
                const portugueseDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                
                // Update basic info
                record.date = portugueseDate;
                record.shift = editShift;
                record.username = editUsername;
                
                // Update product values
                let totalShift = 0;
                
                PRODUCTS.forEach(product => {
                    if (product.inputType === 'manual') {
                        const manualValue = document.getElementById(`edit_${product.id}_manual`).value.trim();
                        record[`${product.id}_manual`] = manualValue;
                        record[`${product.id}_adjust`] = 0;
                        record[`${product.id}_total`] = manualValue;
                        
                        const numericValue = extractNumericValue(manualValue);
                        totalShift += numericValue;
                    } else if (product.inputType === 'boxes') {
                        const boxesValue = parseInt(document.getElementById(`edit_${product.id}_boxes`).value) || 0;
                        record[`${product.id}_boxes`] = boxesValue;
                        record[`${product.id}_adjust`] = 0;
                        
                        const total = boxesValue * product.bagsPerBox * product.unitsPerBag;
                        record[`${product.id}_total`] = total;
                        totalShift += total;
                    } else {
                        const bagsValue = parseInt(document.getElementById(`edit_${product.id}_bags`).value) || 0;
                        record[`${product.id}_bags`] = bagsValue;
                        record[`${product.id}_adjust`] = 0;
                        
                        const total = bagsValue * product.unitsPerBag;
                        record[`${product.id}_total`] = total;
                        totalShift += total;
                    }
                });
                
                record.total_shift = totalShift;
                record.updated_at = new Date().toISOString();
                
                // Update record
                allRecords[recordIndex] = record;
                saveRecordsToStorage();
                
                showToast('✅ Registo atualizado com sucesso!');
                
                // Close modal
                closeEditModal();
                
                // Refresh views
                refreshViews();
                
            } catch (error) {
                console.error('❌ Error updating record:', error);
                showToast('❌ Erro ao atualizar registo: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Atualizar Registo';
            }
        }

        // Delete record
        window.deleteRecord = async function(recordId) {
            if (!confirm('Tem certeza que deseja eliminar este registo?\nEsta ação não pode ser desfeita.')) {
                return;
            }

            try {
                const recordIndex = allRecords.findIndex(r => r.id === recordId);
                if (recordIndex === -1) {
                    throw new Error('Registo não encontrado');
                }
                
                // Delete record
                allRecords.splice(recordIndex, 1);
                saveRecordsToStorage();
                
                showToast('✅ Registo eliminado com sucesso!');
                
                // Refresh views
                refreshViews();
                
            } catch (error) {
                console.error('❌ Error deleting record:', error);
                showToast('❌ Erro ao eliminar registo: ' + error.message, true);
            }
        }

        // Handle reset search
        function handleResetSearch() {
            document.getElementById('searchDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('searchShift').value = '';
            document.getElementById('searchUser').value = '';
            
            renderAllRecords();
        }

        // Render dashboard
        function renderDashboard() {
            const today = new Date().toLocaleDateString('pt-PT');
            const todayRecords = allRecords.filter(r => r.date === today);
            const todayProduction = todayRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
            const totalProduction = allRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
            const tardeTotal = allRecords.filter(r => r.shift === 'Tarde').reduce((sum, r) => sum + (r.total_shift || 0), 0);
            const noiteTotal = allRecords.filter(r => r.shift === 'Noite').reduce((sum, r) => sum + (r.total_shift || 0), 0);
            
            // Calculate averages
            const avgPerRecord = todayRecords.length > 0 ? Math.round(todayProduction / todayRecords.length) : 0;
            const mostProductiveShift = tardeTotal > noiteTotal ? 'Tarde' : (noiteTotal > tardeTotal ? 'Noite' : '-');
            const shiftProductivity = Math.max(tardeTotal, noiteTotal);
            
            // Calculate daily average
            const dates = [...new Set(allRecords.map(r => r.date))];
            const dailyAvg = dates.length > 0 ? Math.round(totalProduction / dates.length) : 0;
            
            // Update dashboard elements
            document.getElementById('todayProduction').textContent = todayProduction.toLocaleString();
            document.getElementById('todayRecords').textContent = `${todayRecords.length} registos`;
            document.getElementById('avgPerRecord').textContent = avgPerRecord.toLocaleString();
            document.getElementById('mostProductiveShift').textContent = mostProductiveShift;
            document.getElementById('shiftProductivity').textContent = `${shiftProductivity.toLocaleString()} peças`;
            document.getElementById('totalProduction').textContent = totalProduction.toLocaleString();
            document.getElementById('totalRecords').textContent = allRecords.length.toLocaleString();
            document.getElementById('tardeTotal').textContent = tardeTotal.toLocaleString();
            document.getElementById('noiteTotal').textContent = noiteTotal.toLocaleString();
            document.getElementById('dailyAvg').textContent = dailyAvg.toLocaleString();
            
            // Update goal progress
            const dailyGoal = 10000;
            const goalPercentage = Math.min(Math.round((todayProduction / dailyGoal) * 100), 100);
            document.getElementById('goalProgress').style.width = `${goalPercentage}%`;
            document.getElementById('goalPercentage').textContent = `${goalPercentage}%`;
            
            // Render charts and recent entries
            renderProductChart(todayRecords);
            renderRecentEntries();
        }

        // Render product chart
        function renderProductChart(records) {
            const chartContainer = document.getElementById('todayProductChart');
            chartContainer.innerHTML = '';
            
            if (records.length === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; padding: 50px; color: #999;">Sem dados para hoje</div>';
                return;
            }
            
            // Calculate totals per product
            const productTotals = {};
            PRODUCTS.forEach(product => {
                productTotals[product.id] = records.reduce((sum, r) => {
                    const val = r[`${product.id}_total`];
                    if (typeof val === 'number') return sum + val;
                    if (typeof val === 'string' && val.trim() !== '') {
                        const num = extractNumericValue(val);
                        return sum + num;
                    }
                    return sum;
                }, 0);
            });
            
            // Find max value for scaling
            const maxValue = Math.max(...Object.values(productTotals));
            
            // Create chart bars
            PRODUCTS.forEach(product => {
                const value = productTotals[product.id];
                if (value > 0) {
                    const percentage = maxValue > 0 ? (value / maxValue) * 100 : 0;
                    
                    const barItem = document.createElement('div');
                    barItem.className = 'chart-bar-item';
                    
                    const barFill = document.createElement('div');
                    barFill.className = 'chart-bar-fill';
                    barFill.style.height = `${percentage}%`;
                    barFill.setAttribute('data-value', value.toLocaleString());
                    
                    const barLabel = document.createElement('div');
                    barLabel.className = 'chart-bar-label';
                    barLabel.textContent = product.reportLabel;
                    
                    barItem.appendChild(barFill);
                    barItem.appendChild(barLabel);
                    chartContainer.appendChild(barItem);
                }
            });
            
            if (chartContainer.children.length === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; padding: 50px; color: #999;">Sem produção registada hoje</div>';
            }
        }

        // Render recent entries
        function renderRecentEntries() {
            const container = document.getElementById('recentEntries');
            
            if (!allRecords || allRecords.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Nenhum registo encontrado</p></div>';
                return;
            }
            
            const recentRecords = allRecords.slice(0, 10);
            
            let html = '<table class="report-table"><thead><tr>';
            html += '<th>Data</th><th>Turno</th><th>Utilizador</th>';
            html += '<th>Minis/Tenders</th><th>Filets Ro</th><th>Filetes Valeu</th><th>Rangers</th><th>Pedacos</th><th>Asas</th>';
            html += '<th>Total</th></tr></thead><tbody>';
            
            recentRecords.forEach(record => {
                const shiftClass = record.shift.toLowerCase();
                
                html += `
                    <tr>
                        <td><strong>${record.date || 'N/A'}</strong></td>
                        <td>
                            <span class="shift-badge ${shiftClass === 'tarde' ? 'tarde' : 'noite'}">
                                ${record.shift || 'N/A'}
                            </span>
                        </td>
                        <td>${record.username || 'N/A'}</td>`;
                
                // Product columns in the EXACT order
                const productsInOrder = ['minis', 'filetes', 'filetes_value', 'zingers', 'pedacos', 'asas'];
                productsInOrder.forEach(productId => {
                    const totalValue = record[`${productId}_total`];
                    html += `<td>${totalValue !== undefined && totalValue !== null && totalValue !== '' && totalValue !== 0 ? totalValue : '-'}</td>`;
                });
                
                html += `<td><strong>${record.total_shift || 0}</strong></td></tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ============================
        // UTILITY FUNCTIONS
        // ============================

        // Refresh all views
        function refreshViews() {
            if (document.getElementById('dashboardTab').classList.contains('active')) {
                renderDashboard();
            }
            if (document.getElementById('manageTab').classList.contains('active')) {
                renderAllRecords();
            }
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editRecordModal').style.display = 'none';
            editingRecordId = null;
        }

        // Close view modal
        function closeViewModal() {
            document.getElementById('viewRecordModal').style.display = 'none';
        }

        // Show toast notification
        function showToast(message, isError = false) {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'error' : ''}`;
            toast.innerHTML = `
                <i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        // Make functions available globally
        window.viewRecord = viewRecord;
        window.editRecord = editRecord;
        window.deleteRecord = deleteRecord;
    </script>
</body>
</html>
