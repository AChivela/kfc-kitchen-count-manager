<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KFC Kitchen Count Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* ========== RESET & BASE ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-red: #e30613;
            --dark-red: #8b0000;
            --light-red: #ff6b6b;
            --light-bg: #fff5f5;
            --text-dark: #333;
            --text-light: #666;
            --text-lighter: #888;
            --border-color: #e0e0e0;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --gray: #6c757d;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --transition: all 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--dark-red) 100%);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ========== LAYOUT CONTAINERS ========== */
        .app-container {
            min-height: 100vh;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
        }

        /* ========== LOGIN SCREEN ========== */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--dark-red) 100%);
        }

        .login-container {
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            padding: 40px 30px;
            width: 100%;
            max-width: 420px;
            text-align: center;
            position: relative;
            overflow: hidden;
            animation: slideUp 0.5s ease;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--primary-red), var(--light-red));
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: var(--primary-red);
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .login-header p {
            color: var(--text-light);
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 16px;
            transition: var(--transition);
            background: #fff;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(227, 6, 19, 0.1);
        }

        /* ========== BUTTONS ========== */
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
            user-select: none;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-block {
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-red) 0%, #b8050f 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #b8050f 0%, var(--primary-red) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(227, 6, 19, 0.3);
        }

        .btn-secondary {
            background: var(--gray);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--warning);
            color: #000;
        }

        .btn-warning:hover:not(:disabled) {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-red);
            color: var(--primary-red);
        }

        .btn-outline:hover:not(:disabled) {
            background: var(--light-bg);
        }

        /* ========== MAIN APP ========== */
        #mainApp {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--dark-red) 100%);
            color: white;
            padding: 20px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .app-title {
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.1);
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
        }

        .user-name {
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ========== NAVIGATION ========== */
        .nav-tabs {
            background: white;
            display: flex;
            gap: 2px;
            padding: 0 20px;
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            position: sticky;
            top: 80px;
            z-index: 99;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            padding: 18px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            color: var(--text-light);
            white-space: nowrap;
            transition: var(--transition);
            font-weight: 500;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-tab:hover {
            color: var(--primary-red);
            background: #f9f9f9;
        }

        .nav-tab.active {
            color: var(--primary-red);
            border-bottom-color: var(--primary-red);
            background: var(--light-bg);
            font-weight: 600;
        }

        /* ========== CONTENT AREA ========== */
        .content {
            flex: 1;
            padding: 30px 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== SHIFT SELECTOR ========== */
        .shift-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .shift-card {
            background: white;
            padding: 30px 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            border: 3px solid transparent;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .shift-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(227, 6, 19, 0.15);
        }

        .shift-card.selected {
            border-color: var(--primary-red);
            background: var(--light-bg);
            box-shadow: 0 8px 20px rgba(227, 6, 19, 0.2);
        }

        .shift-card-icon {
            font-size: 40px;
            color: var(--primary-red);
        }

        .shift-card h3 {
            color: var(--text-dark);
            font-size: 20px;
            margin: 0;
        }

        .shift-card p {
            color: var(--text-light);
            font-size: 14px;
            line-height: 1.5;
        }

        /* ========== REGISTRATION FORM ========== */
        #registrationForm {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            margin-top: 20px;
        }

        .info-box {
            background: #fff3cd;
            border-left: 4px solid var(--warning);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: var(--radius-sm);
            font-size: 15px;
            line-height: 1.6;
        }

        .info-box strong {
            color: #856404;
        }

        /* ========== TABLES ========== */
        .table-container {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table-container table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        .table-container th {
            background: var(--primary-red);
            color: white;
            padding: 18px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
        }

        .table-container td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .table-container tbody tr:hover {
            background: #f9f9f9;
        }

        .table-container tbody tr:last-child td {
            border-bottom: none;
        }

        /* ========== INPUT GROUPS ========== */
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .input-group input {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 15px;
            transition: var(--transition);
            min-width: 120px;
            flex: 1;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary-red);
        }

        .adjust-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .adjust-btn.plus {
            background: var(--success);
            color: white;
        }

        .adjust-btn.plus:hover {
            background: #218838;
        }

        .adjust-btn.minus {
            background: var(--danger);
            color: white;
        }

        .adjust-btn.minus:hover {
            background: #c82333;
        }

        /* ========== CARDS ========== */
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-title {
            color: var(--text-dark);
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ========== SUMMARY CARDS ========== */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card h3 {
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .summary-card .value {
            color: var(--primary-red);
            font-size: 36px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 5px;
        }

        .summary-card .subtitle {
            color: var(--text-lighter);
            font-size: 13px;
            margin-top: 8px;
        }

        /* ========== DASHBOARD GRID ========== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 2fr 1fr;
            }
        }

        /* ========== CHARTS ========== */
        .chart-container {
            position: relative;
            margin-top: 20px;
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 20px;
            padding: 0 10px 20px;
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .chart-bar {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 60px;
        }

        .chart-fill {
            width: 40px;
            background: linear-gradient(to top, var(--primary-red), var(--light-red));
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            transition: height 0.3s;
            position: relative;
            min-height: 10px;
        }

        .chart-fill:hover::after {
            content: attr(data-value);
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
            pointer-events: none;
        }

        .chart-label {
            font-size: 12px;
            color: var(--text-light);
            text-align: center;
            font-weight: 500;
            max-width: 80px;
            word-wrap: break-word;
            line-height: 1.3;
        }

        /* ========== ACTION BUTTONS ========== */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 200px;
        }

        /* ========== REPORTS ========== */
        .report-filters {
            background: white;
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* ========== BADGES ========== */
        .badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
        }

        .badge-tarde {
            background: var(--warning);
            color: #000;
        }

        .badge-noite {
            background: var(--info);
            color: white;
        }

        .badge-success {
            background: var(--success);
            color: white;
        }

        .badge-danger {
            background: var(--danger);
            color: white;
        }

        /* ========== TOTALS ROW ========== */
        .totals-row {
            background: #f8f9fa !important;
            font-weight: 700;
        }

        .totals-row td {
            color: var(--primary-red);
            font-size: 16px;
            padding: 18px 16px;
        }

        /* ========== STATISTICS ========== */
        .stat-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            color: var(--primary-red);
            font-weight: 600;
            font-size: 16px;
        }

        /* ========== PROGRESS BAR ========== */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-red), var(--light-red));
            border-radius: 5px;
            transition: width 0.3s ease;
            position: relative;
        }

        /* ========== TOAST NOTIFICATIONS ========== */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--success);
            color: white;
            padding: 16px 24px;
            border-radius: var(--radius-sm);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            max-width: 400px;
        }

        .toast.error {
            background: var(--danger);
        }

        .toast.warning {
            background: var(--warning);
            color: #000;
        }

        .toast.info {
            background: var(--info);
        }

        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ========== MODALS ========== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h3 {
            color: var(--text-dark);
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-light);
            cursor: pointer;
            padding: 5px;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--primary-red);
            background: #f5f5f5;
        }

        /* ========== EMPTY STATES ========== */
        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: var(--text-lighter);
        }

        .empty-state-icon {
            font-size: 60px;
            color: #e0e0e0;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--text-light);
        }

        .empty-state p {
            font-size: 15px;
            max-width: 400px;
            margin: 0 auto;
        }

        /* ========== LOADING ========== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .content {
                padding: 20px 15px;
            }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .user-info {
                width: 100%;
                justify-content: space-between;
            }
            
            .nav-tabs {
                padding: 0 10px;
                top: 140px;
            }
            
            .nav-tab {
                padding: 15px;
                font-size: 14px;
            }
            
            .shift-selector {
                grid-template-columns: 1fr;
            }
            
            #registrationForm,
            .report-filters,
            .card {
                padding: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                min-width: 100%;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .table-container {
                margin: 0 -15px;
                border-radius: 0;
            }
            
            .toast {
                left: 20px;
                right: 20px;
                bottom: 20px;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .login-container {
                padding: 30px 20px;
            }
            
            .table-container th,
            .table-container td {
                padding: 12px 10px;
                font-size: 14px;
            }
            
            .adjust-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            
            .summary-card {
                padding: 20px;
            }
            
            .summary-card .value {
                font-size: 30px;
            }
            
            .modal-content {
                padding: 20px;
            }
        }

        /* ========== PRINT STYLES ========== */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white;
            }
            
            .app-container {
                background: white;
            }
            
            .table-container {
                box-shadow: none;
                border: 1px solid #000;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #000;
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="login-container">
                <div class="login-header">
                    <h2><i class="fas fa-drumstick-bite"></i> KFC Kitchen Manager</h2>
                    <p>Sistema de Contagem de Produção</p>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username"><i class="fas fa-user"></i> Nome de Utilizador</label>
                        <input type="text" id="username" class="form-control" required placeholder="Digite seu nome">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" style="display: none;">
            <header class="header">
                <div class="header-content">
                    <h1 class="app-title">
                        <i class="fas fa-drumstick-bite"></i> KFC Kitchen Manager
                    </h1>
                    <div class="user-info">
                        <span class="user-name">
                            <i class="fas fa-user"></i> 
                            <span id="currentUser">Utilizador</span>
                        </span>
                        <button class="btn btn-sm btn-outline" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </button>
                    </div>
                </div>
            </header>
            
            <nav class="nav-tabs no-print">
                <button class="nav-tab active" data-tab="register">
                    <i class="fas fa-edit"></i> Registo
                </button>
                <button class="nav-tab" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="nav-tab" data-tab="reports">
                    <i class="fas fa-chart-bar"></i> Relatórios
                </button>
                <button class="nav-tab" data-tab="manage">
                    <i class="fas fa-database"></i> Gerir
                </button>
            </nav>
            
            <main class="content">
                <!-- Register Tab -->
                <div id="registerTab" class="tab-content active">
                    <div class="shift-selector">
                        <div class="shift-card" data-shift="Tarde">
                            <div class="shift-card-icon">
                                <i class="fas fa-sun"></i>
                            </div>
                            <h3>Turno da Tarde</h3>
                            <p>Registo de produção do turno da tarde (14h - 22h)</p>
                        </div>
                        <div class="shift-card" data-shift="Noite">
                            <div class="shift-card-icon">
                                <i class="fas fa-moon"></i>
                            </div>
                            <h3>Turno da Noite</h3>
                            <p>Registo de produção do turno da noite (22h - 06h)</p>
                        </div>
                    </div>
                    
                    <div id="registrationForm" style="display: none;">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-edit"></i>
                                Registo - Turno: <span id="selectedShift" style="color: var(--primary-red);"></span>
                            </h2>
                        </div>
                        
                        <div class="info-box">
                            <strong><i class="fas fa-info-circle"></i> Instruções:</strong> 
                            Para <strong>Pedaços</strong>, insira o total de peças manualmente. 
                            Para Asas e Filetes Value, insira o número de <strong>caixas</strong>. 
                            O sistema calcula automaticamente.
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Configuração</th>
                                        <th>Sacos/Caixas</th>
                                        <th>Ajustes</th>
                                        <th>Total Peças</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody"></tbody>
                            </table>
                        </div>
                        
                        <div class="summary-grid">
                            <div class="summary-card">
                                <h3>Total do Turno</h3>
                                <div class="value" id="shiftTotal">0</div>
                                <div class="subtitle">Peças totais produzidas</div>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="saveBtn">
                                <i class="fas fa-save"></i> Guardar Registo
                            </button>
                            <button class="btn btn-secondary" id="cancelBtn">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Tab -->
                <div id="dashboardTab" class="tab-content">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </h2>
                    </div>
                    
                    <div class="dashboard-grid">
                        <!-- Main Statistics -->
                        <div class="card">
                            <h3 class="card-title">
                                <i class="fas fa-chart-line"></i> Estatísticas do Dia
                            </h3>
                            
                            <div class="summary-grid">
                                <div class="summary-card">
                                    <h3>Produção Hoje</h3>
                                    <div class="value" id="todayProduction">0</div>
                                    <div class="subtitle" id="todayRecords">0 registos</div>
                                </div>
                                <div class="summary-card">
                                    <h3>Média por Registo</h3>
                                    <div class="value" id="avgPerRecord">0</div>
                                    <div class="subtitle">Peças/registo</div>
                                </div>
                                <div class="summary-card">
                                    <h3>Turno Mais Produtivo</h3>
                                    <div class="value" id="mostProductiveShift">-</div>
                                    <div class="subtitle" id="shiftProductivity">0 peças</div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 30px;">
                                <h3 class="card-title">
                                    <i class="fas fa-chart-bar"></i> Distribuição por Produto (Hoje)
                                </h3>
                                <div class="chart-container">
                                    <div class="chart-bars" id="todayProductChart"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sidebar Stats -->
                        <div class="card">
                            <h3 class="card-title">
                                <i class="fas fa-history"></i> Histórico Rápido
                            </h3>
                            
                            <div class="stat-list">
                                <div class="stat-item">
                                    <span class="stat-label">Produção Total</span>
                                    <span class="stat-value" id="totalProduction">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Registos Totais</span>
                                    <span class="stat-value" id="totalRecords">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Turno Tarde</span>
                                    <span class="stat-value" id="tardeTotal">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Turno Noite</span>
                                    <span class="stat-value" id="noiteTotal">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Média Diária</span>
                                    <span class="stat-value" id="dailyAvg">0</span>
                                </div>
                            </div>
                            
                            <div style="margin-top: 30px;">
                                <h3 class="card-title">
                                    <i class="fas fa-bullseye"></i> Meta do Dia
                                </h3>
                                <div class="value" style="text-align: center; font-size: 32px; color: var(--primary-red);" id="dailyGoal">10.000</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="goalProgress" style="width: 0%"></div>
                                </div>
                                <div style="text-align: center; margin-top: 10px; color: var(--text-light); font-size: 14px;">
                                    <span id="goalPercentage">0%</span> da meta atingida
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Records -->
                    <div class="card" style="margin-top: 30px;">
                        <h3 class="card-title">
                            <i class="fas fa-clock"></i> Registos Recentes
                        </h3>
                        <div class="table-container">
                            <div id="recentEntries"></div>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reportsTab" class="tab-content">
                    <div class="report-filters">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-file-contract"></i> Relatórios de Produção
                            </h2>
                        </div>
                        
                        <div class="info-box" style="margin-bottom: 25px;">
                            <strong><i class="fas fa-shield-alt"></i> Segurança:</strong> 
                            Todos os relatórios são gerados com timestamp e assinatura digital.
                        </div>
                        
                        <div class="filter-grid">
                            <div class="filter-group">
                                <label for="reportType">
                                    <i class="fas fa-chart-pie"></i> Tipo de Relatório
                                </label>
                                <select id="reportType" class="form-control">
                                    <option value="daily">Diário Detalhado</option>
                                    <option value="shift">Por Turno</option>
                                    <option value="comparative">Comparativo</option>
                                </select>
                            </div>
                            
                            <div class="filter-group" id="shiftFilterGroup">
                                <label for="shiftFilter">
                                    <i class="fas fa-clock"></i> Filtrar Turno
                                </label>
                                <select id="shiftFilter" class="form-control">
                                    <option value="all">Todos os Turnos</option>
                                    <option value="Tarde">Apenas Tarde</option>
                                    <option value="Noite">Apenas Noite</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="startDate">
                                    <i class="fas fa-calendar-alt"></i> Data Início
                                </label>
                                <input type="date" id="startDate" class="form-control">
                            </div>
                            
                            <div class="filter-group">
                                <label for="endDate">
                                    <i class="fas fa-calendar-alt"></i> Data Fim
                                </label>
                                <input type="date" id="endDate" class="form-control">
                            </div>
                            
                            <div class="filter-group">
                                <button class="btn btn-primary" id="generateReportBtn">
                                    <i class="fas fa-search"></i> Gerar Relatório
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="reportResults"></div>
                    
                    <div class="action-buttons no-print" id="reportActions" style="display: none;">
                        <button class="btn btn-success" id="printDailyBtn">
                            <i class="fas fa-print"></i> Imprimir Diário
                        </button>
                        <button class="btn btn-primary" id="exportPdfBtn">
                            <i class="fas fa-file-pdf"></i> Exportar PDF
                        </button>
                        <button class="btn btn-warning" id="exportExcelBtn">
                            <i class="fas fa-file-excel"></i> Exportar Excel
                        </button>
                    </div>
                </div>

                <!-- Manage Records Tab -->
                <div id="manageTab" class="tab-content">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-database"></i> Gerir Registos
                        </h2>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">
                            <i class="fas fa-filter"></i> Filtros de Pesquisa
                        </h3>
                        <div class="filter-grid">
                            <div class="filter-group">
                                <label for="searchDate">
                                    <i class="fas fa-calendar"></i> Data
                                </label>
                                <input type="date" id="searchDate" class="form-control">
                            </div>
                            <div class="filter-group">
                                <label for="searchShift">
                                    <i class="fas fa-clock"></i> Turno
                                </label>
                                <select id="searchShift" class="form-control">
                                    <option value="">Todos</option>
                                    <option value="Tarde">Tarde</option>
                                    <option value="Noite">Noite</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="searchUser">
                                    <i class="fas fa-user"></i> Utilizador
                                </label>
                                <input type="text" id="searchUser" class="form-control" placeholder="Nome do utilizador">
                            </div>
                            <div class="filter-group">
                                <button class="btn btn-primary" id="searchBtn">
                                    <i class="fas fa-search"></i> Pesquisar
                                </button>
                                <button class="btn btn-secondary" id="resetSearchBtn">
                                    <i class="fas fa-redo"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 30px;">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-list"></i> Todos os Registos
                            </h3>
                            <div style="color: var(--text-light); font-size: 14px;">
                                Total: <span id="totalRecordsCount">0</span> registos
                            </div>
                        </div>
                        <div class="table-container">
                            <div id="allRecordsList"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modals -->
        <div id="editRecordModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-edit"></i> Editar Registo</h3>
                    <button class="modal-close" id="closeEditModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="editRecordForm"></div>
            </div>
        </div>

        <div id="viewRecordModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-eye"></i> Detalhes do Registo</h3>
                    <button class="modal-close" id="closeViewModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="viewRecordDetails"></div>
            </div>
        </div>
    </div>

    <script>
        // Products configuration
        const PRODUCTS = [
            { 
                id: 'filetes', 
                name: 'Filetes', 
                unitsPerBag: 10, 
                inputType: 'bags', 
                inputLabel: 'Sacos',
                icon: 'fas fa-drumstick-bite'
            },
            { 
                id: 'minis', 
                name: 'Minis/Tenders', 
                unitsPerBag: 20, 
                inputType: 'bags', 
                inputLabel: 'Sacos',
                icon: 'fas fa-utensils'
            },
            { 
                id: 'zingers', 
                name: 'Zingers', 
                unitsPerBag: 10, 
                inputType: 'bags', 
                inputLabel: 'Sacos',
                icon: 'fas fa-fire'
            },
            { 
                id: 'pedacos', 
                name: 'Pedaços', 
                inputType: 'manual', 
                inputLabel: 'Total Peças',
                icon: 'fas fa-box'
            },
            { 
                id: 'asas', 
                name: 'Asas', 
                unitsPerBag: 60, 
                bagsPerBox: 3, 
                inputType: 'boxes', 
                inputLabel: 'Caixas', 
                configText: '1 caixa = 3 sacos de 60 unid',
                icon: 'fas fa-drumstick'
            },
            { 
                id: 'filetes_value', 
                name: 'Filetes Value', 
                unitsPerBag: 24, 
                bagsPerBox: 3, 
                inputType: 'boxes', 
                inputLabel: 'Caixas', 
                configText: '1 caixa = 3 sacos de 24 unid',
                icon: 'fas fa-tag'
            }
        ];

        // Application state
        let currentUser = '';
        let selectedShift = '';
        let currentData = {};
        let allRecords = [];
        let currentReportData = null;
        let editingRecordId = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Application starting...');
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            document.getElementById('searchDate').value = today;
            
            // Load existing records from localStorage
            loadRecordsFromStorage();
            
            // Setup event listeners
            setupEventListeners();
            
            // Force show login screen on startup
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            console.log('✅ App initialized successfully');
        });

        // Load records from localStorage
        function loadRecordsFromStorage() {
            try {
                const savedRecords = localStorage.getItem('kfc_production_records');
                if (savedRecords) {
                    // Check if data is encrypted
                    if (savedRecords.startsWith('enc:')) {
                        const encodedData = savedRecords.substring(4);
                        const decodedData = atob(encodedData);
                        allRecords = JSON.parse(decodedData);
                        console.log(`📂 Loaded ${allRecords.length} encrypted records from storage`);
                    } else {
                        allRecords = JSON.parse(savedRecords);
                        console.log(`📂 Loaded ${allRecords.length} records from storage`);
                    }
                } else {
                    allRecords = [];
                    console.log('📂 No records found in storage, starting fresh');
                }
                
                // Validate records
                allRecords = allRecords.filter(record => 
                    record && record.id && record.date && record.shift && record.username
                );
                
            } catch (error) {
                console.error('❌ Error loading records from storage:', error);
                allRecords = [];
                localStorage.removeItem('kfc_production_records');
            }
        }

        // Save records to localStorage
        function saveRecordsToStorage() {
            try {
                // Add timestamps
                const timestamp = new Date().toISOString();
                allRecords.forEach(record => {
                    if (!record.created_at) record.created_at = timestamp;
                    record.updated_at = timestamp;
                    record.signature = generateSignature(record);
                });
                
                // Simple encryption
                const dataString = JSON.stringify(allRecords);
                const encodedData = btoa(dataString);
                localStorage.setItem('kfc_production_records', 'enc:' + encodedData);
                
                console.log(`💾 Saved ${allRecords.length} records to storage`);
                
            } catch (error) {
                console.error('❌ Error saving records:', error);
                localStorage.setItem('kfc_production_records', JSON.stringify(allRecords));
            }
        }

        // Generate signature
        function generateSignature(record) {
            const str = `${record.date}|${record.shift}|${record.username}|${record.total_shift}`;
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        // Setup event listeners
        function setupEventListeners() {
            console.log('🔧 Setting up event listeners...');
            
            // Login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Shift selection
            document.querySelectorAll('.shift-card').forEach(card => {
                card.addEventListener('click', () => handleShiftSelect(card));
            });
            
            // Save record
            document.getElementById('saveBtn').addEventListener('click', handleSaveRecord);
            
            // Cancel
            document.getElementById('cancelBtn').addEventListener('click', handleCancel);
            
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => handleTabSwitch(tab));
            });
            
            // Reports
            document.getElementById('generateReportBtn').addEventListener('click', handleGenerateReport);
            document.getElementById('printDailyBtn').addEventListener('click', handlePrintDailyReport);
            document.getElementById('exportPdfBtn').addEventListener('click', handleExportPDF);
            document.getElementById('exportExcelBtn').addEventListener('click', handleExportExcel);
            
            // Report type change
            document.getElementById('reportType').addEventListener('change', handleReportTypeChange);
            
            // Manage records
            document.getElementById('searchBtn').addEventListener('click', handleSearchRecords);
            document.getElementById('resetSearchBtn').addEventListener('click', handleResetSearch);
            
            // Modal close buttons
            document.getElementById('closeEditModal').addEventListener('click', closeEditModal);
            document.getElementById('closeViewModal').addEventListener('click', closeViewModal);
            
            // Close modal on overlay click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        if (modal.id === 'editRecordModal') closeEditModal();
                        else if (modal.id === 'viewRecordModal') closeViewModal();
                    }
                });
            });
            
            console.log('✅ All event listeners set up');
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            
            console.log('👤 Login attempt:', username);
            
            if (!username) {
                showToast('Por favor, insira um nome de utilizador', true);
                return;
            }
            
            currentUser = username;
            document.getElementById('currentUser').textContent = currentUser;
            
            // Show main app
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            
            showToast(`Bem-vindo, ${currentUser}!`);
            
            // Log activity
            logActivity('login', `Utilizador ${currentUser} entrou no sistema`);
            
            // Clear login form
            document.getElementById('username').value = '';
            
            // Show register tab
            showTab('register');
        }

        // Log activity
        function logActivity(action, description) {
            const activity = {
                timestamp: new Date().toISOString(),
                user: currentUser,
                action: action,
                description: description
            };
            
            console.log('📝 Activity logged:', activity);
            
            const activities = JSON.parse(localStorage.getItem('kfc_activities') || '[]');
            activities.unshift(activity);
            if (activities.length > 1000) activities.pop();
            localStorage.setItem('kfc_activities', JSON.stringify(activities));
        }

        // Handle logout
        function handleLogout() {
            console.log('👋 Logging out:', currentUser);
            
            logActivity('logout', `Utilizador ${currentUser} saiu do sistema`);
            
            // Reset state
            currentUser = '';
            selectedShift = '';
            currentData = {};
            editingRecordId = null;
            
            // Update UI
            document.getElementById('currentUser').textContent = 'Utilizador';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('registrationForm').style.display = 'none';
            document.querySelectorAll('.shift-card').forEach(c => c.classList.remove('selected'));
            
            // Close modals
            closeEditModal();
            closeViewModal();
            
            showToast('Sessão terminada com sucesso!');
        }

        // Show tab
        function showTab(tabName) {
            console.log('📁 Showing tab:', tabName);
            
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            
            // Show tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === tabName + 'Tab');
            });
            
            // Refresh content if needed
            if (tabName === 'dashboard') {
                renderDashboard();
            } else if (tabName === 'reports') {
                document.getElementById('reportActions').style.display = 'none';
            } else if (tabName === 'manage') {
                renderAllRecords();
            }
        }

        // Handle shift selection
        function handleShiftSelect(card) {
            selectedShift = card.dataset.shift;
            console.log('🕐 Selected shift:', selectedShift);
            
            // Update UI
            document.querySelectorAll('.shift-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            
            document.getElementById('selectedShift').textContent = selectedShift;
            document.getElementById('registrationForm').style.display = 'block';
            
            // Initialize products table
            initializeProductsTable();
        }

        // Initialize products table
        function initializeProductsTable() {
            console.log('📊 Initializing products table');
            
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';
            
            currentData = {};
            
            PRODUCTS.forEach(product => {
                currentData[product.id] = {
                    input: 0,
                    adjust: 0,
                    total: 0,
                    numericTotal: 0
                };
                
                const row = document.createElement('tr');
                
                if (product.inputType === 'manual') {
                    row.innerHTML = `
                        <td><strong>${product.name}</strong></td>
                        <td style="font-size: 0.9rem; color: var(--text-light);">
                            Inserir total de peças manualmente
                        </td>
                        <td colspan="2">
                            <div class="input-group">
                                <input type="text" 
                                       id="${product.id}_manual" 
                                       value="" 
                                       data-product="${product.id}"
                                       placeholder="Ex: 150, 20/30, 8+1/2"
                                       class="form-control">
                            </div>
                        </td>
                        <td class="total-display" id="${product.id}_total">-</td>
                    `;
                } else {
                    const configText = product.configText || `1 saco = ${product.unitsPerBag} unidades`;
                    const fieldName = product.inputType === 'boxes' ? product.id + '_boxes' : product.id + '_bags';
                    
                    row.innerHTML = `
                        <td><strong>${product.name}</strong></td>
                        <td style="font-size: 0.9rem; color: var(--text-light);">${configText}</td>
                        <td>
                            <div class="input-group">
                                <input type="number" 
                                       id="${fieldName}" 
                                       min="0" 
                                       step="1" 
                                       value="0" 
                                       data-product="${product.id}"
                                       class="form-control"
                                       placeholder="${product.inputLabel}">
                            </div>
                        </td>
                        <td>
                            <div class="input-group">
                                <button class="adjust-btn minus" data-product="${product.id}" data-action="minus">−</button>
                                <input type="number" 
                                       id="${product.id}_adjust" 
                                       value="0" 
                                       data-product="${product.id}"
                                       readonly
                                       class="form-control"
                                       style="max-width: 80px;">
                                <button class="adjust-btn plus" data-product="${product.id}" data-action="plus">+</button>
                            </div>
                        </td>
                        <td class="total-display" id="${product.id}_total">0</td>
                    `;
                }
                
                tbody.appendChild(row);
            });
            
            // Add event listeners
            setTimeout(() => {
                // Input changes
                document.querySelectorAll('#productsTableBody input').forEach(input => {
                    input.addEventListener('input', handleInputChange);
                });
                
                // Adjust buttons
                document.querySelectorAll('.adjust-btn').forEach(btn => {
                    btn.addEventListener('click', handleAdjustClick);
                });
            }, 100);
        }

        // Handle input changes
        function handleInputChange(e) {
            const productId = e.target.dataset.product;
            const product = PRODUCTS.find(p => p.id === productId);
            
            if (!product) return;
            
            if (product.inputType === 'manual') {
                const textValue = e.target.value.trim();
                const numericValue = extractNumericValue(textValue);
                
                currentData[productId] = { 
                    input: textValue, 
                    adjust: 0, 
                    total: textValue,
                    numericTotal: numericValue 
                };
                
                document.getElementById(`${productId}_total`).textContent = textValue || '-';
            } else {
                const fieldName = product.inputType === 'boxes' ? productId + '_boxes' : productId + '_bags';
                const inputElement = document.getElementById(fieldName);
                const adjustElement = document.getElementById(`${productId}_adjust`);
                
                if (!inputElement || !adjustElement) return;
                
                const inputValue = parseInt(inputElement.value) || 0;
                const adjust = parseInt(adjustElement.value) || 0;
                
                let total = 0;
                if (product.inputType === 'boxes') {
                    total = (inputValue * product.bagsPerBox * product.unitsPerBag) + adjust;
                } else {
                    total = (inputValue * product.unitsPerBag) + adjust;
                }
                
                currentData[productId] = { input: inputValue, adjust, total };
                document.getElementById(`${productId}_total`).textContent = total;
            }
            
            updateShiftTotal();
        }

        // Extract numeric value from text
        function extractNumericValue(text) {
            if (!text || text.trim() === '') return 0;
            
            try {
                // Try to parse as number
                const simpleNumber = parseFloat(text.replace(',', '.'));
                if (!isNaN(simpleNumber)) return simpleNumber;
                
                // Common patterns
                const patterns = [
                    /(\d+)\s*sacos?\s*\+\s*(\d+)\s*\/\s*(\d+)/i,
                    /(\d+)\s*sacos?\s*\+\s*(\d+)/i,
                    /(\d+)\s*sacos?/i,
                    /(\d+)\s*\/\s*(\d+)/,
                    /(\d+)/
                ];
                
                for (const pattern of patterns) {
                    const match = text.match(pattern);
                    if (match) {
                        if (match[1] && match[2] && match[3]) {
                            return parseInt(match[1]) + (parseInt(match[2]) / parseInt(match[3]));
                        } else if (match[1] && match[2]) {
                            return parseInt(match[1]) + parseInt(match[2]);
                        } else if (match[1]) {
                            return parseInt(match[1]);
                        }
                    }
                }
                
                return 0;
            } catch (error) {
                console.error('Error extracting numeric value:', error);
                return 0;
            }
        }

        // Handle adjust button clicks
        function handleAdjustClick(e) {
            const productId = e.target.dataset.product;
            const action = e.target.dataset.action;
            
            const adjustInput = document.getElementById(`${productId}_adjust`);
            if (!adjustInput) return;
            
            let currentAdjust = parseInt(adjustInput.value) || 0;
            
            if (action === 'plus') {
                currentAdjust++;
            } else if (action === 'minus') {
                currentAdjust--;
            }
            
            adjustInput.value = currentAdjust;
            
            // Trigger input change
            const event = new Event('input');
            adjustInput.dispatchEvent(event);
        }

        // Update shift total
        function updateShiftTotal() {
            let total = 0;
            
            Object.keys(currentData).forEach(productId => {
                const product = PRODUCTS.find(p => p.id === productId);
                const item = currentData[productId];
                
                if (product.inputType === 'manual') {
                    total += item.numericTotal || 0;
                } else {
                    total += item.total || 0;
                }
            });
            
            document.getElementById('shiftTotal').textContent = total;
        }

        // ============================
        // CRUD OPERATIONS
        // ============================

        // CREATE - Save record
        async function handleSaveRecord() {
            if (!selectedShift) {
                showToast('Por favor, selecione um turno primeiro.', true);
                return;
            }

            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> A guardar...';
            
            try {
                const record = {
                    id: `${Date.now()}_${selectedShift}_${Math.random().toString(36).substr(2, 9)}`,
                    date: new Date().toLocaleDateString('pt-PT'),
                    shift: selectedShift,
                    username: currentUser,
                    created_at: new Date().toISOString(),
                    total_shift: 0
                };
                
                let totalShift = 0;
                
                PRODUCTS.forEach(product => {
                    const data = currentData[product.id];
                    
                    if (!data) return;
                    
                    if (product.inputType === 'manual') {
                        record[`${product.id}_manual`] = data.input || '';
                        record[`${product.id}_adjust`] = 0;
                        record[`${product.id}_total`] = data.input || '0';
                        totalShift += data.numericTotal || 0;
                    } else {
                        if (product.inputType === 'boxes') {
                            record[`${product.id}_boxes`] = data.input || 0;
                        } else {
                            record[`${product.id}_bags`] = data.input || 0;
                        }
                        
                        record[`${product.id}_adjust`] = data.adjust || 0;
                        record[`${product.id}_total`] = data.total || 0;
                        totalShift += data.total || 0;
                    }
                });
                
                record.total_shift = totalShift;
                
                console.log('💾 Saving record:', record);
                
                // Log activity
                logActivity('create_record', `Registo criado para turno ${selectedShift} com ${totalShift} peças`);
                
                // Add to records
                allRecords.unshift(record);
                saveRecordsToStorage();
                
                showToast('✅ Registo guardado com sucesso!');
                
                // Reset form
                resetRegistrationForm();
                
                // Refresh views
                if (document.getElementById('dashboardTab').classList.contains('active')) {
                    renderDashboard();
                }
                if (document.getElementById('manageTab').classList.contains('active')) {
                    renderAllRecords();
                }
                
            } catch (error) {
                console.error('❌ Error saving record:', error);
                showToast('❌ Erro ao guardar registo: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Guardar Registo';
            }
        }

        // Reset registration form
        function resetRegistrationForm() {
            document.getElementById('registrationForm').style.display = 'none';
            document.querySelectorAll('.shift-card').forEach(c => c.classList.remove('selected'));
            selectedShift = '';
            currentData = {};
        }

        // Handle cancel
        function handleCancel() {
            resetRegistrationForm();
        }

        // Handle tab switch
        function handleTabSwitch(tab) {
            showTab(tab.dataset.tab);
        }

        // ============================
        // READ OPERATIONS
        // ============================

        // View record details
        window.viewRecord = function(recordId) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) {
                showToast('Registo não encontrado!', true);
                return;
            }
            
            let html = `
                <div class="card" style="background: none; box-shadow: none; padding: 0;">
                    <div class="summary-grid">
                        <div class="summary-card">
                            <h3>Data</h3>
                            <div class="value">${record.date}</div>
                        </div>
                        <div class="summary-card">
                            <h3>Turno</h3>
                            <div class="value">
                                <span class="badge ${record.shift.toLowerCase() === 'tarde' ? 'badge-tarde' : 'badge-noite'}">
                                    ${record.shift}
                                </span>
                            </div>
                        </div>
                        <div class="summary-card">
                            <h3>Utilizador</h3>
                            <div class="value">${record.username}</div>
                        </div>
                        <div class="summary-card">
                            <h3>Total</h3>
                            <div class="value">${record.total_shift || 0}</div>
                            <div class="subtitle">peças</div>
                        </div>
                    </div>
                    
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Quantidade</th>
                                    <th>Total Peças</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            PRODUCTS.forEach(product => {
                let value = '';
                if (product.inputType === 'manual') {
                    value = record[`${product.id}_manual`] || '';
                } else if (product.inputType === 'boxes') {
                    const boxes = record[`${product.id}_boxes`] || 0;
                    value = `${boxes} caixa(s)`;
                } else {
                    const bags = record[`${product.id}_bags`] || 0;
                    value = `${bags} saco(s)`;
                }
                
                const total = record[`${product.id}_total`] || '-';
                
                html += `
                    <tr>
                        <td><strong>${product.name}</strong></td>
                        <td>${value}</td>
                        <td class="total-display">${total}</td>
                    </tr>`;
            });
            
            html += `</tbody></table></div>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--border-color);">
                        <h4><i class="fas fa-info-circle"></i> Informações Adicionais</h4>
                        <div style="font-size: 13px; color: var(--text-light); margin-top: 10px;">
                            <p><strong>Criado em:</strong> ${record.created_at ? new Date(record.created_at).toLocaleString('pt-PT') : 'N/A'}</p>
                            <p><strong>Última atualização:</strong> ${record.updated_at ? new Date(record.updated_at).toLocaleString('pt-PT') : 'N/A'}</p>
                            <p><strong>ID:</strong> <code>${record.id}</code></p>
                        </div>
                    </div>
                </div>`;
            
            document.getElementById('viewRecordDetails').innerHTML = html;
            document.getElementById('viewRecordModal').style.display = 'flex';
        }

        // Get filtered records
        function getRecords(filters = {}) {
            let filtered = [...allRecords];
            
            if (filters.date) {
                filtered = filtered.filter(r => r.date === filters.date);
            }
            
            if (filters.shift) {
                filtered = filtered.filter(r => r.shift === filters.shift);
            }
            
            if (filters.username) {
                const searchTerm = filters.username.toLowerCase();
                filtered = filtered.filter(r => r.username.toLowerCase().includes(searchTerm));
            }
            
            return filtered;
        }

        // Render dashboard
        function renderDashboard() {
            console.log('📈 Rendering dashboard...');
            
            const today = new Date().toLocaleDateString('pt-PT');
            const todayRecords = allRecords.filter(r => r.date === today);
            const todayProduction = todayRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
            const totalProduction = allRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
            const tardeTotal = allRecords.filter(r => r.shift === 'Tarde').reduce((sum, r) => sum + (r.total_shift || 0), 0);
            const noiteTotal = allRecords.filter(r => r.shift === 'Noite').reduce((sum, r) => sum + (r.total_shift || 0), 0);
            
            // Calculate averages
            const avgPerRecord = todayRecords.length > 0 ? Math.round(todayProduction / todayRecords.length) : 0;
            const mostProductiveShift = tardeTotal > noiteTotal ? 'Tarde' : (noiteTotal > tardeTotal ? 'Noite' : '-');
            const shiftProductivity = Math.max(tardeTotal, noiteTotal);
            
            // Calculate daily average
            const dates = [...new Set(allRecords.map(r => r.date))];
            const dailyAvg = dates.length > 0 ? Math.round(totalProduction / dates.length) : 0;
            
            // Update dashboard elements
            document.getElementById('todayProduction').textContent = todayProduction.toLocaleString();
            document.getElementById('todayRecords').textContent = `${todayRecords.length} registos`;
            document.getElementById('avgPerRecord').textContent = avgPerRecord.toLocaleString();
            document.getElementById('mostProductiveShift').textContent = mostProductiveShift;
            document.getElementById('shiftProductivity').textContent = `${shiftProductivity.toLocaleString()} peças`;
            document.getElementById('totalProduction').textContent = totalProduction.toLocaleString();
            document.getElementById('totalRecords').textContent = allRecords.length.toLocaleString();
            document.getElementById('tardeTotal').textContent = tardeTotal.toLocaleString();
            document.getElementById('noiteTotal').textContent = noiteTotal.toLocaleString();
            document.getElementById('dailyAvg').textContent = dailyAvg.toLocaleString();
            
            // Update goal progress
            const dailyGoal = 10000;
            const goalPercentage = Math.min(Math.round((todayProduction / dailyGoal) * 100), 100);
            document.getElementById('goalProgress').style.width = `${goalPercentage}%`;
            document.getElementById('goalPercentage').textContent = `${goalPercentage}%`;
            
            // Render charts and recent entries
            renderProductChart(todayRecords);
            renderRecentEntries();
        }

        // Render product chart
        function renderProductChart(records) {
            const chartContainer = document.getElementById('todayProductChart');
            chartContainer.innerHTML = '';
            
            if (records.length === 0) {
                chartContainer.innerHTML = `
                    <div class="empty-state" style="padding: 30px;">
                        <div class="empty-state-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <p>Sem dados para hoje</p>
                    </div>
                `;
                return;
            }
            
            // Calculate totals per product
            const productTotals = {};
            PRODUCTS.forEach(product => {
                productTotals[product.id] = records.reduce((sum, r) => {
                    const val = r[`${product.id}_total`];
                    if (typeof val === 'number') return sum + val;
                    if (typeof val === 'string' && val.trim() !== '') {
                        const num = extractNumericValue(val);
                        return sum + num;
                    }
                    return sum;
                }, 0);
            });
            
            // Find max value for scaling
            const maxValue = Math.max(...Object.values(productTotals));
            
            // Create chart bars
            PRODUCTS.forEach(product => {
                const value = productTotals[product.id];
                if (value > 0) {
                    const percentage = maxValue > 0 ? (value / maxValue) * 100 : 0;
                    
                    const bar = document.createElement('div');
                    bar.className = 'chart-bar';
                    
                    const fill = document.createElement('div');
                    fill.className = 'chart-fill';
                    fill.style.height = `${percentage}%`;
                    fill.setAttribute('data-value', value.toLocaleString());
                    
                    const label = document.createElement('div');
                    label.className = 'chart-label';
                    label.textContent = product.name;
                    label.title = product.name;
                    
                    bar.appendChild(fill);
                    bar.appendChild(label);
                    chartContainer.appendChild(bar);
                }
            });
            
            if (chartContainer.children.length === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; padding: 50px; color: var(--text-lighter);">Sem produção registada hoje</div>';
            }
        }

        // Render recent entries
        function renderRecentEntries() {
            const container = document.getElementById('recentEntries');
            
            if (!allRecords || allRecords.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <h3>Sem registos</h3>
                        <p>Comece por criar um registo na aba "Registo"</p>
                    </div>
                `;
                return;
            }
            
            const recentRecords = allRecords.slice(0, 10);
            
            let html = '<table class="report-table"><thead><tr>';
            html += '<th>Data</th><th>Hora</th><th>Turno</th><th>Utilizador</th>';
            html += '<th>Total</th><th class="no-print">Ações</th></tr></thead><tbody>';
            
            recentRecords.forEach(record => {
                const shiftClass = record.shift.toLowerCase();
                const time = record.created_at ? new Date(record.created_at).toLocaleTimeString('pt-PT', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }) : '--:--';
                
                html += `
                    <tr>
                        <td><strong>${record.date || 'N/A'}</strong></td>
                        <td>${time}</td>
                        <td>
                            <span class="badge ${shiftClass === 'tarde' ? 'badge-tarde' : 'badge-noite'}">
                                ${record.shift || 'N/A'}
                            </span>
                        </td>
                        <td>${record.username || 'N/A'}</td>
                        <td><strong>${record.total_shift || 0}</strong></td>
                        <td class="no-print">
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm" onclick="viewRecord('${record.id}')" title="Ver detalhes">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ============================
        // UPDATE OPERATIONS
        // ============================

        // Edit record
        window.editRecord = function(recordId) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) {
                showToast('Registo não encontrado!', true);
                return;
            }
            
            editingRecordId = recordId;
            
            let html = `
                <form id="editForm">
                    <div class="summary-grid" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="editDate">Data</label>
                            <input type="date" id="editDate" class="form-control" 
                                   value="${record.date.split('/').reverse().join('-')}" required>
                        </div>
                        <div class="form-group">
                            <label for="editShift">Turno</label>
                            <select id="editShift" class="form-control" required>
                                <option value="Tarde" ${record.shift === 'Tarde' ? 'selected' : ''}>Tarde</option>
                                <option value="Noite" ${record.shift === 'Noite' ? 'selected' : ''}>Noite</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editUsername">Utilizador</label>
                            <input type="text" id="editUsername" class="form-control" 
                                   value="${record.username}" required>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <strong><i class="fas fa-info-circle"></i> Atenção:</strong> 
                        Apenas administradores podem editar registos existentes.
                    </div>
                    
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Configuração</th>
                                    <th>Sacos/Caixas</th>
                                    <th>Total Peças</th>
                                </tr>
                            </thead>
                            <tbody id="editProductsTableBody"></tbody>
                        </table>
                    </div>
                    
                    <div class="action-buttons" style="margin-top: 30px;">
                        <button type="button" class="btn btn-primary" id="updateRecordBtn">
                            <i class="fas fa-save"></i> Atualizar Registo
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelEditBtn">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>`;
            
            document.getElementById('editRecordForm').innerHTML = html;
            document.getElementById('editRecordModal').style.display = 'flex';
            
            // Populate products table
            populateEditProductsTable(record);
            
            // Add event listeners
            document.getElementById('updateRecordBtn').addEventListener('click', handleUpdateRecord);
            document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);
        }

        // Populate edit products table
        function populateEditProductsTable(record) {
            const tbody = document.getElementById('editProductsTableBody');
            tbody.innerHTML = '';
            
            PRODUCTS.forEach(product => {
                const row = document.createElement('tr');
                
                if (product.inputType === 'manual') {
                    const manualValue = record[`${product.id}_manual`] || '';
                    row.innerHTML = `
                        <td><strong>${product.name}</strong></td>
                        <td style="font-size: 0.9rem; color: var(--text-light);">
                            Inserir total de peças manualmente
                        </td>
                        <td>
                            <div class="input-group">
                                <input type="text" 
                                       id="edit_${product.id}_manual" 
                                       value="${manualValue}" 
                                       class="form-control"
                                       placeholder="Ex: 150, 20/30, 8+1/2">
                            </div>
                        </td>
                        <td class="total-display">${manualValue || '-'}</td>
                    `;
                } else if (product.inputType === 'boxes') {
                    const boxesValue = record[`${product.id}_boxes`] || 0;
                    const totalValue = record[`${product.id}_total`] || 0;
                    row.innerHTML = `
                        <td><strong>${product.name}</strong></td>
                        <td style="font-size: 0.9rem; color: var(--text-light);">${product.configText}</td>
                        <td>
                            <div class="input-group">
                                <input type="number" 
                                       id="edit_${product.id}_boxes" 
                                       value="${boxesValue}" 
                                       class="form-control"
                                       min="0" step="1">
                            </div>
                        </td>
                        <td class="total-display">${totalValue}</td>
                    `;
                } else {
                    const bagsValue = record[`${product.id}_bags`] || 0;
                    const totalValue = record[`${product.id}_total`] || 0;
                    row.innerHTML = `
                        <td><strong>${product.name}</strong></td>
                        <td style="font-size: 0.9rem; color: var(--text-light);">
                            1 saco = ${product.unitsPerBag} unidades
                        </td>
                        <td>
                            <div class="input-group">
                                <input type="number" 
                                       id="edit_${product.id}_bags" 
                                       value="${bagsValue}" 
                                       class="form-control"
                                       min="0" step="1">
                            </div>
                        </td>
                        <td class="total-display">${totalValue}</td>
                    `;
                }
                
                tbody.appendChild(row);
            });
        }

        // Handle update record
        async function handleUpdateRecord() {
            if (!editingRecordId) {
                showToast('Nenhum registo selecionado para editar!', true);
                return;
            }

            const btn = document.getElementById('updateRecordBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> A atualizar...';
            
            try {
                const recordIndex = allRecords.findIndex(r => r.id === editingRecordId);
                if (recordIndex === -1) {
                    throw new Error('Registo não encontrado');
                }
                
                const record = allRecords[recordIndex];
                
                // Get form values
                const editDate = document.getElementById('editDate').value;
                const editShift = document.getElementById('editShift').value;
                const editUsername = document.getElementById('editUsername').value.trim();
                
                if (!editDate || !editShift || !editUsername) {
                    throw new Error('Preencha todos os campos obrigatórios');
                }
                
                // Convert date to Portuguese format
                const dateParts = editDate.split('-');
                const portugueseDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                
                // Update basic info
                record.date = portugueseDate;
                record.shift = editShift;
                record.username = editUsername;
                
                // Update product values
                let totalShift = 0;
                
                PRODUCTS.forEach(product => {
                    if (product.inputType === 'manual') {
                        const manualValue = document.getElementById(`edit_${product.id}_manual`).value.trim();
                        record[`${product.id}_manual`] = manualValue;
                        record[`${product.id}_adjust`] = 0;
                        record[`${product.id}_total`] = manualValue;
                        
                        const numericValue = extractNumericValue(manualValue);
                        totalShift += numericValue;
                    } else if (product.inputType === 'boxes') {
                        const boxesValue = parseInt(document.getElementById(`edit_${product.id}_boxes`).value) || 0;
                        record[`${product.id}_boxes`] = boxesValue;
                        record[`${product.id}_adjust`] = 0;
                        
                        const total = boxesValue * product.bagsPerBox * product.unitsPerBag;
                        record[`${product.id}_total`] = total;
                        totalShift += total;
                    } else {
                        const bagsValue = parseInt(document.getElementById(`edit_${product.id}_bags`).value) || 0;
                        record[`${product.id}_bags`] = bagsValue;
                        record[`${product.id}_adjust`] = 0;
                        
                        const total = bagsValue * product.unitsPerBag;
                        record[`${product.id}_total`] = total;
                        totalShift += total;
                    }
                });
                
                record.total_shift = totalShift;
                record.updated_at = new Date().toISOString();
                
                // Log activity
                logActivity('update_record', `Registo ${editingRecordId} atualizado`);
                
                // Update record
                allRecords[recordIndex] = record;
                saveRecordsToStorage();
                
                showToast('✅ Registo atualizado com sucesso!');
                
                // Close modal and refresh
                closeEditModal();
                refreshViews();
                
            } catch (error) {
                console.error('❌ Error updating record:', error);
                showToast('❌ Erro ao atualizar registo: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Atualizar Registo';
            }
        }

        // ============================
        // DELETE OPERATIONS
        // ============================

        // Delete record
        window.deleteRecord = async function(recordId) {
            if (!confirm('Tem certeza que deseja eliminar este registo?\nEsta ação não pode ser desfeita.')) {
                return;
            }

            try {
                const recordIndex = allRecords.findIndex(r => r.id === recordId);
                if (recordIndex === -1) {
                    throw new Error('Registo não encontrado');
                }
                
                const record = allRecords[recordIndex];
                
                // Log activity
                logActivity('delete_record', `Registo ${recordId} eliminado`);
                
                // Delete record
                allRecords.splice(recordIndex, 1);
                saveRecordsToStorage();
                
                showToast('✅ Registo eliminado com sucesso!');
                
                // Refresh views
                refreshViews();
                
            } catch (error) {
                console.error('❌ Error deleting record:', error);
                showToast('❌ Erro ao eliminar registo: ' + error.message, true);
            }
        }

        // ============================
        // REPORT SYSTEM
        // ============================

        // Handle generate report
        function handleGenerateReport() {
            const reportType = document.getElementById('reportType').value;
            const shiftFilter = document.getElementById('shiftFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            console.log('📄 Generating report:', { reportType, shiftFilter, startDate, endDate });
            
            if (!startDate || !endDate) {
                showToast('Por favor, selecione as datas', true);
                return;
            }
            
            // Generate report
            currentReportData = generateReportData(reportType, shiftFilter, startDate, endDate);
            
            if (currentReportData.filteredRecords.length === 0) {
                document.getElementById('reportResults').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3>Sem dados no período</h3>
                        <p>Tente outro intervalo de datas ou filtro de turno</p>
                    </div>
                `;
                document.getElementById('reportActions').style.display = 'none';
                return;
            }
            
            // Display report
            displayReport(currentReportData);
            
            // Show export buttons
            document.getElementById('reportActions').style.display = 'flex';
            
            // Log activity
            logActivity('generate_report', `Relatório ${reportType} gerado para ${startDate} a ${endDate}`);
        }

        // Generate report data
        function generateReportData(reportType, shiftFilter, startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            
            const filteredRecords = allRecords.filter(record => {
                const recordDate = parsePortugueseDate(record.date);
                const dateMatch = recordDate >= start && recordDate <= end;
                const shiftMatch = shiftFilter === 'all' || record.shift === shiftFilter;
                return dateMatch && shiftMatch;
            });
            
            return {
                reportType,
                shiftFilter,
                startDate,
                endDate,
                filteredRecords,
                generatedBy: currentUser,
                generationTime: new Date().toISOString()
            };
        }

        // Parse Portuguese date
        function parsePortugueseDate(dateStr) {
            try {
                if (!dateStr) return new Date();
                
                if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        return new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                }
                
                return new Date(dateStr);
            } catch (error) {
                return new Date();
            }
        }

        // Display report
        function displayReport(reportData) {
            let html = '';
            
            if (reportData.reportType === 'shift') {
                html = generateShiftReport(reportData);
            } else if (reportData.reportType === 'comparative') {
                html = generateComparativeReport(reportData);
            } else {
                html = generateDailyReport(reportData);
            }
            
            document.getElementById('reportResults').innerHTML = html;
        }

        // Generate daily report
        function generateDailyReport(reportData) {
            const { filteredRecords, startDate, endDate, shiftFilter } = reportData;
            
            // Group by date
            const recordsByDate = {};
            filteredRecords.forEach(record => {
                if (!recordsByDate[record.date]) {
                    recordsByDate[record.date] = [];
                }
                recordsByDate[record.date].push(record);
            });
            
            // Sort dates
            const sortedDates = Object.keys(recordsByDate).sort((a, b) => {
                return parsePortugueseDate(b) - parsePortugueseDate(a);
            });
            
            let html = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-file-alt"></i> Relatório Diário
                        </h3>
                        <div style="color: var(--text-light); font-size: 14px;">
                            ${startDate} a ${endDate} | ${shiftFilter === 'all' ? 'Todos os turnos' : 'Turno ' + shiftFilter}
                        </div>
                    </div>
                    
                    <div class="table-container" style="margin-top: 20px;">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Turno</th>
                                    <th>Utilizador</th>
                                    <th>Filetes</th>
                                    <th>Minis</th>
                                    <th>Zingers</th>
                                    <th>Pedaços</th>
                                    <th>Asas</th>
                                    <th>Filetes Value</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            let grandTotal = 0;
            let productTotals = {
                filetes: 0, minis: 0, zingers: 0, 
                pedacos: 0, asas: 0, filetes_value: 0
            };
            
            sortedDates.forEach(date => {
                const dateRecords = recordsByDate[date];
                const dateTotal = dateRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
                grandTotal += dateTotal;
                
                // Add date header
                html += `
                    <tr style="background: #f8f9fa;">
                        <td colspan="10" style="font-weight: bold; color: var(--primary-red);">
                            <i class="fas fa-calendar"></i> ${date} - Total: ${dateTotal.toLocaleString()} peças
                        </td>
                    </tr>`;
                
                // Add records for this date
                dateRecords.forEach(record => {
                    // Update product totals
                    PRODUCTS.forEach(product => {
                        const total = record[`${product.id}_total`];
                        if (typeof total === 'number') {
                            productTotals[product.id] += total;
                        } else if (typeof total === 'string' && total.trim() !== '') {
                            const num = extractNumericValue(total);
                            productTotals[product.id] += num;
                        }
                    });
                    
                    html += `
                        <tr>
                            <td></td>
                            <td>
                                <span class="badge ${record.shift.toLowerCase() === 'tarde' ? 'badge-tarde' : 'badge-noite'}">
                                    ${record.shift}
                                </span>
                            </td>
                            <td>${record.username}</td>`;
                    
                    // Product columns
                    const productsToShow = ['filetes', 'minis', 'zingers', 'pedacos', 'asas', 'filetes_value'];
                    productsToShow.forEach(productId => {
                        const totalValue = record[`${productId}_total`];
                        html += `<td>${totalValue !== undefined && totalValue !== null && totalValue !== '' && totalValue !== 0 ? totalValue : '-'}</td>`;
                    });
                    
                    html += `<td><strong>${record.total_shift || 0}</strong></td></tr>`;
                });
            });
            
            // Add totals row
            html += `
                <tr class="totals-row">
                    <td colspan="3"><strong>TOTAIS:</strong></td>
                    <td><strong>${productTotals.filetes.toLocaleString()}</strong></td>
                    <td><strong>${productTotals.minis.toLocaleString()}</strong></td>
                    <td><strong>${productTotals.zingers.toLocaleString()}</strong></td>
                    <td><strong>${productTotals.pedacos.toLocaleString()}</strong></td>
                    <td><strong>${productTotals.asas.toLocaleString()}</strong></td>
                    <td><strong>${productTotals.filetes_value.toLocaleString()}</strong></td>
                    <td><strong>${grandTotal.toLocaleString()}</strong></td>
                </tr>`;
            
            html += `</tbody></table></div>`;
            
            // Add summary
            html += `
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--border-color);">
                    <div class="summary-grid">
                        <div class="summary-card">
                            <h3>Período</h3>
                            <div class="value">${sortedDates.length}</div>
                            <div class="subtitle">dias</div>
                        </div>
                        <div class="summary-card">
                            <h3>Registos</h3>
                            <div class="value">${filteredRecords.length}</div>
                            <div class="subtitle">total</div>
                        </div>
                        <div class="summary-card">
                            <h3>Produção</h3>
                            <div class="value">${grandTotal.toLocaleString()}</div>
                            <div class="subtitle">peças</div>
                        </div>
                        <div class="summary-card">
                            <h3>Média Diária</h3>
                            <div class="value">${sortedDates.length > 0 ? Math.round(grandTotal / sortedDates.length).toLocaleString() : '0'}</div>
                            <div class="subtitle">peças/dia</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; font-size: 12px; color: var(--text-light); text-align: center;">
                        <p><i class="fas fa-user"></i> Gerado por: ${currentUser} | 
                           <i class="fas fa-clock"></i> ${new Date().toLocaleString('pt-PT')}</p>
                    </div>
                </div>
            </div>`;
            
            return html;
        }

        // Generate shift report
        function generateShiftReport(reportData) {
            const { filteredRecords, startDate, endDate, shiftFilter } = reportData;
            
            // Group by shift
            const tardeRecords = filteredRecords.filter(r => r.shift === 'Tarde');
            const noiteRecords = filteredRecords.filter(r => r.shift === 'Noite');
            
            let html = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-clock"></i> Relatório por Turno
                        </h3>
                        <div style="color: var(--text-light); font-size: 14px;">
                            ${startDate} a ${endDate} | ${shiftFilter === 'all' ? 'Todos os turnos' : 'Turno ' + shiftFilter}
                        </div>
                    </div>
                    
                    <div class="summary-grid" style="margin-bottom: 30px;">
                        <div class="summary-card">
                            <h3>Turno Tarde</h3>
                            <div class="value">${tardeRecords.length}</div>
                            <div class="subtitle">registos</div>
                        </div>
                        <div class="summary-card">
                            <h3>Turno Noite</h3>
                            <div class="value">${noiteRecords.length}</div>
                            <div class="subtitle">registos</div>
                        </div>
                        <div class="summary-card">
                            <h3>Total Tarde</h3>
                            <div class="value">${tardeRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0).toLocaleString()}</div>
                            <div class="subtitle">peças</div>
                        </div>
                        <div class="summary-card">
                            <h3>Total Noite</h3>
                            <div class="value">${noiteRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0).toLocaleString()}</div>
                            <div class="subtitle">peças</div>
                        </div>
                    </div>`;
            
            // Show each shift table if requested
            if (shiftFilter === 'all' || shiftFilter === 'Tarde') {
                html += generateShiftTable('Tarde', tardeRecords);
            }
            
            if (shiftFilter === 'all' || shiftFilter === 'Noite') {
                html += generateShiftTable('Noite', noiteRecords);
            }
            
            html += `
                <div style="margin-top: 30px; font-size: 12px; color: var(--text-light); text-align: center;">
                    <p><i class="fas fa-user"></i> Gerado por: ${currentUser} | 
                       <i class="fas fa-clock"></i> ${new Date().toLocaleString('pt-PT')}</p>
                </div>
            </div>`;
            
            return html;
        }

        // Generate shift table
        function generateShiftTable(shiftName, records) {
            if (records.length === 0) return '';
            
            let html = `
                <div style="margin-top: 30px;">
                    <h4 style="color: var(--text-dark); margin-bottom: 15px;">
                        <i class="fas ${shiftName === 'Tarde' ? 'fa-sun' : 'fa-moon'}"></i> 
                        Turno ${shiftName}
                    </h4>
                    <div class="table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Utilizador</th>
                                    <th>Filetes</th>
                                    <th>Minis</th>
                                    <th>Zingers</th>
                                    <th>Pedaços</th>
                                    <th>Asas</th>
                                    <th>Filetes Value</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            records.forEach(record => {
                html += `
                    <tr>
                        <td>${record.date}</td>
                        <td>${record.username}</td>`;
                
                const productsToShow = ['filetes', 'minis', 'zingers', 'pedacos', 'asas', 'filetes_value'];
                productsToShow.forEach(productId => {
                    const totalValue = record[`${productId}_total`];
                    html += `<td>${totalValue !== undefined && totalValue !== null && totalValue !== '' && totalValue !== 0 ? totalValue : '-'}</td>`;
                });
                
                html += `<td><strong>${record.total_shift || 0}</strong></td></tr>`;
            });
            
            // Add totals
            const shiftTotal = records.reduce((sum, r) => sum + (r.total_shift || 0), 0);
            html += `
                <tr class="totals-row">
                    <td colspan="8"><strong>TOTAL ${shiftName}:</strong></td>
                    <td><strong>${shiftTotal.toLocaleString()}</strong></td>
                </tr>`;
            
            html += `</tbody></table></div></div>`;
            
            return html;
        }

        // Generate comparative report
        function generateComparativeReport(reportData) {
            const { filteredRecords, startDate, endDate } = reportData;
            
            // Group by date and shift
            const dailyData = {};
            filteredRecords.forEach(record => {
                if (!dailyData[record.date]) {
                    dailyData[record.date] = { tarde: 0, noite: 0, total: 0 };
                }
                dailyData[record.date][record.shift.toLowerCase()] += record.total_shift || 0;
                dailyData[record.date].total += record.total_shift || 0;
            });
            
            // Sort dates
            const sortedDates = Object.keys(dailyData).sort((a, b) => {
                return parsePortugueseDate(b) - parsePortugueseDate(a);
            });
            
            let html = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-line"></i> Relatório Comparativo
                        </h3>
                        <div style="color: var(--text-light); font-size: 14px;">
                            ${startDate} a ${endDate}
                        </div>
                    </div>
                    
                    <div class="table-container" style="margin-top: 20px;">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Turno Tarde</th>
                                    <th>Turno Noite</th>
                                    <th>Total Dia</th>
                                    <th>Diferença</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            let tardeTotal = 0;
            let noiteTotal = 0;
            
            sortedDates.forEach(date => {
                const data = dailyData[date];
                tardeTotal += data.tarde;
                noiteTotal += data.noite;
                
                const difference = data.tarde - data.noite;
                const diffClass = difference > 0 ? 'badge-success' : (difference < 0 ? 'badge-danger' : '');
                const diffText = difference > 0 ? `+${difference}` : difference;
                
                html += `
                    <tr>
                        <td><strong>${date}</strong></td>
                        <td>${data.tarde.toLocaleString()}</td>
                        <td>${data.noite.toLocaleString()}</td>
                        <td><strong>${data.total.toLocaleString()}</strong></td>
                        <td><span class="badge ${diffClass}">${diffText}</span></td>
                    </tr>`;
            });
            
            // Add totals
            const grandTotal = tardeTotal + noiteTotal;
            const totalDifference = tardeTotal - noiteTotal;
            const totalDiffClass = totalDifference > 0 ? 'badge-success' : (totalDifference < 0 ? 'badge-danger' : '');
            const totalDiffText = totalDifference > 0 ? `+${totalDifference}` : totalDifference;
            
            html += `
                <tr class="totals-row">
                    <td><strong>TOTAIS</strong></td>
                    <td><strong>${tardeTotal.toLocaleString()}</strong></td>
                    <td><strong>${noiteTotal.toLocaleString()}</strong></td>
                    <td><strong>${grandTotal.toLocaleString()}</strong></td>
                    <td><span class="badge ${totalDiffClass}">${totalDiffText}</span></td>
                </tr>`;
            
            html += `</tbody></table></div>`;
            
            // Add summary statistics
            const avgTarde = sortedDates.length > 0 ? Math.round(tardeTotal / sortedDates.length) : 0;
            const avgNoite = sortedDates.length > 0 ? Math.round(noiteTotal / sortedDates.length) : 0;
            
            html += `
                <div style="margin-top: 30px;">
                    <div class="summary-grid">
                        <div class="summary-card">
                            <h3>Média Tarde</h3>
                            <div class="value">${avgTarde.toLocaleString()}</div>
                            <div class="subtitle">peças/dia</div>
                        </div>
                        <div class="summary-card">
                            <h3>Média Noite</h3>
                            <div class="value">${avgNoite.toLocaleString()}</div>
                            <div class="subtitle">peças/dia</div>
                        </div>
                        <div class="summary-card">
                            <h3>Dias Analisados</h3>
                            <div class="value">${sortedDates.length}</div>
                            <div class="subtitle">dias úteis</div>
                        </div>
                        <div class="summary-card">
                            <h3>Produtividade</h3>
                            <div class="value">${tardeTotal > noiteTotal ? 'Tarde' : 'Noite'}</div>
                            <div class="subtitle">turno mais produtivo</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; font-size: 12px; color: var(--text-light); text-align: center;">
                        <p><i class="fas fa-user"></i> Gerado por: ${currentUser} | 
                           <i class="fas fa-clock"></i> ${new Date().toLocaleString('pt-PT')}</p>
                    </div>
                </div>
            </div>`;
            
            return html;
        }

        // ============================
        // EXPORT FUNCTIONS
        // ============================

        // Handle print daily report
        function handlePrintDailyReport() {
            console.log('🖨️ Printing daily report...');
            
            if (!currentReportData) {
                showToast('Gere um relatório primeiro', true);
                return;
            }
            
            // Create print version
            const printWindow = window.open('', '_blank');
            const printContent = document.getElementById('reportResults').innerHTML;
            
            const printHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Relatório KFC - ${new Date().toLocaleDateString('pt-PT')}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #e30613; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th { background: #e30613; color: white; padding: 10px; text-align: left; }
                        td { padding: 8px; border-bottom: 1px solid #ddd; }
                        .totals-row { background: #f8f9fa; font-weight: bold; }
                        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
                        .badge-tarde { background: #ffc107; }
                        .badge-noite { background: #17a2b8; color: white; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none !important; }
                        }
                    </style>
                </head>
                <body>
                    <h1>KFC Kitchen Manager - Relatório de Produção</h1>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <p><strong>Período:</strong> ${currentReportData.startDate} a ${currentReportData.endDate}</p>
                        <p><strong>Gerado por:</strong> ${currentUser}</p>
                        <p><strong>Data:</strong> ${new Date().toLocaleString('pt-PT')}</p>
                    </div>
                    ${printContent}
                </body>
                </html>`;
            
            printWindow.document.write(printHtml);
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // Handle export to PDF
        async function handleExportPDF() {
            const btn = document.getElementById('exportPdfBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> A gerar PDF...';
            
            try {
                await exportToPDF();
                showToast('✅ PDF gerado com sucesso!');
            } catch (error) {
                console.error('❌ Error generating PDF:', error);
                showToast('❌ Erro ao gerar PDF: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-file-pdf"></i> Exportar PDF';
            }
        }

        // Export to PDF using jsPDF
        async function exportToPDF() {
            return new Promise((resolve, reject) => {
                try {
                    if (!currentReportData) {
                        reject(new Error('Nenhum relatório para exportar'));
                        return;
                    }
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Add title
                    doc.setFontSize(20);
                    doc.setTextColor(227, 6, 19);
                    doc.text('KFC Kitchen Manager - Relatório', 105, 15, { align: 'center' });
                    
                    // Add metadata
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Período: ${currentReportData.startDate} a ${currentReportData.endDate}`, 14, 25);
                    doc.text(`Gerado por: ${currentUser}`, 14, 30);
                    doc.text(`Data: ${new Date().toLocaleString('pt-PT')}`, 14, 35);
                    
                    // Add report content
                    let y = 45;
                    
                    if (currentReportData.reportType === 'daily') {
                        generateDailyPDF(doc, currentReportData, y);
                    } else if (currentReportData.reportType === 'shift') {
                        generateShiftPDF(doc, currentReportData, y);
                    } else {
                        generateComparativePDF(doc, currentReportData, y);
                    }
                    
                    // Save PDF
                    doc.save(`relatorio_kfc_${new Date().toISOString().split('T')[0]}.pdf`);
                    resolve();
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Generate daily PDF
        function generateDailyPDF(doc, reportData, startY) {
            const { filteredRecords } = reportData;
            
            // Create table data
            const tableData = filteredRecords.map(record => [
                record.date,
                record.shift,
                record.username,
                record.filetes_total || '-',
                record.minis_total || '-',
                record.zingers_total || '-',
                record.pedacos_total || '-',
                record.asas_total || '-',
                record.filetes_value_total || '-',
                record.total_shift || 0
            ]);
            
            // Add table
            doc.autoTable({
                startY: startY,
                head: [['Data', 'Turno', 'Utilizador', 'Filetes', 'Minis', 'Zingers', 'Pedaços', 'Asas', 'Filetes V', 'Total']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [227, 6, 19] }
            });
        }

        // Handle export to Excel
        async function handleExportExcel() {
            const btn = document.getElementById('exportExcelBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> A gerar Excel...';
            
            try {
                await exportToExcel();
                showToast('✅ Excel gerado com sucesso!');
            } catch (error) {
                console.error('❌ Error generating Excel:', error);
                showToast('❌ Erro ao gerar Excel: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-file-excel"></i> Exportar Excel';
            }
        }

        // Export to Excel
        function exportToExcel() {
            return new Promise((resolve, reject) => {
                try {
                    if (!currentReportData) {
                        reject(new Error('Nenhum relatório para exportar'));
                        return;
                    }
                    
                    const { filteredRecords } = currentReportData;
                    
                    // Create CSV content
                    let csv = 'Data,Turno,Utilizador,Filetes,Minis,Zingers,Pedaços,Asas,Filetes Value,Total\n';
                    
                    filteredRecords.forEach(record => {
                        const row = [
                            `"${record.date}"`,
                            `"${record.shift}"`,
                            `"${record.username}"`,
                            record.filetes_total || '0',
                            record.minis_total || '0',
                            record.zingers_total || '0',
                            record.pedacos_total || '0',
                            record.asas_total || '0',
                            record.filetes_value_total || '0',
                            record.total_shift || '0'
                        ];
                        csv += row.join(',') + '\n';
                    });
                    
                    // Create download link
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', `relatorio_kfc_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    resolve();
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Handle report type change
        function handleReportTypeChange(e) {
            const shiftFilterGroup = document.getElementById('shiftFilterGroup');
            if (e.target.value === 'shift') {
                shiftFilterGroup.style.display = 'block';
            } else {
                shiftFilterGroup.style.display = 'none';
            }
        }

        // ============================
        // MANAGE RECORDS
        // ============================

        // Handle search records
        function handleSearchRecords() {
            const searchDate = document.getElementById('searchDate').value;
            const searchShift = document.getElementById('searchShift').value;
            const searchUser = document.getElementById('searchUser').value.trim();
            
            const filters = {};
            
            if (searchDate) {
                const dateParts = searchDate.split('-');
                filters.date = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
            }
            
            if (searchShift) {
                filters.shift = searchShift;
            }
            
            if (searchUser) {
                filters.username = searchUser;
            }
            
            renderAllRecords(filters);
        }

        // Render all records
        function renderAllRecords(filters = {}) {
            const filteredRecords = getRecords(filters);
            const container = document.getElementById('allRecordsList');
            const countElement = document.getElementById('totalRecordsCount');
            
            countElement.textContent = filteredRecords.length;
            
            if (filteredRecords.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3>Nenhum registo encontrado</h3>
                        <p>Tente alterar os filtros de pesquisa</p>
                    </div>
                `;
                return;
            }
            
            let html = '<table class="report-table"><thead><tr>';
            html += '<th>Data</th><th>Turno</th><th>Utilizador</th>';
            html += '<th>Filetes</th><th>Minis</th><th>Zingers</th><th>Pedaços</th><th>Asas</th><th>Filetes Value</th>';
            html += '<th>Total</th><th class="no-print">Ações</th></tr></thead><tbody>';
            
            filteredRecords.forEach(record => {
                const shiftClass = record.shift.toLowerCase();
                
                html += `<tr>
                    <td><strong>${record.date || 'N/A'}</strong></td>
                    <td>
                        <span class="badge ${shiftClass === 'tarde' ? 'badge-tarde' : 'badge-noite'}">
                            ${record.shift || 'N/A'}
                        </span>
                    </td>
                    <td>${record.username || 'N/A'}</td>`;
                
                // Product columns
                const productsToShow = ['filetes', 'minis', 'zingers', 'pedacos', 'asas', 'filetes_value'];
                productsToShow.forEach(productId => {
                    const totalValue = record[`${productId}_total`];
                    html += `<td>${totalValue !== undefined && totalValue !== null && totalValue !== '' && totalValue !== 0 ? totalValue : '-'}</td>`;
                });
                
                html += `<td><strong>${record.total_shift || 0}</strong></td>`;
                
                // Action buttons
                html += `<td class="no-print">
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm" onclick="viewRecord('${record.id}')" title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="editRecord('${record.id}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRecord('${record.id}')" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Handle reset search
        function handleResetSearch() {
            document.getElementById('searchDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('searchShift').value = '';
            document.getElementById('searchUser').value = '';
            
            renderAllRecords();
        }

        // ============================
        // UTILITY FUNCTIONS
        // ============================

        // Refresh all views
        function refreshViews() {
            if (document.getElementById('dashboardTab').classList.contains('active')) {
                renderDashboard();
            }
            if (document.getElementById('manageTab').classList.contains('active')) {
                renderAllRecords();
            }
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editRecordModal').style.display = 'none';
            editingRecordId = null;
        }

        // Close view modal
        function closeViewModal() {
            document.getElementById('viewRecordModal').style.display = 'none';
        }

        // Show toast notification
        function showToast(message, isError = false, isWarning = false, isInfo = false) {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            let className = 'toast';
            let icon = 'fas fa-check-circle';
            
            if (isError) {
                className += ' error';
                icon = 'fas fa-exclamation-circle';
            } else if (isWarning) {
                className += ' warning';
                icon = 'fas fa-exclamation-triangle';
            } else if (isInfo) {
                className += ' info';
                icon = 'fas fa-info-circle';
            }
            
            toast.className = className;
            toast.innerHTML = `
                <i class="${icon}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        // Test function
        window.testApp = function() {
            console.log('=== APP STATUS ===');
            console.log('Current user:', currentUser);
            console.log('Selected shift:', selectedShift);
            console.log('Total records:', allRecords.length);
            console.log('Active tab:', document.querySelector('.nav-tab.active')?.dataset.tab);
            console.log('=== END STATUS ===');
        };

        // Make functions available globally
        window.viewRecord = viewRecord;
        window.editRecord = editRecord;
        window.deleteRecord = deleteRecord;
    </script>
</body>
</html>
