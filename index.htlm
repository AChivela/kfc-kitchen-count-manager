<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KFC Kitchen Count Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e30613 0%, #8b0000 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            min-height: 100vh;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
        }

        /* Login Screen */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            text-align: center;
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: #e30613;
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .login-header p {
            color: #666;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #444;
            font-weight: 600;
            font-size: 15px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #e30613;
            box-shadow: 0 0 0 3px rgba(227, 6, 19, 0.1);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: #e30613;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #b8050f;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(227, 6, 19, 0.3);
        }

        /* Main App */
        #mainApp {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background: #e30613;
            color: white;
            padding: 20px 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Navigation */
        .nav-tabs {
            background: white;
            display: flex;
            gap: 5px;
            padding: 0 30px;
            border-bottom: 2px solid #eee;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 18px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            white-space: nowrap;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-tab:hover {
            color: #e30613;
            background: #f9f9f9;
        }

        .nav-tab.active {
            color: #e30613;
            border-bottom-color: #e30613;
            background: #fff5f5;
            font-weight: 600;
        }

        /* Content */
        .content {
            flex: 1;
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Shift Selector */
        .shift-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .shift-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            text-align: center;
        }

        .shift-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(227, 6, 19, 0.15);
            border-color: #e30613;
        }

        .shift-card.selected {
            border-color: #e30613;
            background: #fff5f5;
        }

        .shift-card h3 {
            color: #e30613;
            font-size: 22px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .shift-card p {
            color: #666;
            font-size: 15px;
        }

        /* Registration Form */
        #registrationForm {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            font-size: 15px;
        }

        .info-box strong {
            color: #856404;
        }

        /* Products Table */
        .products-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .products-table table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        .products-table th {
            background: #e30613;
            color: white;
            padding: 18px;
            text-align: left;
            font-weight: 600;
            font-size: 15px;
        }

        .products-table td {
            padding: 18px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        .products-table tr:last-child td {
            border-bottom: none;
        }

        .products-table tbody tr:hover {
            background: #f9f9f9;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #e30613;
        }

        .adjust-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .adjust-btn.plus {
            background: #28a745;
            color: white;
        }

        .adjust-btn.plus:hover {
            background: #218838;
        }

        .adjust-btn.minus {
            background: #dc3545;
            color: white;
        }

        .adjust-btn.minus:hover {
            background: #c82333;
        }

        .total-display {
            font-weight: 700;
            color: #e30613;
            font-size: 16px;
        }

        /* Summary Cards */
        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .summary-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-card .value {
            color: #e30613;
            font-size: 36px;
            font-weight: 700;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* Reports */
        .report-filters {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .report-table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        .report-table th {
            background: #e30613;
            color: white;
            padding: 18px;
            text-align: left;
            font-weight: 600;
        }

        .report-table td {
            padding: 16px 18px;
            border-bottom: 1px solid #eee;
        }

        .shift-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .shift-badge.tarde {
            background: #ffc107;
            color: #000;
        }

        .shift-badge.noite {
            background: #17a2b8;
            color: white;
        }

        .totals-row {
            background: #f8f9fa !important;
            font-weight: 700;
        }

        .totals-row td {
            color: #e30613;
            font-size: 16px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #28a745;
            color: white;
            padding: 16px 24px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }

        .toast.error {
            background: #dc3545;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 22px;
            margin-bottom: 15px;
            color: #666;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .user-info {
                width: 100%;
                justify-content: space-between;
            }
            
            .nav-tabs {
                padding: 0 15px;
            }
            
            .nav-tab {
                padding: 15px;
                font-size: 14px;
            }
            
            .shift-selector {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .products-table,
            .report-table-container {
                margin: 0 -20px;
                border-radius: 0;
            }
        }

        @media (max-width: 480px) {
            .login-container {
                padding: 30px 20px;
            }
            
            .products-table th,
            .products-table td,
            .report-table th,
            .report-table td {
                padding: 12px;
            }
            
            .adjust-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="login-container">
                <div class="login-header">
                    <h2><i class="fas fa-drumstick-bite"></i> KFC Kitchen Count Manager</h2>
                    <p>Sistema de Contagem de Produ√ß√£o</p>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username"><i class="fas fa-user"></i> Nome de Utilizador</label>
                        <input type="text" id="username" required placeholder="Digite seu nome">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" style="display: none;">
            <header class="header">
                <div class="header-top">
                    <h1><i class="fas fa-drumstick-bite"></i> KFC Kitchen Count Manager</h1>
                    <div class="user-info">
                        <span class="user-name"><i class="fas fa-user"></i> <span id="currentUser">Utilizador</span></span>
                        <button class="logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </button>
                    </div>
                </div>
            </header>
            
            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="register">
                    <i class="fas fa-edit"></i> Registo
                </button>
                <button class="nav-tab" data-tab="reports">
                    <i class="fas fa-chart-bar"></i> Relat√≥rios
                </button>
                <button class="nav-tab" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
            </nav>
            
            <main class="content">
                <!-- Register Tab -->
                <div id="registerTab" class="tab-content active">
                    <div class="shift-selector">
                        <div class="shift-card" data-shift="Tarde">
                            <h3><i class="fas fa-sun"></i> Turno da Tarde</h3>
                            <p>Registo de produ√ß√£o do turno da tarde</p>
                        </div>
                        <div class="shift-card" data-shift="Noite">
                            <h3><i class="fas fa-moon"></i> Turno da Noite</h3>
                            <p>Registo de produ√ß√£o do turno da noite</p>
                        </div>
                    </div>
                    <div id="registrationForm" style="display: none;">
                        <h2 style="margin-bottom: 25px; color: #333;">Registo - Turno: <span id="selectedShift" style="color: #e30613;"></span></h2>
                        <div class="info-box">
                            <strong><i class="fas fa-info-circle"></i> Aten√ß√£o:</strong> Para <strong>Peda√ßos</strong>, insira o total de pe√ßas manualmente. Para Asas e Filetes Value, insira o n√∫mero de <strong>caixas</strong>. O sistema calcula automaticamente.
                        </div>
                        <div class="products-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Configura√ß√£o</th>
                                        <th>Sacos/Caixas</th>
                                        <th>Ajustes (unidades)</th>
                                        <th>Total Pe√ßas</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody"></tbody>
                            </table>
                        </div>
                        <div class="dashboard-grid">
                            <div class="summary-card">
                                <h3>Total do Turno</h3>
                                <div class="value" id="shiftTotal">0</div>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="saveBtn">
                                <i class="fas fa-save"></i> Guardar Registo
                            </button>
                            <button class="btn btn-secondary" id="cancelBtn">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reportsTab" class="tab-content">
                    <div class="report-filters">
                        <h2 style="margin-bottom: 25px; color: #333;"><i class="fas fa-chart-bar"></i> Gerar Relat√≥rios</h2>
                        <div class="filter-row">
                            <div class="form-group">
                                <label for="reportType"><i class="fas fa-chart-pie"></i> Tipo de Relat√≥rio</label>
                                <select id="reportType">
                                    <option value="daily">Di√°rio</option>
                                    <option value="shift">Por Turno</option>
                                    <option value="weekly">Semanal</option>
                                    <option value="monthly">Mensal</option>
                                </select>
                            </div>
                            <div class="form-group" id="shiftFilterGroup" style="display: none;">
                                <label for="shiftFilter"><i class="fas fa-clock"></i> Filtrar Turno</label>
                                <select id="shiftFilter">
                                    <option value="all">Todos</option>
                                    <option value="Tarde">Tarde</option>
                                    <option value="Noite">Noite</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="startDate"><i class="fas fa-calendar-alt"></i> Data In√≠cio</label>
                                <input type="date" id="startDate">
                            </div>
                            <div class="form-group">
                                <label for="endDate"><i class="fas fa-calendar-alt"></i> Data Fim</label>
                                <input type="date" id="endDate">
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" id="generateReportBtn">
                                    <i class="fas fa-chart-bar"></i> Gerar Relat√≥rio
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="reportResults"></div>
                    <div class="action-buttons" id="reportActions" style="display: none;">
                        <button class="btn btn-primary" id="exportPdfBtn">
                            <i class="fas fa-file-pdf"></i> Exportar para PDF
                        </button>
                    </div>
                </div>

                <!-- Dashboard Tab -->
                <div id="dashboardTab" class="tab-content">
                    <h2 style="margin-bottom: 25px; color: #333;"><i class="fas fa-tachometer-alt"></i> Dashboard - Resumo Geral</h2>
                    <div class="dashboard-grid" id="dashboardStats"></div>
                    <div class="report-table-container">
                        <h3 style="padding: 20px; margin: 0; border-bottom: 2px solid #eee;">Registos Recentes</h3>
                        <div id="recentEntries"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Products configuration
        const PRODUCTS = [
            { id: 'filetes', name: 'Filetes', unitsPerBag: 10, inputType: 'bags', inputLabel: 'Sacos' },
            { id: 'minis', name: 'Minis/Tenders', unitsPerBag: 20, inputType: 'bags', inputLabel: 'Sacos' },
            { id: 'zingers', name: 'Zingers', unitsPerBag: 10, inputType: 'bags', inputLabel: 'Sacos' },
            { id: 'pedacos', name: 'Peda√ßos', inputType: 'manual', inputLabel: 'Total Pe√ßas' },
            { id: 'asas', name: 'Asas', unitsPerBag: 60, bagsPerBox: 3, inputType: 'boxes', inputLabel: 'Caixas', configText: '1 caixa = 3 sacos de 60 unid' },
            { id: 'filetes_value', name: 'Filetes Value', unitsPerBag: 24, bagsPerBox: 3, inputType: 'boxes', inputLabel: 'Caixas', configText: '1 caixa = 3 sacos de 24 unid' }
        ];

        // Application state
        let currentUser = '';
        let selectedShift = '';
        let currentData = {};
        let allRecords = [];
        let currentReportData = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Application starting...');
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            
            // Load existing records from localStorage
            loadRecordsFromStorage();
            
            // Setup event listeners
            setupEventListeners();
            
            // Force show login screen on startup
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            console.log('App initialized successfully');
        });

        // Load records from localStorage
        function loadRecordsFromStorage() {
            try {
                const savedRecords = localStorage.getItem('kfc_production_records');
                if (savedRecords) {
                    allRecords = JSON.parse(savedRecords);
                    console.log(`Loaded ${allRecords.length} records from storage`);
                } else {
                    allRecords = [];
                    console.log('No records found in storage, starting fresh');
                }
            } catch (error) {
                console.error('Error loading records from storage:', error);
                allRecords = [];
            }
        }

        // Save records to localStorage
        function saveRecordsToStorage() {
            try {
                localStorage.setItem('kfc_production_records', JSON.stringify(allRecords));
                console.log(`Saved ${allRecords.length} records to storage`);
            } catch (error) {
                console.error('Error saving records to storage:', error);
            }
        }

        // Setup all event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Login form
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Login form submitted');
                handleLogin();
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                console.log('Logout clicked');
                handleLogout();
            });
            
            // Shift cards
            document.querySelectorAll('.shift-card').forEach(card => {
                card.addEventListener('click', function() {
                    console.log('Shift card clicked:', this.dataset.shift);
                    handleShiftSelect(this);
                });
            });
            
            // Save button
            document.getElementById('saveBtn').addEventListener('click', function() {
                console.log('Save button clicked');
                handleSaveRecord();
            });
            
            // Cancel button
            document.getElementById('cancelBtn').addEventListener('click', function() {
                console.log('Cancel button clicked');
                handleCancel();
            });
            
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    console.log('Tab clicked:', this.dataset.tab);
                    handleTabSwitch(this);
                });
            });
            
            // Report generation
            document.getElementById('generateReportBtn').addEventListener('click', function() {
                console.log('Generate report clicked');
                handleGenerateReport();
            });
            
            // PDF export
            document.getElementById('exportPdfBtn').addEventListener('click', function() {
                console.log('Export PDF clicked');
                handleExportPDF();
            });
            
            // Report type change
            document.getElementById('reportType').addEventListener('change', function(e) {
                console.log('Report type changed:', e.target.value);
                handleReportTypeChange(e);
            });
            
            console.log('All event listeners set up');
        }

        // Handle login
        function handleLogin() {
            const usernameInput = document.getElementById('username');
            const username = usernameInput.value.trim();
            
            console.log('Login attempt for user:', username);
            
            if (!username) {
                showToast('Por favor, insira um nome de utilizador', true);
                return;
            }
            
            currentUser = username;
            console.log('Current user set to:', currentUser);
            
            // Update UI
            document.getElementById('currentUser').textContent = currentUser;
            
            // Show main app
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            
            console.log('Login successful, showing main app');
            showToast(`Bem-vindo, ${currentUser}!`);
            
            // Clear login form
            usernameInput.value = '';
            
            // Ensure register tab is active
            showTab('register');
        }

        // Handle logout
        function handleLogout() {
            console.log('Logging out user:', currentUser);
            
            // Reset state
            currentUser = '';
            selectedShift = '';
            currentData = {};
            
            // Update UI
            document.getElementById('currentUser').textContent = 'Utilizador';
            
            // Show login screen
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            // Hide registration form
            document.getElementById('registrationForm').style.display = 'none';
            document.querySelectorAll('.shift-card').forEach(c => c.classList.remove('selected'));
            
            // Reset to register tab
            showTab('register');
            
            console.log('Logout successful');
            showToast('Sess√£o terminada com sucesso!');
        }

        // Show a specific tab
        function showTab(tabName) {
            console.log('Showing tab:', tabName);
            
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });
            
            // Show tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const tabContent = document.getElementById(tabName + 'Tab');
            if (tabContent) {
                tabContent.classList.add('active');
                
                if (tabName === 'dashboard') {
                    renderDashboard();
                } else if (tabName === 'reports') {
                    // Reset report actions
                    document.getElementById('reportActions').style.display = 'none';
                }
            }
        }

        // Handle shift selection
        function handleShiftSelect(card) {
            selectedShift = card.dataset.shift;
            console.log('Selected shift:', selectedShift);
            
            // Update UI
            document.querySelectorAll('.shift-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            
            document.getElementById('selectedShift').textContent = selectedShift;
            document.getElementById('registrationForm').style.display = 'block';
            
            // Initialize products table
            initializeProductsTable();
        }

        // Initialize products table
        function initializeProductsTable() {
            console.log('Initializing products table for shift:', selectedShift);
            
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';
            
            currentData = {};
            
            PRODUCTS.forEach(product => {
                currentData[product.id] = {
                    input: 0,
                    adjust: 0,
                    total: 0,
                    numericTotal: 0
                };
                
                const row = document.createElement('tr');
                
                if (product.inputType === 'manual') {
                    row.innerHTML = `
                        <td><strong>${product.name}</strong></td>
                        <td style="font-size: 0.9rem; color: #666;">Inserir total de pe√ßas manualmente</td>
                        <td colspan="2">
                            <div class="input-group">
                                <input type="text" 
                                       id="${product.id}_manual" 
                                       value="" 
                                       data-product="${product.id}"
                                       placeholder="Ex: 8sacos + 1/2, 150, 20/30, etc."
                                       style="width: 100%; max-width: 300px;">
                            </div>
                        </td>
                        <td class="total-display" id="${product.id}_total">-</td>
                    `;
                } else {
                    const configText = product.configText || `1 saco = ${product.unitsPerBag} unidades`;
                    const fieldName = product.inputType === 'boxes' ? product.id + '_boxes' : product.id + '_bags';
                    
                    row.innerHTML = `
                        <td><strong>${product.name}</strong></td>
                        <td style="font-size: 0.9rem; color: #666;">${configText}</td>
                        <td>
                            <div class="input-group">
                                <input type="number" 
                                       id="${fieldName}" 
                                       min="0" 
                                       value="0" 
                                       data-product="${product.id}"
                                       placeholder="${product.inputLabel}">
                            </div>
                        </td>
                        <td>
                            <div class="input-group">
                                <button class="adjust-btn minus" data-product="${product.id}" data-action="minus">‚àí</button>
                                <input type="number" 
                                       id="${product.id}_adjust" 
                                       value="0" 
                                       data-product="${product.id}"
                                       readonly>
                                <button class="adjust-btn plus" data-product="${product.id}" data-action="plus">+</button>
                            </div>
                        </td>
                        <td class="total-display" id="${product.id}_total">0</td>
                    `;
                }
                
                tbody.appendChild(row);
            });
            
            // Add event listeners for inputs
            setTimeout(() => {
                // Number inputs
                document.querySelectorAll('input[type="number"]:not([readonly])').forEach(input => {
                    input.addEventListener('input', function(e) {
                        console.log('Number input changed:', e.target.id);
                        handleInputChange(e);
                    });
                });
                
                // Text inputs
                document.querySelectorAll('input[type="text"]').forEach(input => {
                    input.addEventListener('input', function(e) {
                        console.log('Text input changed:', e.target.id);
                        handleInputChange(e);
                    });
                });
                
                // Adjust buttons
                document.querySelectorAll('.adjust-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        console.log('Adjust button clicked:', e.target.dataset);
                        handleAdjustClick(e);
                    });
                });
            }, 100);
        }

        // Handle input changes
        function handleInputChange(e) {
            const productId = e.target.dataset.product;
            const product = PRODUCTS.find(p => p.id === productId);
            
            if (!product) {
                console.error('Product not found:', productId);
                return;
            }
            
            if (product.inputType === 'manual') {
                const textValue = e.target.value.trim();
                const numericValue = extractNumericValue(textValue);
                
                currentData[productId] = { 
                    input: textValue, 
                    adjust: 0, 
                    total: textValue,
                    numericTotal: numericValue 
                };
                
                document.getElementById(`${productId}_total`).textContent = textValue || '-';
            } else {
                const fieldName = product.inputType === 'boxes' ? productId + '_boxes' : productId + '_bags';
                const inputElement = document.getElementById(fieldName);
                const adjustElement = document.getElementById(`${productId}_adjust`);
                
                if (!inputElement || !adjustElement) {
                    console.error('Input elements not found for product:', productId);
                    return;
                }
                
                const inputValue = parseInt(inputElement.value) || 0;
                const adjust = parseInt(adjustElement.value) || 0;
                
                let total = 0;
                if (product.inputType === 'boxes') {
                    total = (inputValue * product.bagsPerBox * product.unitsPerBag) + adjust;
                } else {
                    total = (inputValue * product.unitsPerBag) + adjust;
                }
                
                currentData[productId] = { input: inputValue, adjust, total };
                document.getElementById(`${productId}_total`).textContent = total;
            }
            
            updateShiftTotal();
        }

        // Extract numeric value from text input
        function extractNumericValue(text) {
            if (!text || text.trim() === '') return 0;
            
            try {
                // Try to parse as number first
                const simpleNumber = parseFloat(text.replace(',', '.'));
                if (!isNaN(simpleNumber)) return simpleNumber;
                
                // Common patterns
                const patterns = [
                    /(\d+)\s*sacos?\s*\+\s*(\d+)\s*\/\s*(\d+)/i,
                    /(\d+)\s*sacos?\s*\+\s*(\d+)/i,
                    /(\d+)\s*sacos?/i,
                    /(\d+)\s*\/\s*(\d+)/,
                    /(\d+)/
                ];
                
                for (const pattern of patterns) {
                    const match = text.match(pattern);
                    if (match) {
                        if (match[1] && match[2] && match[3]) {
                            return parseInt(match[1]) + (parseInt(match[2]) / parseInt(match[3]));
                        } else if (match[1] && match[2]) {
                            return parseInt(match[1]) + parseInt(match[2]);
                        } else if (match[1]) {
                            return parseInt(match[1]);
                        }
                    }
                }
                
                return 0;
            } catch (error) {
                console.error('Error extracting numeric value:', error);
                return 0;
            }
        }

        // Handle adjust button clicks
        function handleAdjustClick(e) {
            const productId = e.target.dataset.product;
            const action = e.target.dataset.action;
            
            const adjustInput = document.getElementById(`${productId}_adjust`);
            if (!adjustInput) {
                console.error('Adjust input not found for product:', productId);
                return;
            }
            
            let currentAdjust = parseInt(adjustInput.value) || 0;
            
            if (action === 'plus') {
                currentAdjust++;
            } else if (action === 'minus') {
                currentAdjust--;
            }
            
            adjustInput.value = currentAdjust;
            
            // Trigger input change
            const event = new Event('input');
            adjustInput.dispatchEvent(event);
        }

        // Update shift total
        function updateShiftTotal() {
            let total = 0;
            
            Object.keys(currentData).forEach(productId => {
                const product = PRODUCTS.find(p => p.id === productId);
                const item = currentData[productId];
                
                if (product.inputType === 'manual') {
                    total += item.numericTotal || 0;
                } else {
                    total += item.total || 0;
                }
            });
            
            document.getElementById('shiftTotal').textContent = total;
        }

        // Handle save record
        async function handleSaveRecord() {
            console.log('Saving record...');
            
            if (!selectedShift) {
                showToast('Por favor, selecione um turno primeiro.', true);
                return;
            }

            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> A guardar...';
            
            try {
                const record = {
                    id: `${Date.now()}_${selectedShift}_${Math.random().toString(36).substr(2, 9)}`,
                    date: new Date().toLocaleDateString('pt-PT'),
                    shift: selectedShift,
                    username: currentUser,
                    created_at: new Date().toISOString(),
                    total_shift: 0
                };
                
                let totalShift = 0;
                
                PRODUCTS.forEach(product => {
                    const data = currentData[product.id];
                    
                    if (!data) {
                        console.warn('No data for product:', product.id);
                        return;
                    }
                    
                    if (product.inputType === 'manual') {
                        record[`${product.id}_manual`] = data.input || '';
                        record[`${product.id}_adjust`] = 0;
                        record[`${product.id}_total`] = data.input || '0';
                        totalShift += data.numericTotal || 0;
                    } else {
                        if (product.inputType === 'boxes') {
                            record[`${product.id}_boxes`] = data.input || 0;
                        } else {
                            record[`${product.id}_bags`] = data.input || 0;
                        }
                        
                        record[`${product.id}_adjust`] = data.adjust || 0;
                        record[`${product.id}_total`] = data.total || 0;
                        totalShift += data.total || 0;
                    }
                });
                
                record.total_shift = totalShift;
                
                console.log('Record to save:', record);
                
                // Add to records
                allRecords.unshift(record);
                saveRecordsToStorage();
                
                showToast('Registo guardado com sucesso!');
                
                // Reset form
                document.getElementById('registrationForm').style.display = 'none';
                document.querySelectorAll('.shift-card').forEach(c => c.classList.remove('selected'));
                selectedShift = '';
                currentData = {};
                
            } catch (error) {
                console.error('Error saving record:', error);
                showToast('Erro ao guardar registo: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Guardar Registo';
            }
        }

        // Handle cancel
        function handleCancel() {
            document.getElementById('registrationForm').style.display = 'none';
            document.querySelectorAll('.shift-card').forEach(c => c.classList.remove('selected'));
            selectedShift = '';
            currentData = {};
        }

        // Handle tab switching
        function handleTabSwitch(tab) {
            const tabName = tab.dataset.tab;
            showTab(tabName);
        }

        // Render dashboard
        function renderDashboard() {
            console.log('Rendering dashboard...');
            
            const statsContainer = document.getElementById('dashboardStats');
            const recentContainer = document.getElementById('recentEntries');
            
            if (!allRecords || allRecords.length === 0) {
                statsContainer.innerHTML = '<div class="empty-state"><h3>Sem dados dispon√≠veis</h3><p>Fa√ßa o primeiro registo para ver estat√≠sticas</p></div>';
                recentContainer.innerHTML = '<div class="empty-state" style="padding: 40px;"><p>Nenhum registo encontrado</p></div>';
                return;
            }
            
            const totalProduction = allRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
            const tardeTotal = allRecords.filter(r => r.shift === 'Tarde').reduce((sum, r) => sum + (r.total_shift || 0), 0);
            const noiteTotal = allRecords.filter(r => r.shift === 'Noite').reduce((sum, r) => sum + (r.total_shift || 0), 0);
            
            statsContainer.innerHTML = `
                <div class="summary-card">
                    <h3>Total Produ√ß√£o</h3>
                    <div class="value">${totalProduction}</div>
                </div>
                <div class="summary-card">
                    <h3>‚òÄÔ∏è Turno Tarde</h3>
                    <div class="value">${tardeTotal}</div>
                </div>
                <div class="summary-card">
                    <h3>üåô Turno Noite</h3>
                    <div class="value">${noiteTotal}</div>
                </div>
                <div class="summary-card">
                    <h3>Total Registos</h3>
                    <div class="value">${allRecords.length}</div>
                </div>
            `;
            
            const recentRecords = allRecords.slice(0, 10);
            
            let recentHTML = '';
            if (recentRecords.length > 0) {
                recentHTML = '<table class="report-table"><thead><tr><th>Data</th><th>Turno</th><th>Utilizador</th><th>Total Pe√ßas</th></tr></thead><tbody>';
                
                recentRecords.forEach(record => {
                    const shiftClass = (record.shift || '').toLowerCase();
                    recentHTML += `
                        <tr>
                            <td>${record.date || 'N/A'}</td>
                            <td><span class="shift-badge ${shiftClass}">${record.shift || 'N/A'}</span></td>
                            <td>${record.username || 'N/A'}</td>
                            <td><strong>${record.total_shift || 0}</strong></td>
                        </tr>`;
                });
                
                recentHTML += '</tbody></table>';
            } else {
                recentHTML = '<div class="empty-state" style="padding: 40px;"><p>Nenhum registo recente</p></div>';
            }
            
            recentContainer.innerHTML = recentHTML;
        }

        // Handle generate report
        function handleGenerateReport() {
            const reportType = document.getElementById('reportType').value;
            const shiftFilter = document.getElementById('shiftFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            console.log('Generating report:', { reportType, shiftFilter, startDate, endDate });
            
            if (!startDate || !endDate) {
                showToast('Por favor, selecione as datas', true);
                return;
            }
            
            generateReport(reportType, shiftFilter, startDate, endDate);
        }

        // Generate report
        function generateReport(reportType, shiftFilter, startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            
            let filteredRecords = allRecords.filter(record => {
                const recordDate = parsePortugueseDate(record.date);
                const dateMatch = recordDate >= start && recordDate <= end;
                const shiftMatch = shiftFilter === 'all' || record.shift === shiftFilter;
                return dateMatch && shiftMatch;
            });
            
            if (filteredRecords.length === 0) {
                document.getElementById('reportResults').innerHTML = `
                    <div class="empty-state">
                        <h3>Sem dados no per√≠odo selecionado</h3>
                        <p>Tente outro intervalo de datas ou filtro de turno</p>
                    </div>
                `;
                document.getElementById('reportActions').style.display = 'none';
                return;
            }
            
            currentReportData = { reportType, shiftFilter, startDate, endDate, filteredRecords };
            
            let reportHtml = '';
            
            if (reportType === 'shift') {
                reportHtml = generateShiftReport(filteredRecords, shiftFilter);
            } else {
                reportHtml = generateStandardReport(filteredRecords);
            }
            
            document.getElementById('reportResults').innerHTML = reportHtml;
            document.getElementById('reportActions').style.display = 'flex';
        }

        // Generate shift report
        function generateShiftReport(records, shiftFilter) {
            const shifts = shiftFilter === 'all' ? ['Tarde', 'Noite'] : [shiftFilter];
            
            let html = '<div class="report-section">';
            
            shifts.forEach(shift => {
                const shiftRecords = records.filter(r => r.shift === shift);
                
                if (shiftRecords.length === 0) {
                    html += `<h3>Turno: ${shift} (0 registos)</h3>`;
                    html += `<div class="empty-state" style="padding: 20px;"><p>Sem registos para este turno</p></div>`;
                    return;
                }
                
                html += `
                    <h3>Turno: ${shift} (${shiftRecords.length} registos)</h3>
                    <div class="report-table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Utilizador</th>`;
                
                PRODUCTS.forEach(product => {
                    html += `<th>${product.name}</th>`;
                });
                
                html += `<th>Total Turno</th></tr></thead><tbody>`;
                
                shiftRecords.forEach(record => {
                    html += `<tr><td>${record.date || 'N/A'}</td><td>${record.username || 'N/A'}</td>`;
                    
                    PRODUCTS.forEach(product => {
                        const totalValue = record[`${product.id}_total`];
                        html += `<td>${totalValue !== undefined && totalValue !== null ? totalValue : '-'}</td>`;
                    });
                    
                    html += `<td><strong>${record.total_shift || 0}</strong></td></tr>`;
                });
                
                html += `<tr class="totals-row"><td colspan="2"><strong>TOTAL ${shift.toUpperCase()}</strong></td>`;
                
                PRODUCTS.forEach(product => {
                    const productTotal = shiftRecords.reduce((sum, r) => {
                        const val = r[`${product.id}_total`];
                        return sum + (typeof val === 'number' ? val : 0);
                    }, 0);
                    html += `<td><strong>${productTotal}</strong></td>`;
                });
                
                const shiftTotal = shiftRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
                html += `<td><strong>${shiftTotal}</strong></td></tr>`;
                
                html += '</tbody></table></div>';
            });
            
            html += '</div>';
            
            return html;
        }

        // Generate standard report
        function generateStandardReport(records) {
            let html = '<div class="report-table-container"><table class="report-table"><thead><tr>';
            html += '<th>Data</th><th>Turno</th><th>Utilizador</th>';
            
            PRODUCTS.forEach(product => {
                html += `<th>${product.name}</th>`;
            });
            
            html += '<th>Total</th></tr></thead><tbody>';
            
            records.forEach(record => {
                html += `<tr><td>${record.date || 'N/A'}</td>`;
                html += `<td><span class="shift-badge ${(record.shift || '').toLowerCase()}">${record.shift || 'N/A'}</span></td>`;
                html += `<td>${record.username || 'N/A'}</td>`;
                
                PRODUCTS.forEach(product => {
                    const totalValue = record[`${product.id}_total`];
                    html += `<td>${totalValue !== undefined && totalValue !== null ? totalValue : '-'}</td>`;
                });
                
                html += `<td><strong>${record.total_shift || 0}</strong></td></tr>`;
            });
            
            html += `<tr class="totals-row"><td colspan="3"><strong>TOTAL GERAL</strong></td>`;
            
            PRODUCTS.forEach(product => {
                const productTotal = records.reduce((sum, r) => {
                    const val = r[`${product.id}_total`];
                    return sum + (typeof val === 'number' ? val : 0);
                }, 0);
                html += `<td><strong>${productTotal}</strong></td>`;
            });
            
            const grandTotal = records.reduce((sum, r) => sum + (r.total_shift || 0), 0);
            html += `<td><strong>${grandTotal}</strong></td></tr>`;
            
            html += '</tbody></table></div>';
            
            return html;
        }

        // Parse Portuguese date format
        function parsePortugueseDate(dateStr) {
            try {
                if (!dateStr) return new Date();
                
                if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        return new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                }
                
                const date = new Date(dateStr);
                return !isNaN(date.getTime()) ? date : new Date();
            } catch (error) {
                return new Date();
            }
        }

        // Handle export PDF
        async function handleExportPDF() {
            const btn = document.getElementById('exportPdfBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> A gerar PDF...';
            
            try {
                await exportToPDF();
                showToast('PDF gerado com sucesso!');
            } catch (error) {
                console.error('Error generating PDF:', error);
                showToast('Erro ao gerar PDF: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-file-pdf"></i> Exportar para PDF';
            }
        }

        // Export to PDF
        function exportToPDF() {
            return new Promise((resolve, reject) => {
                try {
                    if (!currentReportData) {
                        reject(new Error('Nenhum relat√≥rio para exportar'));
                        return;
                    }
                    
                    // Create a detailed PDF with product breakdown
                    createDetailedPDF();
                    resolve();
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Create a detailed PDF with product breakdown
        function createDetailedPDF() {
            const { reportType, shiftFilter, startDate, endDate, filteredRecords } = currentReportData;
            
            // Create a detailed text representation of the report
            let reportText = `KFC Kitchen Count Manager - Relat√≥rio Detalhado\n`;
            reportText += `================================================\n\n`;
            reportText += `Tipo de Relat√≥rio: ${getReportTypeName(reportType)}\n`;
            if (reportType === 'shift' && shiftFilter !== 'all') {
                reportText += `Turno: ${shiftFilter}\n`;
            }
            reportText += `Per√≠odo: ${startDate} a ${endDate}\n`;
            reportText += `Gerado em: ${new Date().toLocaleString('pt-PT')}\n`;
            reportText += `Por: ${currentUser}\n`;
            reportText += `Total de registos: ${filteredRecords.length}\n\n`;
            reportText += `================================================\n\n`;
            
            // Group records by date
            const recordsByDate = {};
            filteredRecords.forEach(record => {
                if (!recordsByDate[record.date]) {
                    recordsByDate[record.date] = [];
                }
                recordsByDate[record.date].push(record);
            });
            
            // Process each date
            Object.keys(recordsByDate).sort().forEach(date => {
                const dateRecords = recordsByDate[date];
                
                reportText += `\nüìÖ DATA: ${date}\n`;
                reportText += `‚îÄ`.repeat(50) + '\n\n';
                
                // Group by shift
                const recordsByShift = {};
                dateRecords.forEach(record => {
                    if (!recordsByShift[record.shift]) {
                        recordsByShift[record.shift] = [];
                    }
                    recordsByShift[record.shift].push(record);
                });
                
                Object.keys(recordsByShift).forEach(shift => {
                    const shiftRecords = recordsByShift[shift];
                    
                    reportText += `  Turno: ${shift}\n`;
                    reportText += `  `.padEnd(50, '‚îÄ') + '\n';
                    
                    shiftRecords.forEach((record, index) => {
                        reportText += `  ${index + 1}. ${record.username}\n`;
                        
                        // Show details for each product
                        PRODUCTS.forEach(product => {
                            const totalValue = record[`${product.id}_total`];
                            if (totalValue !== undefined && totalValue !== null && totalValue !== '' && totalValue !== 0) {
                                reportText += `     ${product.name}: ${totalValue} ${product.inputType === 'manual' ? 'pe√ßas' : 'unid'}\n`;
                            }
                        });
                        
                        reportText += `     TOTAL: ${record.total_shift || 0} pe√ßas\n\n`;
                    });
                    
                    // Calculate shift totals for the date
                    const shiftTotal = shiftRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
                    
                    // Calculate product totals for this shift on this date
                    reportText += `  RESUMO DO TURNO ${shift.toUpperCase()}:\n`;
                    PRODUCTS.forEach(product => {
                        const productTotal = shiftRecords.reduce((sum, r) => {
                            const val = r[`${product.id}_total`];
                            if (typeof val === 'number') return sum + val;
                            if (typeof val === 'string' && val.trim() !== '') {
                                const num = extractNumericValue(val);
                                return sum + num;
                            }
                            return sum;
                        }, 0);
                        
                        if (productTotal > 0) {
                            reportText += `     ${product.name}: ${productTotal} ${product.inputType === 'manual' ? 'pe√ßas' : 'unid'}\n`;
                        }
                    });
                    reportText += `     TOTAL DO TURNO: ${shiftTotal} pe√ßas\n\n`;
                });
                
                // Calculate date totals
                const dateTotal = dateRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
                reportText += `  TOTAL DO DIA ${date}: ${dateTotal} pe√ßas\n`;
                reportText += `\n${'‚ïê'.repeat(50)}\n`;
            });
            
            // Calculate grand totals
            reportText += `\nüìä RESUMO GERAL DO PER√çODO:\n`;
            reportText += `‚îÄ`.repeat(50) + '\n\n';
            
            // Product totals for entire period
            PRODUCTS.forEach(product => {
                const productTotal = filteredRecords.reduce((sum, r) => {
                    const val = r[`${product.id}_total`];
                    if (typeof val === 'number') return sum + val;
                    if (typeof val === 'string' && val.trim() !== '') {
                        const num = extractNumericValue(val);
                        return sum + num;
                    }
                    return sum;
                }, 0);
                
                if (productTotal > 0) {
                    reportText += `  ${product.name}: ${productTotal} ${product.inputType === 'manual' ? 'pe√ßas' : 'unid'}\n`;
                }
            });
            
            // Shift totals for entire period
            const shifts = ['Tarde', 'Noite'];
            shifts.forEach(shift => {
                const shiftRecords = filteredRecords.filter(r => r.shift === shift);
                if (shiftRecords.length > 0) {
                    const shiftTotal = shiftRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
                    reportText += `  Turno ${shift}: ${shiftTotal} pe√ßas (${shiftRecords.length} registos)\n`;
                }
            });
            
            const grandTotal = filteredRecords.reduce((sum, r) => sum + (r.total_shift || 0), 0);
            reportText += `\n  TOTAL GERAL: ${grandTotal} pe√ßas\n`;
            reportText += `  M√âDIA POR REGISTO: ${(grandTotal / filteredRecords.length).toFixed(2)} pe√ßas\n`;
            
            reportText += `\n${'‚ïê'.repeat(50)}\n`;
            reportText += `Fim do Relat√≥rio\n`;
            
            // Create a Blob with the text
            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            // Create a download link
            const a = document.createElement('a');
            a.href = url;
            a.download = `KFC_Relatorio_Detalhado_${reportType}_${startDate}_a_${endDate}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Clean up
            URL.revokeObjectURL(url);
        }

        // Get report type name
        function getReportTypeName(type) {
            const types = {
                'daily': 'Di√°rio',
                'shift': 'Por Turno',
                'weekly': 'Semanal',
                'monthly': 'Mensal'
            };
            return types[type] || type;
        }

        // Handle report type change
        function handleReportTypeChange(e) {
            const shiftFilterGroup = document.getElementById('shiftFilterGroup');
            if (e.target.value === 'shift') {
                shiftFilterGroup.style.display = 'block';
            } else {
                shiftFilterGroup.style.display = 'none';
            }
        }

        // Show toast notification
        function showToast(message, isError = false) {
            console.log('Showing toast:', message, isError);
            
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'error' : ''}`;
            toast.innerHTML = `
                <i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        // Test function to check if app is working
        window.testApp = function() {
            console.log('=== APP STATUS ===');
            console.log('Current user:', currentUser);
            console.log('Selected shift:', selectedShift);
            console.log('Total records:', allRecords.length);
            console.log('Login screen display:', document.getElementById('loginScreen').style.display);
            console.log('Main app display:', document.getElementById('mainApp').style.display);
            console.log('Active tab:', document.querySelector('.nav-tab.active')?.dataset.tab);
            console.log('=== END STATUS ===');
        };
    </script>
</body>
</html>
